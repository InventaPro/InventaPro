<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>seb365 pro</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.autotable.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root {
      --bg-primary: #ffffff; --bg-secondary: #f8f9fa; --bg-tertiary: #f1f3f4;
      --border-color: #e0e0e0; --text-primary: #202124; --text-secondary: #5f6368;
      --brand-primary: #ff6f00; --brand-secondary: #f57c00; --accent-red: #d93025;
      --accent-green: #1e8e3e; --shadow-color: rgba(0, 0, 0, 0.08);
      --dark-bg-primary: #202124; --dark-bg-secondary: #303134; --dark-bg-tertiary: #3c4043;
      --dark-border-color: #424548; --dark-text-primary: #e8eaed; --dark-text-secondary: #9aa0a6;
      --dark-brand-primary: #ff8f00; --dark-brand-secondary: #ffa000; --dark-accent-red: #f28b82;
      --dark-accent-green: #81c995; --dark-shadow-color: rgba(0, 0, 0, 0.3);
      --grad-yellow: #ffc107; --grad-orange: #ff6f00; --grad-red: #ff3d00;
    }
    body[data-theme="dark"] {
      --bg-primary: var(--dark-bg-primary); --bg-secondary: var(--dark-bg-secondary);
      --bg-tertiary: var(--dark-bg-tertiary); --border-color: var(--dark-border-color);
      --text-primary: var(--dark-text-primary); --text-secondary: var(--dark-text-secondary);
      --brand-primary: var(--dark-brand-primary); --brand-secondary: var(--dark-brand-secondary);
      --accent-red: var(--dark-accent-red); --accent-green: var(--dark-accent-green);
      --shadow-color: var(--dark-shadow-color);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; overflow-x: hidden; }
    body {
      margin: 0; font-family: 'Roboto', sans-serif; background-color: var(--bg-primary);
      color: var(--text-primary); transition: background-color 0.2s, color 0.2s;
    }
    main { display: flex; min-height: calc(100vh - 60px); }
    #content { flex: 1; padding: 24px; padding-bottom: 80px; }
    .hidden { display: none !important; }

    /* --- Header y Logo --- */
    header {
      display: flex; align-items: center; justify-content: space-between; padding: 0 24px;
      height: 60px; border-bottom: 1px solid var(--border-color); background-color: var(--bg-secondary);
      position: sticky; top: 0; z-index: 100;
    }
    .header-logo {
      margin: 0; font-size: 22px; font-weight: 700;
      display: flex; align-items: center; gap: 10px; text-decoration: none;
    }
    .header-logo-icon { width: 28px; height: 28px; }
    .header-logo-text {
      background: linear-gradient(90deg, var(--grad-yellow), var(--grad-orange), var(--grad-red));
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    .header-logo-pro { font-weight: 900; }
    body[data-theme="dark"] .header-logo-text { background: none; -webkit-background-clip: initial; background-clip: initial; }
    body[data-theme="dark"] .header-logo-seb { color: var(--dark-text-primary); }
    body[data-theme="dark"] .header-logo-pro {
      background: linear-gradient(90deg, var(--grad-yellow), var(--grad-orange), var(--grad-red));
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }

    .user-info { display: flex; align-items: center; gap: 12px; font-size: 14px; }
    #main-nav {
      width: 250px; padding: 16px 8px; border-right: 1px solid var(--border-color);
      background: var(--bg-secondary); transition: left 0.3s ease-in-out;
      height: 100vh; position: sticky; top: 0;
    }
    #main-nav .nav-link {
      display: flex; gap: 16px; align-items: center; color: var(--text-secondary); padding: 10px 16px;
      border-radius: 8px; text-decoration: none; margin-bottom: 4px; font-weight: 500;
      transition: background-color 0.2s, color 0.2s;
    }
    #main-nav .nav-link:hover { background-color: var(--bg-tertiary); color: var(--text-primary); }
    #main-nav .nav-link.active {
      background-color: rgba(255, 111, 0, 0.1); color: var(--brand-primary); font-weight: 700;
    }
    .nav-link svg { width: 20px; height: 20px; }
    .card {
      background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px;
      padding: 20px; box-shadow: 0 2px 4px var(--shadow-color);
    }
    .content-view h2, .card h2 { margin: 0 0 24px 0; font-size: 24px; font-weight: 500; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; }
    input, select, button { font: inherit; outline-color: var(--brand-primary); }
    input, select {
      width: 100%; padding: 12px 14px; border-radius: 8px; border: 1px solid var(--border-color);
      background-color: var(--bg-primary); color: var(--text-primary); transition: border-color 0.2s;
    }
    .password-wrapper { position: relative; }
    .password-wrapper input { padding-right: 44px; }
    .password-toggle-btn {
      position: absolute; right: 4px; top: 50%; transform: translateY(-50%);
      background: none; border: none; cursor: pointer; padding: 8px; color: var(--text-secondary);
      display: flex; align-items: center; justify-content: center;
    }
    .password-toggle-btn:hover { color: var(--text-primary); }
    .password-toggle-btn svg { width: 20px; height: 20px; }
    input:focus, select:focus { border-color: var(--brand-primary); }
    button {
      background: linear-gradient(45deg, var(--grad-red), var(--grad-orange), var(--grad-yellow)); background-size: 200% auto;
      border: none; color: #fff; padding: 12px 18px; border-radius: 8px; cursor: pointer;
      font-weight: 500; transition: background-position 0.4s ease, background-color 0.3s ease;
    }
    button:hover { background-position: right center; }
    button[disabled] { opacity: .6; cursor: not-allowed; background-position: left center !important; }
    .button-secondary {
      background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color);
    }
    .button-secondary:hover { background: var(--border-color); }
    .button-secondary.active {
        background: var(--brand-primary);
        color: white;
        border-color: var(--brand-primary);
    }
    label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 14px; text-align: left; }
    .table-wrapper { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; border-spacing: 0; }
    thead th {
      font-weight: 500; color: var(--text-secondary); text-align: left; padding: 12px 16px;
      background-color: var(--bg-tertiary); border-bottom: 1px solid var(--border-color);
    }
    tbody td { background: var(--bg-secondary); padding: 12px 16px; border-bottom: 1px solid var(--border-color); }
    tbody tr:last-child td { border-bottom: none; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .actions button { padding: 6px 10px; font-size: 14px; }
    #toast-container { position: fixed; right: 24px; bottom: 24px; display: flex; flex-direction: column; gap: 10px; z-index: 9999; }
    .toast {
      padding: 14px 18px; border-radius: 8px; background-color: var(--bg-tertiary); border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px var(--shadow-color); color: var(--text-primary);
    }
    .toast.success { border-left: 4px solid var(--accent-green); }
    .toast.error { border-left: 4px solid var(--accent-red); }
    .amount-positive { color: var(--accent-green); } .amount-negative { color: var(--accent-red); }

    /* --- Autenticación Rediseñada --- */
    #auth-container {
        display: flex; align-items: center; justify-content: center; padding: 24px;
        min-height: 100vh;
        background-color: var(--bg-secondary);
    }
    .auth-box {
        max-width: 450px; width: 100%; text-align: center;
        background: var(--bg-primary); padding: 32px; border-radius: 16px;
        box-shadow: 0 8px 32px var(--shadow-color);
    }
    .auth-box h2 { font-size: 28px; font-weight: 700; margin: 16px 0 8px 0; }
    .auth-box p { color: var(--text-secondary); margin-bottom: 32px; }
    .auth-form-fields { display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px; }
    .auth-box button[type="submit"] { width: 100%; padding: 14px; font-size: 16px; }
    .auth-box .button-secondary { width: 100%; }
    .divider { display: flex; align-items: center; text-align: center; color: var(--text-secondary); font-size: 12px; margin: 24px 0; }
    .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid var(--border-color); }
    .divider:not(:empty)::before { margin-right: .5em; }
    .divider:not(:empty)::after { margin-left: .5em; }
    .auth-switch-link { color: var(--brand-primary); text-decoration: none; font-weight: 500; }
    .auth-switch-link:hover { text-decoration: underline; }
    .register-fields-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

    .modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
        display: flex; align-items: center; justify-content: center; z-index: 1000;
        opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
    }
    .modal.visible { opacity: 1; pointer-events: all; }
    .modal-content {
        background: var(--bg-primary); padding: 32px; border-radius: 12px;
        width: 90%; max-width: 800px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        transform: scale(0.95); transition: transform 0.3s ease;
    }
    .modal.visible .modal-content { transform: scale(1); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .modal-header h3 { margin: 0; font-size: 22px; }
    .modal-close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary); line-height: 1; }
    .modal-form-body { display: flex; flex-direction: column; gap: 20px; }
    #fichas-grid {
        display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 16px; margin-bottom: 24px;
    }
    .ficha-card {
        background-color: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 12px;
        padding: 16px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
    }
    .ficha-card:hover { transform: translateY(-4px); box-shadow: 0 4px 12px var(--shadow-color); }
    .ficha-card h4 { margin: 0 0 8px 0; font-size: 16px; color: var(--text-primary); text-transform: uppercase; }
    .ficha-card-stock { font-size: 20px; font-weight: 700; color: var(--brand-primary); }
    .ficha-card-stock span { font-size: 12px; font-weight: 400; color: var(--text-secondary); }
    .active-shifts-list { display: flex; flex-direction: column; gap: 12px; }
    .active-shift-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color);
    }
    .active-shift-item-info { display: flex; flex-direction: column; }
    .active-shift-item-info strong { font-size: 18px; color: var(--text-primary); }
    .active-shift-item-info span { font-size: 14px; color: var(--text-secondary); }
    .active-shift-item-actions { display: flex; gap: 10px; }
    #mobile-footer {
      display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: 65px;
      background-color: var(--bg-secondary); border-top: 1px solid var(--border-color);
      box-shadow: 0 -2px 10px var(--shadow-color); z-index: 50;
    }
    #mobile-footer-nav { display: flex; justify-content: space-around; align-items: center; height: 100%; }
    .mobile-nav-link {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      text-decoration: none; color: var(--text-secondary); flex-grow: 1;
      height: 100%; transition: color 0.2s;
    }
    .mobile-nav-link svg { width: 24px; height: 24px; margin-bottom: 4px; }
    .mobile-nav-link span { font-size: 10px; font-weight: 500; }
    .mobile-nav-link.active { color: var(--brand-primary); }

    /* --- Reportes y Estadísticas Reestructurado --- */
    .report-card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
    .report-card h3 {
        font-size: 14px; color: var(--text-secondary); font-weight: 500; margin: 0 0 8px 0;
    }
    .report-card p { font-size: 24px; font-weight: 700; margin: 0; }
    #stats-visuals { margin-top: 24px; }
    .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
    .chart-container { position: relative; }
    .chart-container h3 { margin-bottom: 16px; font-size: 18px; font-weight: 500; }
    .d3-tooltip {
        position: absolute; text-align: center;
        padding: 8px; font-size: 12px;
        background: var(--dark-bg-secondary); color: var(--dark-text-primary);
        border: 0px; border-radius: 8px; pointer-events: none;
        opacity: 0; transition: opacity 0.2s;
    }
    .axis path, .axis line { stroke: var(--border-color); }
    .axis text { fill: var(--text-secondary); }
    #report-loader { text-align: center; padding: 40px; }


    /* --- Notificaciones Reestructuradas (Estilo Google) --- */
    .notification-container { position: relative; }
    #notification-counter {
        position: absolute; top: 0px; right: 0px;
        background-color: var(--accent-red); color: white;
        border-radius: 50%; width: 18px; height: 18px; font-size: 11px;
        display: flex; align-items: center; justify-content: center; font-weight: 700;
        border: 2px solid var(--bg-secondary);
    }
    #notification-dropdown {
        position: absolute; top: calc(100% + 12px); right: 0;
        width: 380px; z-index: 110;
        background-color: var(--bg-primary); /* Fondo Sólido */
        border: 1px solid var(--border-color); /* Borde Definido */
        box-shadow: 0 4px 16px rgba(0,0,0,0.12); /* Sombra Sutil */
        border-radius: 12px;
        display: flex; flex-direction: column;
        overflow: hidden;
    }
    .notification-header {
        padding: 16px 20px; border-bottom: 1px solid var(--border-color);
        display: flex; justify-content: space-between; align-items: center;
    }
    .notification-header h3 { margin: 0; font-size: 18px;}
    #notification-list { flex-grow: 1; max-height: 400px; overflow-y: auto; }
    .notification-item {
        padding: 12px 20px; border-bottom: 1px solid var(--border-color);
        display: flex; gap: 12px; align-items: flex-start;
        cursor: pointer; transition: background-color 0.2s;
    }
    .notification-item:last-child { border-bottom: none; }
    .notification-item:hover { background-color: var(--bg-tertiary); }
    .notification-item.unread { font-weight: 500; }
    .notification-icon {
        flex-shrink: 0; width: 36px; height: 36px;
        display: grid; place-items: center; border-radius: 50%;
        background-color: var(--bg-tertiary); margin-top: 2px;
    }
    .notification-icon svg { width: 18px; height: 18px; color: var(--text-secondary); }
    .notification-content p { margin: 0 0 4px 0; font-size: 14px; line-height: 1.4; color: var(--text-primary); }
    .notification-content span { font-size: 12px; color: var(--text-secondary); }
    
    @media (max-width: 992px) {
        .charts-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
      #main-nav { position: fixed; left: -270px; top: 60px; z-index: 80; box-shadow: 4px 0 15px rgba(0,0,0,.1); }
      #main-nav.open { left: 0; }
      #content { padding: 16px; padding-bottom: 80px; }
      #menu-toggle { display: block !important; }
      #mobile-footer { display: block; }
      #logout-btn span { display: none; }
      #logout-btn { padding: 8px; }
      #notification-dropdown.mobile-active {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 90vw; max-width: 380px;
      }
      .register-fields-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 640px) {
      header { padding: 0 16px; }
      .form-grid { grid-template-columns: 1fr; }
      .report-card-grid { grid-template-columns: 1fr 1fr; }
      .active-shift-item { flex-direction: column; align-items: flex-start; gap: 12px; }
      table { font-size: 14px; }
      thead th, tbody td { padding: 12px 8px; }
      .actions { flex-wrap: wrap; gap: 6px; }
      .actions button { padding: 5px 8px; font-size: 13px; }
    }
  </style>
</head>
<body>

  <div id="toast-container"></div>
  <div id="auth-container" class="hidden"></div>

  <div id="app-container" class="hidden">
    <header>
      <button id="menu-toggle" title="Menú" class="button-secondary" style="padding: 8px 10px; display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
      </button>
      <a href="#" class="header-logo" data-view="reports-view">
        <svg class="header-logo-icon" viewBox="0 0 120 120">
          <defs><linearGradient id="headerLogoGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="var(--grad-yellow)"/><stop offset="55%" stop-color="var(--grad-orange)"/><stop offset="100%" stop-color="var(--grad-red)"/></linearGradient></defs>
          <g fill="url(#headerLogoGradient)">
            <polygon points="60,10 100,30 60,50 20,30"/><polygon points="100,30 100,70 60,90 60,50"/><polygon points="20,30 60,50 60,90 20,70"/>
          </g>
        </svg>
        <span class="header-logo-text"><span class="header-logo-seb">seb365</span> <span class="header-logo-pro">pro</span></span>
      </a>
      <div class="user-info">
        <button id="theme-toggle" title="Alternar tema" class="button-secondary" style="padding: 8px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
        </button>
        <div id="notification-bell" class="notification-container">
            <button title="Notificaciones" class="button-secondary" style="padding: 8px; position: relative;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                <span id="notification-counter" class="hidden"></span>
            </button>
            <div id="notification-dropdown" class="hidden">
                <div class="notification-header">
                    <h3>Notificaciones</h3>
                </div>
                <div id="notification-list">
                    </div>
            </div>
        </div>
        <button id="profile-btn" title="Mi Perfil" class="button-secondary" style="padding: 8px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        </button>
        <button id="logout-btn" class="button-secondary" style="display:flex; align-items:center; gap: 8px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
            <span>Salir</span>
        </button>
      </div>
    </header>
    <main>
      <nav id="main-nav">
        <a href="#" class="nav-link" data-view="reports-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg><span>Reportes</span></a>
        <a href="#" class="nav-link" data-view="shifts-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><span>Turnos y Ventas</span></a>
        <a href="#" class="nav-link" data-view="inventory-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><path d="m3.27 6.96 8.73 5.05 8.73-5.05"/><path d="m12 22.08V12"/></svg><span>Inventario</span></a>
        <a href="#" class="nav-link" data-view="cashflow-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg><span>Flujo de Caja</span></a>
        <a href="#" class="nav-link" data-view="products-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><span>Productos y Fichas</span></a>
        <a href="#" class="nav-link" data-view="providers-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg><span>Proveedores</span></a>
        <a href="#" class="nav-link admin-only" data-view="workers-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Trabajadores</span></a>
        <a href="#" class="nav-link hidden" data-view="profile-view"></a>
      </nav>
      <div id="content"></div>
    </main>
    <footer id="mobile-footer">
        <div id="mobile-footer-nav">
            <a href="#" class="mobile-nav-link" data-view="shifts-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><span>Turnos</span></a>
            <a href="#" class="mobile-nav-link" data-view="inventory-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><path d="m3.27 6.96 8.73 5.05 8.73-5.05"/><path d="m12 22.08V12"/></svg><span>Inventario</span></a>
            <a href="#" class="mobile-nav-link" data-view="cashflow-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg><span>Caja</span></a>
            <a href="#" class="mobile-nav-link" data-view="products-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><span>Productos</span></a>
            <a href="#" class="mobile-nav-link" data-view="providers-view"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg><span>Proveedores</span></a>
        </div>
    </footer>
  </div>

  <div id="loan-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3>Registrar Préstamo</h3><button type="button" class="modal-close-btn">&times;</button></div>
        <form id="loan-form">
            <div class="modal-form-body">
                <input id="loan-description" placeholder="Descripción" required>
                <input id="loan-value" type="number" step="any" min="1" placeholder="Valor" required>
                <button type="submit">Añadir Préstamo</button>
            </div>
        </form>
    </div>
  </div>
 
  <div id="ficha-sale-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="ficha-sale-modal-title">Vender Ficha</h3>
            <button type="button" class="modal-close-btn">&times;</button>
        </div>
        <form id="ficha-sale-form">
            <div class="modal-form-body">
                <input type="hidden" id="ficha-sale-product-id">
                <p>Stock disponible: <strong id="ficha-sale-stock"></strong></p>
                <div>
                    <label for="ficha-sale-quantity">Cantidad a vender:</label>
                    <input id="ficha-sale-quantity" type="number" min="1" required>
                </div>
                <button type="submit">Confirmar Venta</button>
            </div>
        </form>
    </div>
  </div>

  <div id="desglose-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="desglose-modal-title">Desglose del Turno</h3>
            <button type="button" class="modal-close-btn">&times;</button>
        </div>
        <div id="desglose-modal-body" class="table-wrapper" style="max-height: 60vh; overflow-y: auto;"></div>
    </div>
  </div>

  <div id="sales-breakdown-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="sales-breakdown-modal-title">Desglose de Pago por Ventas</h3>
            <button type="button" class="modal-close-btn">&times;</button>
        </div>
        <div id="sales-breakdown-modal-body" style="max-height: 60vh; overflow-y: auto;">
            <p>Calculando reporte...</p>
        </div>
    </div>
   </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, collectionGroup, doc, setDoc, addDoc, getDoc, getDocs, onSnapshot, query, where, orderBy, serverTimestamp, writeBatch, runTransaction, increment, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- Inicialización de Firebase ---
    const firebaseConfig = {
        apiKey: "AIzaSyDm2g7JwRNwF9Xgktj9ATPkJM8qnss8eNg",
        authDomain: "seb360-pro.firebaseapp.com",
        projectId: "seb360-pro",
        storageBucket: "seb360-pro.appspot.com",
        messagingSenderId: "750401346580",
        appId: "1:750401346580:web:a682fd6ae09292ff589b01"
    };

    const appFB = initializeApp(firebaseConfig);
    const auth = getAuth(appFB);
    const db = getFirestore(appFB);

    // --- Helpers y Estado Global ---
    const tenantId = () => auth.currentUser?.uid;
    const TCOL = (...segs) => collection(db, "tenants", tenantId(), ...segs);
    const TDOC = (...segs) => doc(db, "tenants", tenantId(), ...segs);
    const stockRef = (productId, place) => TDOC("inventory", productId, "stock", place);

    let colref = {};
    function buildColRef() {
      if (!tenantId()) return;
      colref = {
        users: collection(db, "users"),
        products: TCOL("products"),
        providers: TCOL("providers"),
        workers: TCOL("workers"),
        cashflow: TCOL("cashflow_entries"),
        shifts: TCOL("shifts"),
        purchases: TCOL("purchases"),
        notifications: TCOL("notifications")
      };
    }

    let appState = {
      user: null, userData: null, role: null, unsub: [],
      products: [], providers: [], workers: [], notifications: [],
      inventory: {}, cashflow: [],
      activeShifts: [], selectedShiftId: null,
      reportCache: null 
    };
    let registrationData = {}, shiftSubListeners = {}, stockUnsubscribers = {};

    // --- Funciones de Utilidad ---
    const showToast = (msg, type = "success") => {
      const c = document.getElementById("toast-container");
      const t = document.createElement("div");
      t.className = `toast ${type}`;
      t.textContent = msg;
      c.appendChild(t);
      setTimeout(() => t.remove(), 3200);
    };

    const COP = (v) => new Intl.NumberFormat("es-CO", { style: "currency", currency: "COP", maximumFractionDigits: 0 }).format(v);
    const fmtDate = (ts) => ts?.toDate().toLocaleString("es-CO", { hour12: true, day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'}) ?? "—";
    const fmtDateShort = (d) => d.toLocaleDateString('es-CO', { year: 'numeric', month: 'short', day: 'numeric' });

    const toUnidades = (qty, unit, prod) => {
        if (!prod) return qty;
        if (unit === "cajas") return qty * (prod.unidadesPorCaja || 1);
        if (unit === "canastas") return qty * (prod.unidadesPorCanasta || 1);
        return qty;
    };
    
    function hexToRgb(hex) {
        let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    }

    let raf = null;
    const scheduleRender = (forceId = null) => {
      if (raf) return;
      raf = requestAnimationFrame(() => {
        const activeId = forceId || (document.querySelector(".nav-link.active")?.dataset.view) || "reports-view";
        renderView(activeId);
        document.querySelectorAll('.mobile-nav-link').forEach(link => {
            link.classList.toggle('active', link.dataset.view === activeId);
        });
        raf = null;
      });
    };

    // --- Manejadores de Eventos Principales ---
    const mainNav = document.getElementById("main-nav");
    const mobileFooterNav = document.getElementById("mobile-footer-nav");
    
    function handleNavClick(e) {
      const link = e.target.closest(".nav-link, .mobile-nav-link, .header-logo");
      if (!link || !link.dataset.view) return;
      e.preventDefault();
      mainNav.classList.remove("open");
      const viewId = link.dataset.view;
      document.querySelectorAll(".nav-link, .mobile-nav-link").forEach(n => {
        n.classList.toggle('active', n.dataset.view === viewId);
      });
      appState.selectedShiftId = null;
      scheduleRender(viewId);
    }

    mainNav.addEventListener("click", handleNavClick);
    mobileFooterNav.addEventListener("click", handleNavClick);
    document.querySelector('header').addEventListener("click", handleNavClick);
    document.getElementById("menu-toggle").addEventListener("click", () => mainNav.classList.toggle("open"));
    document.getElementById("profile-btn").addEventListener("click", () => document.querySelector('.nav-link[data-view="profile-view"]').click());
    document.getElementById("logout-btn").addEventListener("click", () => signOut(auth));
    
    // --- Lógica de Tema (Claro/Oscuro) ---
    const themeToggleBtn = document.getElementById('theme-toggle');
    const updateThemeToggleIcon = (theme) => {
      const icon = themeToggleBtn.querySelector('svg');
      icon.innerHTML = theme === 'dark'
        ? `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>`
        : `<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>`;
    };
    
    function applyTheme(theme) {
        document.body.setAttribute('data-theme', theme);
        updateThemeToggleIcon(theme);
        const primaryBG = getComputedStyle(document.documentElement).getPropertyValue('--bg-primary').trim();
        const borderC = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
        const primaryRgb = hexToRgb(primaryBG) || {r: 255, g: 255, b: 255};
        const borderRgb = hexToRgb(borderC) || {r: 224, g: 224, b: 224};
        document.documentElement.style.setProperty('--bg-primary-rgb', `${primaryRgb.r}, ${primaryRgb.g}, ${primaryRgb.b}`);
        document.documentElement.style.setProperty('--border-color-rgb', `${borderRgb.r}, ${borderRgb.g}, ${borderRgb.b}`);
    }

    themeToggleBtn.addEventListener('click', () => {
      const newTheme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      localStorage.setItem('theme', newTheme);
      applyTheme(newTheme);
      if(document.querySelector('.nav-link[data-view="reports-view"].active')){
        scheduleRender();
      }
    });
    
    const savedTheme = localStorage.getItem('theme');
    const initialTheme = savedTheme || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    applyTheme(initialTheme);


    // --- Flujo de Autenticación ---
    const authContainer = document.getElementById("auth-container");
    const ICONS = {
        eye: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>`,
        eyeOff: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path><line x1="2" y1="2" x2="22" y2="22"></line></svg>`
    };

    function renderAuthUI(view = 'login') {
        const loginActive = view === 'login';
        authContainer.innerHTML = `
        <div class="auth-box">
            <a href="#" class="header-logo" style="justify-content: center; text-decoration: none;">
                <svg class="header-logo-icon" viewBox="0 0 120 120" style="width: 36px; height: 36px;">
                  <defs><linearGradient id="authLogoGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="var(--grad-yellow)"/><stop offset="55%" stop-color="var(--grad-orange)"/><stop offset="100%" stop-color="var(--grad-red)"/></linearGradient></defs>
                  <g fill="url(#authLogoGradient)"><polygon points="60,10 100,30 60,50 20,30"/><polygon points="100,30 100,70 60,90 60,50"/><polygon points="20,30 60,50 60,90 20,70"/></g>
                </svg>
                <span class="header-logo-text"><span class="header-logo-seb">seb365</span> <span class="header-logo-pro">pro</span></span>
            </a>
            <div id="login-view" class="${loginActive ? '' : 'hidden'}">
                <h2>Bienvenido de Nuevo</h2><p>Ingresa tus credenciales para continuar.</p>
                <form id="login-form" autocomplete="on">
                    <div class="auth-form-fields">
                        <input type="email" id="login-email" placeholder="Correo electrónico" required>
                        <div class="password-wrapper">
                            <input type="password" id="login-password" placeholder="Contraseña" required>
                            <button type="button" class="password-toggle-btn" title="Mostrar/Ocultar contraseña">${ICONS.eye}</button>
                        </div>
                    </div>
                    <button type="submit">Ingresar</button>
                    <div class="divider">o</div>
                    <button id="google-login-btn" type="button" class="button-secondary" style="display:flex;justify-content:center;align-items:center;"><svg viewBox="0 0 48 48" style="width:18px;height:18px;margin-right:8px;"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg><span>Entrar con Google</span></button>
                </form>
                <p style="margin-top:20px; font-size: 14px;">¿No tienes cuenta? <a href="#" id="show-register-link" class="auth-switch-link">Crea una ahora</a></p>
            </div>
            <div id="register-view" class="${loginActive ? 'hidden' : ''}">
                <h2>Crea tu Cuenta</h2><p>Completa el formulario para empezar a gestionar tu negocio.</p>
                <form id="register-form" autocomplete="on">
                    <div class="auth-form-fields">
                         <input type="text" id="register-name" placeholder="Nombre completo" required>
                         <input type="email" id="register-email" placeholder="Correo electrónico" required>
                        <div class="register-fields-grid">
                            <input type="tel" id="register-phone" placeholder="Teléfono" required>
                            <input type="text" id="register-business-name" placeholder="Nombre del negocio" required>
                        </div>
                        <select id="register-business-type" required><option value="">Tipo de negocio...</option><option value="bar">Bar</option><option value="discoteca">Discoteca</option><option value="cafeteria">Cafetería</option><option value="restaurante">Restaurante</option></select>
                        <div class="register-fields-grid">
                            <div class="password-wrapper">
                                <input type="password" id="register-password" placeholder="Contraseña" required>
                                <button type="button" class="password-toggle-btn" title="Mostrar/Ocultar contraseña">${ICONS.eye}</button>
                            </div>
                            <div class="password-wrapper">
                                <input type="password" id="register-password-confirm" placeholder="Confirmar" required>
                                <button type="button" class="password-toggle-btn" title="Mostrar/Ocultar contraseña">${ICONS.eye}</button>
                            </div>
                        </div>
                    </div>
                    <button type="submit">Crear Cuenta</button>
                </form>
                 <p style="margin-top:20px; font-size: 14px;">¿Ya tienes cuenta? <a href="#" id="show-login-link" class="auth-switch-link">Inicia sesión</a></p>
            </div>
        </div>`;
        document.getElementById("login-form").addEventListener("submit", async (e) => { e.preventDefault(); const btn = e.target.querySelector('button[type="submit"]'); btn.disabled=true; signInWithEmailAndPassword(auth, document.getElementById("login-email").value, document.getElementById("login-password").value).catch(err=>showToast(err.message,"error")).finally(()=>{btn.disabled=false;}); });
        document.getElementById("google-login-btn").addEventListener("click", async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch(err) { showToast(err.message, "error"); } });
        document.getElementById("register-form").addEventListener("submit", async (e) => { 
            e.preventDefault(); 
            const password = document.getElementById("register-password").value;
            const confirmPassword = document.getElementById("register-password-confirm").value;
            if (password.length < 6) { showToast("La contraseña debe tener al menos 6 caracteres.", "error"); return; }
            if (password !== confirmPassword) { showToast("Las contraseñas no coinciden.", "error"); return; }
            const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true;
            const regData = {
                displayName: document.getElementById("register-name").value, phone: document.getElementById("register-phone").value, email: document.getElementById("register-email").value,
                password: password, businessName: document.getElementById("register-business-name").value, businessType: document.getElementById("register-business-type").value
            };
            try { 
                const cred = await createUserWithEmailAndPassword(auth, regData.email, regData.password); 
                const batch = writeBatch(db);
                batch.set(doc(db, "users", cred.user.uid), { email: regData.email, displayName: regData.displayName, createdAt: serverTimestamp() });
                batch.set(doc(db, "tenants", cred.user.uid), {
                    ownerName: regData.displayName, ownerEmail: regData.email, phone: regData.phone,
                    businessName: regData.businessName, businessType: regData.businessType,
                    role: "admin", active: true, createdAt: serverTimestamp()
                });
                await batch.commit();
                showToast("Cuenta creada exitosamente"); 
            } catch(err) { showToast(err.message, "error"); } finally { btn.disabled = false; } 
        });
        document.getElementById("show-register-link").addEventListener("click", (e) => { e.preventDefault(); renderAuthUI('register'); });
        document.getElementById("show-login-link").addEventListener("click", (e) => { e.preventDefault(); renderAuthUI('login'); });
        authContainer.addEventListener('click', (e) => {
            const toggleBtn = e.target.closest('.password-toggle-btn');
            if (toggleBtn) {
                const passwordInput = toggleBtn.closest('.password-wrapper').querySelector('input');
                passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
                toggleBtn.innerHTML = passwordInput.type === 'password' ? ICONS.eye : ICONS.eyeOff;
            }
        });
    }
    
    let persistentHandlersAttached = false;
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        buildColRef();
        const tenantDocRef = doc(db, "tenants", user.uid);
        const tenantDoc = await getDoc(tenantDocRef);
        appState.user = user;
        appState.userData = tenantDoc.exists() ? tenantDoc.data() : { email: user.email };
        appState.role = appState.userData.role || "admin";
        document.body.dataset.role = appState.role;
        document.getElementById("auth-container").classList.add("hidden");
        document.getElementById("app-container").classList.remove("hidden");
        document.querySelector('.nav-link[data-view="reports-view"]').classList.add("active");
        if (!persistentHandlersAttached) {
          attachPersistentHandlers();
          persistentHandlersAttached = true;
        }
        initRealtime();
        scheduleRender("reports-view");
      } else {
        appState.unsub.forEach(u => { if(typeof u === 'function') u() });
        Object.values(stockUnsubscribers).forEach(unsubArray => unsubArray.forEach(unsub => { if(typeof unsub === 'function') unsub() }));
        Object.values(shiftSubListeners).forEach(unsubArray => unsubArray.forEach(unsub => { if(typeof unsub === 'function') unsub() }));
        stockUnsubscribers = {};
        shiftSubListeners = {};
        appState = { user: null, userData: null, role: null, unsub: [], products: [], providers: [], workers: [], notifications: [], inventory: {}, cashflow: [], activeShifts: [], selectedShiftId: null, reportCache: null };
        document.getElementById("app-container").classList.add("hidden");
        document.getElementById("auth-container").classList.remove("hidden");
        renderAuthUI('login');
        persistentHandlersAttached = false;
      }
    });

    function initRealtime(){
      if(!tenantId()) return;
      appState.unsub.forEach(u=> { if(typeof u === 'function') u() }); 
      appState.unsub=[];
      
      Object.values(stockUnsubscribers).forEach(unsubArray => unsubArray.forEach(unsub => { if(typeof unsub === 'function') unsub() }));
      stockUnsubscribers = {};

      const add = (un)=> appState.unsub.push(un);

      add(onSnapshot(query(colref.products, orderBy("nombre")), (snapshot) => {
          appState.products = snapshot.docs.map(d => ({id:d.id, ...d.data()}));
          const newProductIds = new Set(appState.products.map(p => p.id));
          for (const productId in stockUnsubscribers) {
              if (!newProductIds.has(productId)) {
                  stockUnsubscribers[productId].forEach(unsub => unsub());
                  delete stockUnsubscribers[productId];
                  delete appState.inventory[productId];
              }
          }
          appState.products.forEach(product => {
              if (!stockUnsubscribers[product.id]) {
                  const unsubBodega = onSnapshot(stockRef(product.id, 'bodega'), (docSnap) => {
                      if (!appState.inventory[product.id]) appState.inventory[product.id] = {};
                      appState.inventory[product.id].bodega = docSnap.data() || { unidades: 0 };
                      scheduleRender();
                  });
                  const unsubBarra = onSnapshot(stockRef(product.id, 'barra'), (docSnap) => {
                      if (!appState.inventory[product.id]) appState.inventory[product.id] = {};
                      appState.inventory[product.id].barra = docSnap.data() || { unidades: 0 };
                      scheduleRender();
                  });
                  stockUnsubscribers[product.id] = [unsubBodega, unsubBarra];
              }
          });
          scheduleRender();
      }));

      add(onSnapshot(query(colref.providers, orderBy("nombre")), s=>{ appState.providers = s.docs.map(d=>({id:d.id, ...d.data()})); scheduleRender(); }));
      add(onSnapshot(query(colref.workers, orderBy("nombre")), s=>{ appState.workers = s.docs.map(d=>({id:d.id, ...d.data()})); scheduleRender(); }));
      add(onSnapshot(query(colref.cashflow, orderBy("date","desc")), s=>{ appState.cashflow = s.docs.map(d=>({id:d.id, ...d.data()})); scheduleRender(); }));
      add(onSnapshot(query(colref.notifications, orderBy("timestamp", "desc")), s => {
            appState.notifications = s.docs.map(d => ({id: d.id, ...d.data()}));
            renderNotifications();
      }));
      add(onSnapshot(query(colref.shifts, where("estado", "==", "abierto")), (snapshot) => {
        const currentShiftIds = snapshot.docs.map(doc => doc.id);
        const previousShiftIds = appState.activeShifts.map(shift => shift.id);
        previousShiftIds.forEach(shiftId => {
            if (!currentShiftIds.includes(shiftId) && shiftSubListeners[shiftId]) {
                shiftSubListeners[shiftId].forEach(unsub => unsub());
                delete shiftSubListeners[shiftId];
            }
        });
        const shiftsData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        shiftsData.forEach((shiftData) => {
            const existingShiftIndex = appState.activeShifts.findIndex(s => s.id === shiftData.id);
            if (existingShiftIndex === -1) {
                const newShift = { ...shiftData, sales: [], loans: [] };
                appState.activeShifts.push(newShift);
                const salesUnsub = onSnapshot(TCOL("shifts", shiftData.id, "sales"), (salesSnapshot) => {
                    const shiftToUpdate = appState.activeShifts.find(s => s.id === shiftData.id);
                    if(shiftToUpdate) shiftToUpdate.sales = salesSnapshot.docs.map(d => ({id:d.id, ...d.data()}));
                    scheduleRender();
                });
                const loansUnsub = onSnapshot(TCOL("shifts", shiftData.id, "loans"), (loansSnapshot) => {
                    const shiftToUpdate = appState.activeShifts.find(s => s.id === shiftData.id);
                    if(shiftToUpdate) shiftToUpdate.loans = loansSnapshot.docs.map(d => ({id:d.id, ...d.data()}));
                    scheduleRender();
                });
                shiftSubListeners[shiftData.id] = [salesUnsub, loansUnsub];
            }
        });
        appState.activeShifts = appState.activeShifts.filter(s => currentShiftIds.includes(s.id));
        scheduleRender();
      }));
    }

    const content = document.getElementById("content");
    const row = (cols)=> `<tr>${cols.map(c=>`<td>${c}</td>`).join("")}</tr>`;
    
    function renderView(id) {
        let html = "";
        if (id === 'reports-view') {
            html = `<div class="content-view">
                <h2>Panel de Reportes</h2>
                <div class="card" style="margin-bottom: 24px;">
                    <form id="reports-form" style="display: flex; flex-direction: column; gap: 16px;">
                        <div class="form-grid" style="align-items: flex-end;">
                            <div>
                                <label for="report-start-date">Fecha de Inicio</label>
                                <input type="datetime-local" id="report-start-date" required>
                            </div>
                            <div>
                                <label for="report-end-date">Fecha de Fin</label>
                                <input type="datetime-local" id="report-end-date" required>
                            </div>
                        </div>
                        <div id="date-presets" style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="button" class="button-secondary" data-range="today">Hoy</button>
                            <button type="button" class="button-secondary" data-range="yesterday">Ayer</button>
                            <button type="button" class="button-secondary" data-range="week">Últimos 7 días</button>
                            <button type="button" class="button-secondary" data-range="month">Este Mes</button>
                        </div>
                    </form>
                </div>

                <div id="report-content">
                    <div id="report-loader" class="hidden" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <p>Calculando reporte, por favor espera...</p>
                    </div>
                    <div id="report-empty-state" class="hidden" style="text-align: center; padding: 60px; color: var(--text-secondary); background-color: var(--bg-secondary); border-radius: 12px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 16px; color: var(--border-color);">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line>
                        </svg>
                        <h3 style="margin: 0; color: var(--text-primary);">No se encontraron datos</h3>
                        <p>No hay turnos cerrados ni movimientos de caja en el período seleccionado.</p>
                    </div>
                    <div id="report-data-container" class="hidden">
                        <div class="report-card-grid">
                            <div class="card report-card"><h3>Ganancia Bruta</h3><p id="report-ganancia-bruta">${COP(0)}</p></div>
                            <div class="card report-card"><h3>Costos Totales</h3><p id="report-costos-totales" class="amount-negative">${COP(0)}</p></div>
                            <div class="card report-card"><h3>Ganancia Neta</h3><p id="report-ganancia-neta">${COP(0)}</p></div>
                            <div class="card report-card"><h3>Unidades Vendidas</h3><p id="report-unidades">0</p></div>
                        </div>

                        <div id="stats-visuals" class="card" style="margin-top: 24px;">
                            <h2>Estadísticas Visuales</h2>
                            <div class="charts-grid">
                                <div class="chart-container"><h3>Ingresos por Día</h3><div id="bar-chart-container"></div></div>
                                <div class="chart-container"><h3>Top Productos Vendidos</h3><div id="donut-chart-container"></div></div>
                            </div>
                        </div>

                        <div style="margin-top: 24px; display: flex; justify-content: flex-end;">
                            <button id="generate-pdf-btn" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px; vertical-align: middle;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                                Generar Reporte PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
        }
        if (id === 'products-view') {
            const providersPorVentas = appState.providers.filter(p => p.tipoPago === 'porVentas');
            const providerOpts = providersPorVentas.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
            const rows = appState.products.map(p => row([ p.nombre, p.esFicha ? 'Sí' : 'No', COP(p.precioVenta || 0), COP(p.precioComision || 0), `<div class="actions"><button class="btn-edit" data-id="${p.id}">Editar</button></div>` ])).join("");
            html = `<div class="content-view"><h2>Productos y Fichas</h2><form id="product-form" class="card"><input type="hidden" id="product-id"><div class="form-grid"><div><label for="product-nombre">Nombre</label><input id="product-nombre" placeholder="Nombre" required></div><div><label for="product-precioVenta">Precio Venta</label><input id="product-precioVenta" type="number" step="any" min="0" placeholder="Precio Venta" required></div><div><label for="product-precioCompra">Precio Compra</label><input id="product-precioCompra" type="number" step="any" min="0" placeholder="Precio Compra" required></div><div><label for="product-precioComision">Valor para Pago (Comisión)</label><input id="product-precioComision" type="number" step="any" min="0" placeholder="Valor para Pago (Comisión)"></div><div><label for="product-unidadesPorCaja">Unidades por Caja</label><input id="product-unidadesPorCaja" type="number" min="1" placeholder="Unid. por Caja"></div><div><label for="product-unidadesPorCanasta">Unidades por Canasta</label><input id="product-unidadesPorCanasta" type="number" min="1" placeholder="Unid. por Canasta"></div></div><div id="provider-por-ventas-wrapper" style="margin-top: 16px;">
            <label for="product-providerPorVentas">Proveedor para Pago por Ventas (Opcional)</label>
            <select id="product-providerPorVentas"><option value="">Ninguno</option>${providerOpts}</select>
            </div><div style="margin-top: 16px;"><label style="display:inline-flex; align-items:center; gap: 8px; font-size: 16px;"><input id="product-esFicha" type="checkbox"> Es una Ficha</label></div><button type="submit" style="margin-top: 16px;">Guardar</button></form><div class="table-wrapper" style="margin-top:24px"><table><thead><tr><th>Nombre</th><th>Es Ficha</th><th>P. Venta</th><th>Valor Pago</th><th>Acciones</th></tr></thead><tbody>${rows}</tbody></table></div></div>`;
        }
        if (id === 'inventory-view') {
            const rows = appState.products.map(p=> row([ p.nombre, appState.inventory[p.id]?.bodega?.unidades ?? 0, appState.inventory[p.id]?.barra?.unidades ?? 0 ])).join("");
            const productOpts = appState.products.map(p=>`<option value="${p.id}">${p.nombre}</option>`).join("");
            const providerOpts = appState.providers.map(p=>`<option value="${p.id}">${p.nombre}</option>`).join("");
            html = `<div class="content-view"><h2>Inventario y Compras</h2><div class="form-grid"><form id="purchase-form" class="card"><h3>Registrar Compra</h3><div style="display: flex; flex-direction: column; gap: 12px;"><select id="purchase-provider" required><option value="">Proveedor…</option>${providerOpts}</select><div id="provider-payment-type-display" style="margin-top: -4px; margin-bottom: -4px; padding: 10px; background-color: var(--bg-primary); border-radius: 8px; border: 1px solid var(--border-color); display: none;"><span style="color: var(--text-secondary); font-size: 14px;">Tipo de Pago: </span><strong style="font-weight: 500;"></strong></div><select id="purchase-product" required><option value="">Producto…</option>${productOpts}</select><input id="purchase-quantity" type="number" min="1" placeholder="Cantidad" required><select id="purchase-unit" required><option value="unidades">Unidades</option><option value="cajas">Cajas</option><option value="canastas">Canastas</option></select><button type="submit">Registrar Compra</button></div></form><form id="transfer-form" class="card"><h3>Trasladar Bodega → Barra</h3><div style="display: flex; flex-direction: column; gap: 12px;"><select id="transfer-product" required><option value="">Producto…</option>${productOpts}</select><input id="transfer-quantity" type="number" min="1" placeholder="Cantidad" required><select id="transfer-unit" required><option value="unidades">Unidades</option><option value="cajas">Cajas</option><option value="canastas">Canastas</option></select><button type="submit">Trasladar</button></div></form></div><h3 style="margin:24px 0 12px 0;">Stock Actual</h3><div class="table-wrapper"><table><thead><tr><th>Producto</th><th>Stock Bodega</th><th>Stock Barra</th></tr></thead><tbody>${rows || `<tr><td colspan="3">Sin stock.</td></tr>`}</tbody></table></div></div>`;
        }
        if (id === 'cashflow-view') {
            const rows = appState.cashflow.map(e=>`<tr><td>${fmtDate(e.date)}</td><td>${e.description}</td><td class="${e.type==="ingreso"?"amount-positive":"amount-negative"}" style="font-weight: 500;">${COP(e.type==="ingreso"?e.amount:-e.amount)}</td></tr>`).join("");
            html = `<div class="content-view"><h2>Flujo de Caja</h2><form id="cashflow-form" class="card"><div class="form-grid" style="align-items: flex-end;"><select id="cashflow-type" required><option value="ingreso">Ingreso</option><option value="egreso">Egreso</option></select><input id="cashflow-amount" type="number" step="any" min="1" placeholder="Monto" required></div><input id="cashflow-description" placeholder="Descripción" required style="margin: 12px 0;"><button type="submit">Registrar</button></form><h3 style="margin:24px 0 12px 0;">Historial</h3><div class="table-wrapper"><table><thead><tr><th>Fecha</th><th>Descripción</th><th>Monto</th></tr></thead><tbody>${rows || `<tr><td colspan="3">Sin movimientos.</td></tr>`}</tbody></table></div></div>`;
        }
        if (id === 'providers-view') {
            const getTipoPagoText = (tipo) => {
                if (tipo === 'porVentas') return 'Por Ventas';
                if (tipo === 'consignacion') return 'Consignación';
                return 'Contado';
            };
            const rows = appState.providers.map(p => {
                const actions = `<div class="actions"><button class="btn-edit-provider" data-id="${p.id}">Editar</button>${p.tipoPago === 'porVentas' ? `<button class="btn-view-sales-breakdown button-secondary" data-id="${p.id}">Desglose</button>` : ''}<button class="btn-settle" data-id="${p.id}">Liquidar</button></div>`;
                return row([p.nombre, getTipoPagoText(p.tipoPago), COP(p.saldoPendiente || 0), actions]);
            }).join("");

            html = `<div class="content-view"><h2>Proveedores</h2><form id="provider-form" class="card ${appState.role==="admin"?"":"hidden"}"><input type="hidden" id="provider-id"><div class="form-grid" style="margin-bottom: 12px; align-items: end;"><div><label for="provider-nombre">Nombre del proveedor</label><input id="provider-nombre" placeholder="Nombre del proveedor" required></div><div><label for="provider-contacto">Contacto</label><input id="provider-contacto" placeholder="Contacto"></div><div><label for="provider-tipoPago">Tipo de Pago</label><select id="provider-tipoPago"><option value="contado">Contado</option><option value="consignacion">Consignación</option><option value="porVentas">Por Ventas</option></select></div></div><button type="submit">Guardar Proveedor</button></form><div id="settlement-details" class="hidden card" style="margin-top:12px; border-left: 4px solid var(--brand-primary);"><h4>Liquidar a: <span id="settlement-provider-name"></span></h4><p>Saldo: <strong id="settlement-provider-balance"></strong></p><button id="settle-provider-btn">Pagar y Registrar Egreso</button></div><h3 style="margin:24px 0 12px 0;">Lista</h3><div class="table-wrapper"><table><thead><tr><th>Nombre</th><th>Tipo de Pago</th><th>Saldo</th><th>Acciones</th></tr></thead><tbody>${rows || `<tr><td colspan="4">Sin proveedores.</td></tr>`}</tbody></table></div></div>`;
        }
        if (id === 'workers-view') {
            const rows = appState.workers.map(w=> row([ w.nombre, COP(w.pagoBase||0), (w.activo?"✅":"❌"), `<div class="actions"><button class="btn-edit-worker" data-id="${w.id}">Editar</button></div>` ])).join("");
            html = `<div class="content-view"><h2>Trabajadores</h2><form id="worker-form" class="card"><input type="hidden" id="worker-id"><div class="form-grid" style="margin-bottom: 12px;"><input id="worker-nombre" placeholder="Nombre completo" required><input id="worker-pagoBase" type="number" step="any" min="0" placeholder="Pago base (opcional)"></div><label style="display:inline-flex; align-items:center; gap: 8px;"><input id="worker-activo" type="checkbox" checked> Activo</label><button type="submit">Guardar Trabajador</button></form><h3 style="margin:24px 0 12px 0;">Lista</h3><div class="table-wrapper"><table><thead><tr><th>Nombre</th><th>Pago Base</th><th>Activo</th><th>Acciones</th></tr></thead><tbody>${rows || `<tr><td colspan="4">Sin trabajadores.</td></tr>`}</tbody></table></div></div>`;
        }
        if (id === 'profile-view') {
            const u = appState.userData || {};
            html = `<div class="content-view"><h2>Mi Perfil</h2><div class="form-grid"><div class="card"><h2>Datos Personales</h2><form id="profile-personal-form"><div class="form-grid" style="gap: 12px; margin-bottom: 12px;"><div><label for="profile-name">Nombre</label><input id="profile-name" value="${u.ownerName || ''}"></div><div><label for="profile-phone">Teléfono</label><input id="profile-phone" type="tel" value="${u.phone || ''}"></div></div><label for="profile-email">Correo (no se puede cambiar)</label><input id="profile-email" type="email" value="${u.ownerEmail || ''}" disabled><button type="submit" style="margin-top: 16px;">Guardar Datos Personales</button></form></div><div class="card"><h2>Datos del Negocio</h2><form id="profile-business-form"><div style="margin-bottom: 12px;"><label for="profile-business-name">Nombre del Negocio</label><input id="profile-business-name" value="${u.businessName || ''}"></div><div style="margin-bottom: 12px;"><label for="profile-business-type">Tipo de Negocio</label><select id="profile-business-type"><option value="bar" ${u.businessType === 'bar' ? 'selected' : ''}>Bar</option><option value="discoteca" ${u.businessType === 'discoteca' ? 'selected' : ''}>Discoteca</option><option value="cafeteria" ${u.businessType === 'cafeteria' ? 'selected' : ''}>Cafetería</option><option value="restaurante" ${u.businessType === 'restaurante' ? 'selected' : ''}>Restaurante</option></select></div><button type="submit" style="margin-top: 16px;">Guardar Datos del Negocio</button></form></div></div><div class="card" style="margin-top: 24px;"><h2>Licencia</h2><p><strong>Tipo de plan:</strong> PRO</p><p><strong>Estado:</strong> Activa</p><p style="color: var(--text-secondary);">Esta sección se habilitará en futuras actualizaciones.</p></div></div>`;
        }
        if (id === 'shifts-view') {
            if (appState.selectedShiftId) {
                const shift = appState.activeShifts.find(s => s.id === appState.selectedShiftId);
                if (!shift) { appState.selectedShiftId = null; return renderView('shifts-view'); }
                const worker = appState.workers.find(w => w.id === shift.workerId);
                const ingresos = shift.sales.reduce((s, x) => s + x.totalVenta, 0);
                const comisiones = shift.sales.reduce((s, x) => s + (x.totalComision || 0), 0);
                const prestamos = shift.loans.reduce((s, l) => s + l.valor, 0);
                const fichaProducts = appState.products.filter(p => p.esFicha);
                const fichaCardsHTML = fichaProducts.map(ficha => {
                    const stock = appState.inventory[ficha.id]?.barra?.unidades ?? 0;
                    return `<div class="ficha-card" data-product-id="${ficha.id}"><h4>${ficha.nombre}</h4><div class="ficha-card-stock">${stock} <span>uds.</span></div></div>`;
                }).join("");
                html = `<div class="content-view">
                    <button id="back-to-shifts-list" class="button-secondary" style="margin-bottom: 24px;">&larr; Volver a la lista de turnos</button>
                    <h2>Gestionando Turno: <span style="color: var(--brand-primary);">${worker?.nombre || "…"}</span></h2>
                    <h3 style="margin-top: 24px;">Vender Fichas</h3>
                    <div id="fichas-grid">${fichaCardsHTML || "<p>No hay fichas activas configuradas.</p>"}</div>
                    <div class="card" style="margin-top:24px">
                        <h4>Resumen del Turno</h4>
                        <p><strong>Ingresos (Ventas):</strong> ${COP(ingresos)}</p>
                        <p><strong>Total para Pago (Comisiones):</strong> ${COP(comisiones)}</p>
                        <p><strong>Préstamos:</strong> ${COP(prestamos)}</p>
                        <hr style="border: none; border-top: 1px solid var(--border-color); margin: 16px 0;">
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <button id="open-loan-modal-btn" class="button-secondary">Registrar Préstamo</button>
                            <button id="close-shift-btn" data-shift-id="${shift.id}" style="background: var(--accent-red); flex-grow: 1;">Cerrar y Liquidar Turno</button>
                        </div>
                    </div>
                </div>`;
            } else {
                const workerOpts = appState.workers.filter(w => w.activo && !appState.activeShifts.some(s => s.workerId === w.id)).map(w => `<option value="${w.id}">${w.nombre}</option>`).join("");
                const activeShiftsHTML = appState.activeShifts.map(shift => {
                    const worker = appState.workers.find(w => w.id === shift.workerId);
                    return `<div class="active-shift-item">
                        <div class="active-shift-item-info"><strong>${worker?.nombre || 'Desconocido'}</strong><span>Inició: ${fmtDate(shift.inicio)}</span></div>
                        <div class="active-shift-item-actions">
                            <button class="btn-view-desglose button-secondary" data-shift-id="${shift.id}">Ver Desglose</button>
                            <button class="btn-manage-shift" data-shift-id="${shift.id}">Gestionar</button>
                        </div>
                    </div>`;
                }).join("");
                html = `<div class="content-view">
                    <h2>Turnos y Ventas</h2>
                    <div class="card"><h3>Iniciar Nuevo Turno</h3><form id="open-shift-form"><select id="shift-worker" required style="margin-bottom: 12px;"><option value="">Seleccionar trabajador…</option>${workerOpts}</select><button type="submit">Iniciar Turno</button></form></div>
                    <h3 style="margin: 24px 0 12px 0;">Turnos Activos (${appState.activeShifts.length})</h3>
                    <div class="active-shifts-list">${activeShiftsHTML || "<p>No hay turnos activos en este momento.</p>"}</div>
                </div>`;
            }
        }
        if (html) { 
            content.innerHTML = html; 
            attachHandlers(id); 
            renderNotifications();
        }
    }
    
    function attachPersistentHandlers() {
        const fichaSaleForm = document.getElementById("ficha-sale-form");
        if(fichaSaleForm) fichaSaleForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const modal = document.getElementById("ficha-sale-modal");
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            const productId = document.getElementById("ficha-sale-product-id").value;
            const unidades = parseInt(document.getElementById("ficha-sale-quantity").value);
            
            if (isNaN(unidades) || unidades <= 0) { 
                showToast("Cantidad inválida", "error"); 
                btn.disabled = false; 
                return; 
            }

            try {
                await runTransaction(db, async (t) => {
                    const productRef = doc(colref.products, productId);
                    const barraRef = stockRef(productId, "barra");
                    const ventaRef = doc(TCOL("shifts", appState.selectedShiftId, "sales"));
                    
                    const productDoc = await t.get(productRef);
                    const stockSnap = await t.get(barraRef);

                    if (!productDoc.exists()) throw new Error("El producto ya no existe.");
                    
                    const prod = productDoc.data();
                    const currentStock = stockSnap.data()?.unidades || 0;
                    
                    if (currentStock < unidades) throw new Error(`Stock insuficiente para ${prod.nombre}. Solo hay ${currentStock}.`); 
                    
                    t.set(barraRef, { tenantId: tenantId(), unidades: increment(-unidades) }, { merge: true });
                    t.set(ventaRef, {
                        type: 'ficha', productId: productId, unidades: unidades,
                        totalVenta: unidades * (prod.precioVenta || 0), totalComision: unidades * (prod.precioComision || 0),
                        fecha: serverTimestamp(), tenantId: tenantId()
                    });

                    if (prod.providerPorVentasId) {
                        const costoVenta = unidades * (prod.precioCompra || 0);
                        if (costoVenta > 0) t.update(doc(colref.providers, prod.providerPorVentasId), { saldoPendiente: increment(costoVenta) });
                    }
                });
                
                const currentShift = appState.activeShifts.find(s => s.id === appState.selectedShiftId);
                const worker = appState.workers.find(w => w.id === currentShift?.workerId);
                const prod = appState.products.find(p => p.id === productId);
                await createNotification(`Venta de ${unidades} x ${prod.nombre} por ${worker?.nombre || 'Desconocido'}.`, 'sale');
                await checkAndNotifyLowStock(productId);
                showToast("Venta registrada");
                modal.classList.remove("visible");

            } catch(err) { showToast(err.message, "error"); } finally { btn.disabled = false; }
        });

        const loanForm = document.getElementById("loan-form");
        if (loanForm) loanForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            if (!appState.selectedShiftId) return;
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            
            const valor = parseFloat(document.getElementById("loan-value").value);
            const desc = document.getElementById("loan-description").value;
            if (isNaN(valor) || !desc) { btn.disabled = false; return; }

            try {
                await addDoc(TCOL("shifts", appState.selectedShiftId, "loans"), { descripcion: desc, valor, fecha: serverTimestamp() });
                const currentShift = appState.activeShifts.find(s => s.id === appState.selectedShiftId);
                const worker = appState.workers.find(w => w.id === currentShift?.workerId);
                await createNotification(`${worker?.nombre || 'Alguien'} ha registrado un préstamo.`, 'loan');
                loanForm.reset();
                document.getElementById("loan-modal").classList.remove("visible");
            } catch(err) { showToast(err.message, "error"); } finally { btn.disabled = false; }
        });

        const notificationBell = document.getElementById('notification-bell');
        const notificationDropdown = document.getElementById('notification-dropdown');

        const toggleNotifications = async (e) => {
          e.stopPropagation();
          const isVisible = !notificationDropdown.classList.contains('hidden');
          
          if (isVisible) {
              notificationDropdown.classList.add('hidden');
              notificationDropdown.classList.remove('mobile-active');
          } else {
              notificationDropdown.classList.remove('hidden');
              if (window.innerWidth <= 768) notificationDropdown.classList.add('mobile-active');
              
              const unreadNotifs = appState.notifications.filter(n => !n.read);
              if (unreadNotifs.length > 0) {
                  const batch = writeBatch(db);
                  unreadNotifs.forEach(notif => batch.update(doc(colref.notifications, notif.id), { read: true }));
                  await batch.commit().catch(console.error);
              }
          }
        };

        notificationBell.addEventListener('click', toggleNotifications);
        document.addEventListener('click', (e) => {
            if (notificationDropdown.classList.contains('hidden')) return;
            if (!notificationBell.contains(e.target) && !notificationDropdown.contains(e.target)) {
                notificationDropdown.classList.add('hidden');
                notificationDropdown.classList.remove('mobile-active');
            }
        });
    }

    async function createNotification(message, type = 'info') {
        try {
            await addDoc(colref.notifications, {
                message: message, timestamp: serverTimestamp(), read: false, type: type
            });
        } catch (error) { console.error("Error creating notification:", error); }
    }

    async function checkAndNotifyLowStock(productId) {
        const LOW_STOCK_THRESHOLD = 10;
        const stockData = appState.inventory[productId];
        const product = appState.products.find(p => p.id === productId);
        if (!stockData || !product) return;

        const totalStock = (stockData.barra?.unidades || 0);
        const existingNotif = appState.notifications.find(n => !n.read && n.message.includes(product.nombre) && n.message.includes("Stock bajo"));
        if (totalStock <= LOW_STOCK_THRESHOLD && !existingNotif) {
            await createNotification(`Stock bajo: ${product.nombre} solo tiene ${totalStock} unidades en barra.`, 'stock');
        }
    }

    function renderNotifications() {
        const counter = document.getElementById('notification-counter');
        const list = document.getElementById('notification-list');
        if (!counter || !list) return;

        const unreadCount = appState.notifications.filter(n => !n.read).length;
        counter.textContent = unreadCount;
        counter.classList.toggle('hidden', unreadCount === 0);

        if (appState.notifications.length === 0) {
            list.innerHTML = `<div class="notification-item" style="justify-content: center; padding: 20px;"><p style="color: var(--text-secondary);">No hay notificaciones.</p></div>`;
            return;
        }

        const ICONS_NOTIF = {
            sale: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="2" x2="12" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`,
            purchase: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>`,
            stock: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>`,
            shift: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
            loan: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="21" x2="8" y2="3"/><line x1="3" y1="16" x2="13" y2="16"/><line x1="3" y1="8" x2="13" y2="8"/></svg>`
        };

        list.innerHTML = appState.notifications.map(n => {
            const icon = ICONS_NOTIF[n.type] || ICONS_NOTIF['sale'];
            return `<div class="notification-item ${n.read ? '' : 'unread'}"><div class="notification-icon">${icon}</div><div class="notification-content"><p>${n.message}</p><span>${fmtDate(n.timestamp)}</span></div></div>`;
        }).join('');
    }

    // =================================================================================
    // INICIO DE LA SECCIÓN DE REPORTES REESCRITA (LÍNEA POR LÍNEA)
    // =================================================================================
    
    async function generateReportData() {
        // 1. PREPARAR UI: Mostrar cargador, ocultar resultados previos y limpiar caché.
        // Esto asegura una experiencia limpia y clara para el usuario en cada ejecución.
        const loader = document.getElementById('report-loader');
        const dataContainer = document.getElementById('report-data-container');
        const emptyState = document.getElementById('report-empty-state');
        const pdfBtn = document.getElementById('generate-pdf-btn');

        loader.classList.remove('hidden');
        dataContainer.classList.add('hidden');
        emptyState.classList.add('hidden');
        pdfBtn.disabled = true;
        appState.reportCache = null;

        try {
            // 2. VALIDAR FECHAS: Asegurarse de tener un rango válido antes de consultar la base de datos.
            const startDateValue = document.getElementById('report-start-date').value;
            const endDateValue = document.getElementById('report-end-date').value;
            if (!startDateValue || !endDateValue) throw new Error("Las fechas de inicio y fin son requeridas.");
            
            const startDate = new Date(startDateValue);
            const endDate = new Date(endDateValue);
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime()) || startDate > endDate) throw new Error("Rango de fechas inválido.");

            // 3. CONSULTAS A FIREBASE: Obtener todos los datos necesarios de forma paralela para mayor eficiencia.
            const shiftsQuery = query(colref.shifts, where("estado", "==", "cerrado"), where("fin", ">=", Timestamp.fromDate(startDate)), where("fin", "<=", Timestamp.fromDate(endDate)));
            const cashflowQuery = query(colref.cashflow, where("date", ">=", Timestamp.fromDate(startDate)), where("date", "<=", Timestamp.fromDate(endDate)));
            
            const [shiftsSnapshot, cashflowSnapshot] = await Promise.all([getDocs(shiftsQuery), getDocs(cashflowQuery)]);
            const closedShifts = shiftsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            const cashflowEntries = cashflowSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));

            // 4. VERIFICAR DATOS: Si no hay absolutamente nada, mostrar el estado vacío y detener.
            if (closedShifts.length === 0 && cashflowEntries.length === 0) {
                emptyState.classList.remove('hidden');
                loader.classList.add('hidden');
                return;
            }

            // 5. OBTENER DETALLES DE VENTAS: Necesario para el Costo de Mercancía y los detalles del PDF.
            let allSales = [];
            const salesPromises = closedShifts.map(shift => getDocs(TCOL('shifts', shift.id, 'sales')));
            const salesSnapshots = await Promise.all(salesPromises);
            salesSnapshots.forEach(snapshot => snapshot.forEach(saleDoc => allSales.push({ id: saleDoc.id, ...saleDoc.data() })));
            
            // 6. CÁLCULOS ROBUSTOS (LÍNEA POR LÍNEA)
            // 6a. Ganancia Bruta: Se obtiene de los totales ya guardados en cada turno cerrado. Es rápido y eficiente.
            const gananciaBruta = closedShifts.reduce((sum, shift) => sum + (shift.totalIngresos || 0), 0);
            
            // 6b. Unidades Vendidas: Suma de unidades de todas las ventas individuales.
            const unidadesVendidas = allSales.reduce((sum, sale) => sum + (sale.unidades || 0), 0);

            // 6c. Costo de Mercancía Vendida (CMV): Se calcula de forma segura, verificando que el producto exista.
            const costoMercanciaVendida = allSales.reduce((sum, sale) => {
                const product = appState.products.find(p => p.id === sale.productId);
                return product ? sum + (sale.unidades * (product.precioCompra || 0)) : sum;
            }, 0);

            // 6d. Pago a Trabajadores: Total pagado en las liquidaciones de los turnos.
            const pagoTrabajadores = closedShifts.reduce((sum, shift) => sum + (shift.totalPagado || 0), 0);

            // 6e. Otros Egresos: Movimientos de caja manuales, excluyendo pagos de turnos para no duplicar costos.
            const otrosEgresos = cashflowEntries
                .filter(cf => cf.type === 'egreso' && (cf.manual === true || !cf.description?.toLowerCase().includes('liquidación')))
                .reduce((sum, entry) => sum + entry.amount, 0);

            // 6f. Costos Totales: La suma de todos los costos.
            const costosTotales = costoMercanciaVendida + pagoTrabajadores + otrosEgresos;

            // 6g. Ganancia Neta: El resultado final.
            const gananciaNeta = gananciaBruta - costosTotales;

            // 7. ACTUALIZAR UI: Mostrar los resultados calculados en las tarjetas.
            document.getElementById('report-ganancia-bruta').textContent = COP(gananciaBruta);
            document.getElementById('report-costos-totales').textContent = COP(-costosTotales);
            document.getElementById('report-ganancia-neta').textContent = COP(gananciaNeta);
            document.getElementById('report-ganancia-neta').className = gananciaNeta >= 0 ? 'amount-positive' : 'amount-negative';
            document.getElementById('report-unidades').textContent = unidadesVendidas;

            // 8. ALMACENAR EN CACHÉ Y RENDERIZAR GRÁFICOS
            appState.reportCache = {
                gananciaBruta, costosTotales, gananciaNeta, costoMercanciaVendida, pagoTrabajadores, otrosEgresos,
                allSales, cashflowEntries, closedShifts, startDate, endDate
            };
            
            renderBarChart(allSales);
            renderDonutChart(allSales);
            
            // 9. FINALIZAR: Mostrar el contenedor de datos y habilitar el botón de PDF.
            dataContainer.classList.remove('hidden');
            pdfBtn.disabled = false;

        } catch (error) {
            // MANEJO DE ERRORES: Si algo falla, se muestra un mensaje claro.
            console.error("Error fatal al generar el reporte:", error);
            showToast(`Error fatal: ${error.message}`, "error");
            emptyState.classList.remove('hidden');
            emptyState.querySelector('h3').textContent = 'Ocurrió un Error';
            emptyState.querySelector('p').textContent = 'No se pudo cargar el reporte. Revisa la consola para más detalles.';
        } finally {
            // SIEMPRE se oculta el cargador al final, ya sea con éxito o con error.
            loader.classList.add('hidden');
        }
    }

    function attachHandlersReports() {
        const startDateInput = document.getElementById('report-start-date');
        const endDateInput = document.getElementById('report-end-date');
        const presets = document.getElementById('date-presets');
        
        const setDatesAndRun = (start, end, activePreset) => {
            start.setHours(0, 0, 0, 0);
            end.setHours(23, 59, 59, 999);
            startDateInput.value = start.toISOString().slice(0, 16);
            endDateInput.value = end.toISOString().slice(0, 16);
            
            document.querySelectorAll('#date-presets button').forEach(b => b.classList.remove('active'));
            if(activePreset) activePreset.classList.add('active');

            generateReportData();
        };
        
        presets.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') return;
            const range = e.target.dataset.range;
            const now = new Date();
            let start = new Date();
            
            if (range === 'today')     setDatesAndRun(start, new Date(), e.target);
            else if (range === 'yesterday') {
                start.setDate(now.getDate() - 1);
                setDatesAndRun(new Date(start), new Date(start), e.target);
            } else if (range === 'week') {
                start.setDate(now.getDate() - 6);
                setDatesAndRun(start, new Date(), e.target);
            } else if (range === 'month') {
                start = new Date(now.getFullYear(), now.getMonth(), 1);
                setDatesAndRun(start, new Date(), e.target);
            }
        });

        startDateInput.addEventListener('change', generateReportData);
        endDateInput.addEventListener('change', generateReportData);
        window.addEventListener('resize', () => { if(appState.reportCache) { renderBarChart(appState.reportCache.allSales); renderDonutChart(appState.reportCache.allSales); }});

        document.getElementById('generate-pdf-btn').addEventListener('click', async () => {
            const btn = document.getElementById('generate-pdf-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'Generando...';

            try {
                if (!appState.reportCache) throw new Error("Los datos del reporte no están disponibles.");
                if (!window.jspdf || !window.html2canvas) throw new Error("Librerías PDF no cargadas.");

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const {
                    gananciaBruta, costosTotales, gananciaNeta, costoMercanciaVendida, pagoTrabajadores, otrosEgresos,
                    startDate, endDate, allSales, cashflowEntries
                } = appState.reportCache;

                const barChartCanvas = await html2canvas(document.getElementById('bar-chart-container'), {backgroundColor: null});
                const donutChartCanvas = await html2canvas(document.getElementById('donut-chart-container'), {backgroundColor: null});
                const barChartImg = barChartCanvas.toDataURL('image/png');
                const donutChartImg = donutChartCanvas.toDataURL('image/png');

                doc.setFontSize(20);
                doc.text(`Reporte Financiero - ${appState.userData.businessName || 'seb365 pro'}`, 14, 22);
                doc.setFontSize(11);
                doc.setTextColor(100);
                doc.text(`Periodo: ${fmtDateShort(startDate)} - ${fmtDateShort(endDate)}`, 14, 30);

                doc.autoTable({
                    startY: 40, theme: 'grid', headStyles: { fillColor: [48, 49, 52] },
                    head: [['Concepto', 'Valor']],
                    body: [
                        [{ content: 'RESUMEN DE INGRESOS', colSpan: 2, styles: { halign: 'center', fillColor: [230, 247, 237] }}],
                        ['(+) Ganancia Bruta (Ventas)', { content: COP(gananciaBruta), styles: { halign: 'right' }}],
                        [{ content: 'RESUMEN DE COSTOS Y GASTOS', colSpan: 2, styles: { halign: 'center', fillColor: [255, 237, 237] }}],
                        ['(-) Costo de Mercancía Vendida', { content: COP(-costoMercanciaVendida), styles: { halign: 'right' }}],
                        ['(-) Pago a Trabajadores', { content: COP(-pagoTrabajadores), styles: { halign: 'right' }}],
                        ['(-) Otros Egresos (Caja)', { content: COP(-otrosEgresos), styles: { halign: 'right' }}],
                        ['(=) Costos Totales', { content: COP(-costosTotales), styles: { halign: 'right', fontStyle: 'bold' }}],
                        [{ content: 'RESULTADO DEL PERIODO', colSpan: 2, styles: { halign: 'center', fillColor: [224, 236, 255] }}],
                        ['Ganancia / Pérdida Neta', { content: COP(gananciaNeta), styles: { halign: 'right', fontStyle: 'bold', textColor: gananciaNeta >= 0 ? [30, 142, 62] : [217, 48, 37] }}],
                    ],
                });
                
                doc.addPage();
                doc.setFontSize(16);
                doc.text('Estadísticas Visuales', 14, 20);
                doc.addImage(barChartImg, 'PNG', 14, 30, 180, 90);
                doc.addImage(donutChartImg, 'PNG', 14, 130, 180, 90);

                if (allSales.length > 0) {
                    doc.addPage();
                    doc.setFontSize(16);
                    doc.text('Detalle de Ventas', 14, 20);
                    doc.autoTable({
                        startY: 30, theme: 'striped', headStyles: { fillColor: [48, 49, 52] },
                        head: [['Fecha', 'Producto', 'Cant.', 'Total Venta', 'Comisión']],
                        body: allSales.map(s => [fmtDate(s.fecha), appState.products.find(p => p.id === s.productId)?.nombre || 'N/A', s.unidades, COP(s.totalVenta), COP(s.totalComision || 0)]),
                    });
                }
                
                const egresos = cashflowEntries.filter(cf => cf.type === 'egreso');
                if (egresos.length > 0) {
                    doc.addPage();
                    doc.setFontSize(16);
                    doc.text('Detalle de Movimientos de Caja (Egresos)', 14, 20);
                    doc.autoTable({
                        startY: 30, theme: 'striped', headStyles: { fillColor: [48, 49, 52] },
                        head: [['Fecha', 'Descripción Egreso', 'Monto']],
                        body: egresos.map(e => [fmtDate(e.date), e.description, COP(e.amount)]),
                    });
                }
                
                doc.save(`Reporte_${fmtDateShort(new Date())}.pdf`);
                showToast("PDF generado exitosamente", "success");

            } catch (error) {
                showToast(`Error al generar PDF: ${error.message}`, 'error');
                console.error("PDF generation error:", error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        presets.querySelector('button[data-range="today"]').click();
    }
    // =================================================================================
    // FIN DE LA SECCIÓN DE REPORTES REESCRITA
    // =================================================================================


    // --- Funciones para Gráficos D3 ---
    function renderBarChart(salesData) {
        const container = d3.select("#bar-chart-container");
        container.selectAll("*").remove(); 

        if (salesData.length === 0) {
            container.append("p").style("color", "var(--text-secondary)").style("text-align", "center").style("padding-top", "50px").text("No hay datos para mostrar.");
            return;
        }

        const dailyData = d3.rollups(salesData, v => d3.sum(v, d => d.totalVenta), d => d.fecha.toDate().setHours(0,0,0,0))
            .map(([key, value]) => ({ date: new Date(key), total: value }))
            .sort((a,b) => a.date - b.date);

        const margin = {top: 20, right: 20, bottom: 40, left: 60};
        const width = container.node().getBoundingClientRect().width - margin.left - margin.right;
        const height = 300 - margin.top - margin.bottom;

        const svg = container.append("svg").attr("width", width + margin.left + margin.right).attr("height", height + margin.top + margin.bottom)
            .append("g").attr("transform", `translate(${margin.left},${margin.top})`);
            
        svg.append("defs").html(`<linearGradient id="barGradient" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="var(--grad-red)" /><stop offset="50%" stop-color="var(--grad-orange)" /><stop offset="100%" stop-color="var(--grad-yellow)" /></linearGradient>`);

        const x = d3.scaleBand().domain(dailyData.map(d => d.date)).range([0, width]).padding(0.2);
        const y = d3.scaleLinear().domain([0, d3.max(dailyData, d => d.total) * 1.1]).range([height, 0]);
            
        svg.append("g").attr("class", "axis").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x).tickFormat(d3.timeFormat("%d %b")));
        svg.append("g").attr("class", "axis").call(d3.axisLeft(y).ticks(5).tickFormat(d => `${d/1000}k`));
        const tooltip = d3.select("body").selectAll(".d3-tooltip").data([null]).join("div").attr("class", "d3-tooltip");

        svg.selectAll(".bar").data(dailyData).enter().append("rect")
            .attr("class", "bar").attr("x", d => x(d.date)).attr("y", d => y(d.total))
            .attr("width", x.bandwidth()).attr("height", d => height - y(d.total))
            .attr("rx", 2).attr("fill", "url(#barGradient)")
            .on("mouseover", (event, d) => {
                tooltip.transition().style("opacity", .9);
                tooltip.html(`<strong>${d3.timeFormat("%a, %d %b")(d.date)}</strong><br/>${COP(d.total)}`)
                    .style("left", (event.pageX + 5) + "px").style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", () => tooltip.transition().style("opacity", 0));
    }

    function renderDonutChart(salesData) {
        const container = d3.select("#donut-chart-container");
        container.selectAll("*").remove();

        if (salesData.length === 0) {
            container.append("p").style("color", "var(--text-secondary)").style("text-align", "center").style("padding-top", "50px").text("Sin datos.");
            return;
        }

        const productData = d3.rollups(salesData, v => d3.sum(v, d => d.unidades), d => d.productId)
            .map(([key, value]) => ({
                productId: key,
                name: appState.products.find(p => p.id === key)?.nombre || 'Desconocido',
                units: value
            }))
            .sort((a,b) => b.units - a.units).slice(0, 5);

        const width = container.node().getBoundingClientRect().width;
        const height = 300;
        const radius = Math.min(width, height) / 2 - 20;
        
        const svg = container.append("svg").attr("width", width).attr("height", height)
            .append("g").attr("transform", `translate(${width / 2},${height / 2})`);

        const color = d3.scaleOrdinal().domain(productData.map(d => d.productId)).range(d3.schemeTableau10.map(c => d3.color(c).brighter(0.2)));
        const pie = d3.pie().value(d => d.units).sort(null);
        const data_ready = pie(productData);
        const arc = d3.arc().innerRadius(radius * 0.5).outerRadius(radius * 0.8);
        const outerArc = d3.arc().innerRadius(radius * 0.9).outerRadius(radius * 0.9);
        const tooltip = d3.select("body").selectAll(".d3-tooltip").data([null]).join("div").attr("class", "d3-tooltip");
        
        svg.selectAll('path.slice').data(data_ready).enter().append('path').attr('class', 'slice')
            .attr('d', arc).attr('fill', d => color(d.data.productId))
            .attr("stroke", "var(--bg-primary)").style("stroke-width", "2px")
            .on("mouseover", (event, d) => {
                tooltip.transition().style("opacity", .9);
                tooltip.html(`<strong>${d.data.name}</strong><br/>${d.data.units} unidades`)
                    .style("left", (event.pageX + 5) + "px").style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", () => tooltip.transition().style("opacity", 0));
        
        svg.selectAll('polyline.label-line').data(data_ready).enter().append('polyline').attr('class', 'label-line')
            .attr("stroke", "var(--text-secondary)").style("fill", "none").attr("stroke-width", 1)
            .attr('points', d => {
                const posA = arc.centroid(d), posB = outerArc.centroid(d), posC = outerArc.centroid(d);
                const midangle = d.startAngle + (d.endAngle - d.startAngle) / 2;
                posC[0] = radius * 0.95 * (midangle < Math.PI ? 1 : -1);
                return [posA, posB, posC]
            });

        svg.selectAll('text.label-text').data(data_ready).enter().append('text').attr('class', 'label-text')
            .text(d => d.data.name)
            .attr('transform', d => {
                const pos = outerArc.centroid(d);
                const midangle = d.startAngle + (d.endAngle - d.startAngle) / 2;
                pos[0] = radius * 0.99 * (midangle < Math.PI ? 1 : -1);
                return `translate(${pos})`;
            })
            .style('text-anchor', d => (d.startAngle + (d.endAngle - d.startAngle) / 2 < Math.PI ? 'start' : 'end'))
            .style('fill', 'var(--text-primary)').style('font-size', '12px');
    }

    function attachHandlers(id){
        if (id === 'reports-view') {
            attachHandlersReports(); // Llama a la nueva función de handlers para reportes
        }
        if (id === 'products-view') {
            content.querySelectorAll(".btn-edit").forEach(b => b.addEventListener("click", () => {
                const p = appState.products.find(x => x.id === b.dataset.id); if (!p) return;
                document.getElementById("product-id").value = p.id;
                document.getElementById("product-nombre").value = p.nombre || "";
                document.getElementById("product-precioVenta").value = p.precioVenta || 0;
                document.getElementById("product-precioCompra").value = p.precioCompra || 0;
                document.getElementById("product-precioComision").value = p.precioComision || 0;
                document.getElementById("product-unidadesPorCaja").value = p.unidadesPorCaja || 1;
                document.getElementById("product-unidadesPorCanasta").value = p.unidadesPorCanasta || 1;
                document.getElementById("product-esFicha").checked = !!p.esFicha;
                document.getElementById("product-providerPorVentas").value = p.providerPorVentasId || "";
            }));
            const form = document.getElementById("product-form");
            if (form) form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const btn = form.querySelector('button[type="submit"]'); btn.disabled = true;
                const id = document.getElementById("product-id").value;
                const data = {
                    nombre: document.getElementById("product-nombre").value,
                    precioVenta: parseFloat(document.getElementById("product-precioVenta").value),
                    precioCompra: parseFloat(document.getElementById("product-precioCompra").value),
                    precioComision: parseFloat(document.getElementById("product-precioComision").value) || 0,
                    unidadesPorCaja: parseInt(document.getElementById("product-unidadesPorCaja").value) || 1,
                    unidadesPorCanasta: parseInt(document.getElementById("product-unidadesPorCanasta").value) || 1,
                    esFicha: document.getElementById("product-esFicha").checked,
                    providerPorVentasId: document.getElementById("product-providerPorVentas").value || null,
                    activo: true
                };
                try {
                    if (id) {
                        await setDoc(doc(colref.products, id), data, { merge: true });
                    } else {
                        const ref = await addDoc(colref.products, data);
                        const b = writeBatch(db);
                        b.set(stockRef(ref.id, "bodega"), { tenantId: tenantId(), unidades: 0 }, { merge: true });
                        b.set(stockRef(ref.id, "barra"), { tenantId: tenantId(), unidades: 0 }, { merge: true });
                        await b.commit();
                    }
                    showToast("Guardado correctamente");
                    form.reset(); document.getElementById("product-id").value = "";
                } catch (err) { showToast(err.message, "error"); } finally { btn.disabled = false; }
            });
        }
        if(id === 'inventory-view') {
            const purchaseProviderSelect = document.getElementById("purchase-provider");
            if (purchaseProviderSelect) {
                purchaseProviderSelect.addEventListener('change', (e) => {
                    const providerId = e.target.value;
                    const displayDiv = document.getElementById('provider-payment-type-display');
                    const strongEl = displayDiv.querySelector('strong');
                    if (!providerId) { displayDiv.style.display = 'none'; return; }
                    const provider = appState.providers.find(p => p.id === providerId);
                    if (provider) {
                        let tipoPagoText = 'Contado';
                        if (provider.tipoPago === 'consignacion') tipoPagoText = 'Consignación';
                        if (provider.tipoPago === 'porVentas') tipoPagoText = 'Por Ventas';
                        strongEl.textContent = tipoPagoText;
                        displayDiv.style.display = 'block';
                    } else { displayDiv.style.display = 'none'; }
                });
            }
            const purchaseForm = document.getElementById("purchase-form");
            if (purchaseForm) purchaseForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const btn = purchaseForm.querySelector('button[type="submit"]'); btn.disabled = true;
                const providerId = document.getElementById("purchase-provider").value;
                const productId = document.getElementById("purchase-product").value;
                const cantidad = parseInt(document.getElementById("purchase-quantity").value);
                const unit = document.getElementById("purchase-unit").value;
                const prod = appState.products.find(p => p.id === productId);
                const provider = appState.providers.find(p => p.id === providerId);
                if (!prod || !provider || isNaN(cantidad) || cantidad <= 0) { showToast("Datos de compra inválidos", "error"); btn.disabled = false; return; }
                try {
                    const unidades = toUnidades(cantidad, unit, prod);
                    const costo = unidades * (prod.precioCompra || 0);
                    await runTransaction(db, async (t) => {
                        t.update(stockRef(productId, "bodega"), { unidades: increment(unidades) });
                        t.set(doc(colref.purchases), { providerId, productId, fecha: serverTimestamp(), cantidadUnidades: unidades, costoTotal: costo });
                        if (provider.tipoPago === "consignacion") {
                            t.update(doc(colref.providers, providerId), { saldoPendiente: increment(costo) });
                        } else if (provider.tipoPago === "contado" && costo > 0) {
                            t.set(doc(colref.cashflow), { type: "egreso", amount: costo, description: `Compra contado: ${unidades} x ${prod.nombre}`, date: serverTimestamp() });
                        }
                    });
                    await createNotification(`Compra de ${unidades} x ${prod.nombre} a ${provider.nombre}.`, 'purchase');
                    showToast("Compra registrada exitosamente");
                    purchaseForm.reset();
                } catch (err) { showToast(`Error en la compra: ${err.message}`, "error"); } finally { btn.disabled = false; }
            });
            const transferForm = document.getElementById("transfer-form");
            if (transferForm) transferForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const btn = transferForm.querySelector('button[type="submit"]'); btn.disabled = true;
                const productId = document.getElementById("transfer-product").value;
                const cantidad = parseInt(document.getElementById("transfer-quantity").value);
                const unit = document.getElementById("transfer-unit").value;
                const prod = appState.products.find(p => p.id === productId);
                if (!prod || isNaN(cantidad) || cantidad <= 0) { showToast("Datos de traslado inválidos", "error"); btn.disabled = false; return; }
                const unidades = toUnidades(cantidad, unit, prod);
                try {
                    await runTransaction(db, async (t) => {
                        const bodegaRef = stockRef(productId, "bodega");
                        const bodegaSnap = await t.get(bodegaRef);
                        const currentBodegaStock = bodegaSnap.data()?.unidades || 0;
                        if (currentBodegaStock < unidades) throw new Error("Stock insuficiente en bodega.");
                        t.update(bodegaRef, { unidades: increment(-unidades) });
                        t.update(stockRef(productId, "barra"), { unidades: increment(unidades) });
                    });
                    await checkAndNotifyLowStock(productId);
                    showToast("Traslado exitoso");
                    transferForm.reset();
                } catch (err) { showToast(`Error en traslado: ${err.message}`, "error"); } finally { btn.disabled = false; }
            });
        }
        if(id === 'cashflow-view') {
            const form = document.getElementById("cashflow-form");
            if (form) form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const btn = form.querySelector('button[type="submit"]'); btn.disabled = true;
                const data = {
                    type: document.getElementById("cashflow-type").value, amount: parseFloat(document.getElementById("cashflow-amount").value),
                    description: document.getElementById("cashflow-description").value, date: serverTimestamp(), manual: true, userId: appState.user.uid
                };
                try {
                    await addDoc(colref.cashflow, data);
                    showToast("Movimiento registrado");
                    form.reset();
                } catch (err) { showToast(err.message, "error"); } finally { btn.disabled = false; }
            });
        }
        if (id === 'providers-view') {
            content.querySelectorAll(".btn-edit-provider").forEach(b => b.addEventListener("click", () => {
                const p = appState.providers.find(x => x.id === b.dataset.id); if (!p) return;
                document.getElementById("provider-id").value = p.id;
                document.getElementById("provider-nombre").value = p.nombre || "";
                document.getElementById("provider-contacto").value = p.contacto || "";
                document.getElementById("provider-tipoPago").value = p.tipoPago || 'contado';
            }));
            const form = document.getElementById("provider-form");
            if (form) form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const btn = form.querySelector('button[type="submit"]'); btn.disabled = true;
                const id = document.getElementById("provider-id").value;
                const data = { nombre: document.getElementById("provider-nombre").value, contacto: document.getElementById("provider-contacto").value, tipoPago: document.getElementById("provider-tipoPago").value };
                try {
                    if (id) await setDoc(doc(colref.providers, id), data, { merge: true });
                    else await addDoc(colref.providers, { ...data, saldoPendiente: 0 });
                    showToast("Proveedor guardado");
                    form.reset(); document.getElementById("provider-id").value = "";
                } catch (err) { showToast(err.message, "error"); } finally { btn.disabled = false; }
            });
            content.querySelectorAll(".btn-settle").forEach(b => b.addEventListener("click", () => {
                const prov = appState.providers.find(x => x.id === b.dataset.id); if (!prov) return;
                if ((prov.saldoPendiente || 0) <= 0) { showToast("Proveedor sin saldo pendiente.", "error"); return; }
                document.getElementById("settlement-provider-name").textContent = prov.nombre;
                document.getElementById("settlement-provider-balance").textContent = COP(prov.saldoPendiente || 0);
                document.getElementById("settle-provider-btn").dataset.providerId = prov.id;
                document.getElementById("settlement-details").classList.remove("hidden");
            }));
            const settleBtn = document.getElementById("settle-provider-btn");
            if (settleBtn) settleBtn.addEventListener("click", async (e) => {
                const providerId = e.target.dataset.providerId;
                const prov = appState.providers.find(p => p.id === providerId); if (!prov) return;
                const batch = writeBatch(db);
                batch.set(doc(colref.cashflow), { type: "egreso", amount: prov.saldoPendiente, description: `Pago liquidación: ${prov.nombre}`, date: serverTimestamp() });
                batch.set(doc(colref.providers, providerId), { saldoPendiente: 0 }, { merge: true });
                try {
                    await batch.commit();
                    showToast("Liquidación realizada");
                    document.getElementById("settlement-details").classList.add("hidden");
                } catch (err) { showToast(err.message, "error"); }
            });
            content.querySelectorAll(".btn-view-sales-breakdown").forEach(b => b.addEventListener("click", async (e) => {
                const providerId = e.target.dataset.id;
                const provider = appState.providers.find(p => p.id === providerId); if (!provider) return;
                const modal = document.getElementById("sales-breakdown-modal"), modalTitle = document.getElementById("sales-breakdown-modal-title"), modalBody = document.getElementById("sales-breakdown-modal-body");
                modalTitle.textContent = `Desglose de ${provider.nombre}`;
                modalBody.innerHTML = `<p>Calculando reporte...</p>`;
                modal.classList.add("visible");
                try {
                    const associatedProducts = appState.products.filter(p => p.providerPorVentasId === providerId);
                    if (associatedProducts.length === 0) { modalBody.innerHTML = `<p>Este proveedor no está asociado a ningún producto.</p>`; return; }
                    const associatedProductIds = associatedProducts.map(p => p.id);
                    const purchasesQuery = query(colref.purchases, where("providerId", "==", providerId), where("productId", "in", associatedProductIds));
                    const purchasesSnapshot = await getDocs(purchasesQuery);
                    const purchasesByProduct = {};
                    purchasesSnapshot.docs.forEach(d => { const data = d.data(); purchasesByProduct[data.productId] = (purchasesByProduct[data.productId] || 0) + data.cantidadUnidades; });
                    const shiftsSnapshot = await getDocs(colref.shifts);
                    const salesByProduct = {};
                    for (const shiftDoc of shiftsSnapshot.docs) {
                        const salesQuery = query(TCOL('shifts', shiftDoc.id, 'sales'), where("productId", "in", associatedProductIds));
                        const salesSnapshot = await getDocs(salesQuery);
                        salesSnapshot.docs.forEach(d => { const data = d.data(); salesByProduct[data.productId] = (salesByProduct[data.productId] || 0) + data.unidades; });
                    }
                    let totalDebtGenerated = 0;
                    const tableRows = associatedProducts.map(p => {
                        const sold = salesByProduct[p.id] || 0;
                        const debt = sold * (p.precioCompra || 0);
                        totalDebtGenerated += debt;
                        return row([p.nombre, sold, COP(p.precioCompra || 0), COP(debt)]);
                    }).join('');
                    modalBody.innerHTML = `<div class="table-wrapper"><table><thead><tr><th>Producto</th><th>Vendido</th><th>Costo Unit.</th><th>Deuda Generada</th></tr></thead><tbody>${tableRows}</tbody></table></div>
                        <div style="margin-top: 20px; text-align: right; font-size: 1.1em;"><h4 style="margin-top: 10px; font-size: 1.2em;">Saldo Pendiente Actual: <span style="color: var(--brand-primary);">${COP(provider.saldoPendiente || 0)}</span></h4></div>`;
                } catch (error) { console.error("Error generating breakdown:", error); modalBody.innerHTML = `<p class="toast error">Error al generar el reporte: ${error.message}</p>`; }
            }));
        }
        if (id === 'workers-view') {
            content.querySelectorAll(".btn-edit-worker").forEach(b => b.addEventListener("click", () => {
                const worker = appState.workers.find(x => x.id === b.dataset.id); if (!worker) return;
                const form = document.getElementById("worker-form");
                form.querySelector("#worker-id").value = worker.id;
                form.querySelector("#worker-nombre").value = worker.nombre || "";
                form.querySelector("#worker-pagoBase").value = worker.pagoBase || 0;
                form.querySelector("#worker-activo").checked = worker.activo === true;
            }));
            const form = document.getElementById("worker-form");
            if (form) form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const btn = form.querySelector('button[type="submit"]'); btn.disabled = true;
                const workerId = document.getElementById("worker-id").value;
                const data = { nombre: document.getElementById("worker-nombre").value.trim(), pagoBase: parseFloat(document.getElementById("worker-pagoBase").value) || 0, activo: document.getElementById("worker-activo").checked };
                if (!data.nombre) { showToast("El nombre del trabajador es requerido.", "error"); btn.disabled = false; return; }
                try {
                    if (workerId) await setDoc(doc(colref.workers, workerId), data, { merge: true });
                    else await addDoc(colref.workers, { ...data, createdAt: serverTimestamp() });
                    showToast("Trabajador guardado correctamente.");
                    form.reset(); document.getElementById("worker-id").value = ""; document.getElementById("worker-activo").checked = true;
                } catch (err) { console.error("Error guardando trabajador:", err); showToast(`Error: ${err.message}`, "error"); } finally { btn.disabled = false; }
            });
        }
        if (id === 'profile-view') {
            const personalForm = document.getElementById("profile-personal-form");
            if (personalForm) personalForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true;
                try {
                    const tenantRef = doc(db, "tenants", appState.user.uid);
                    const newDisplayName = document.getElementById("profile-name").value, newPhone = document.getElementById("profile-phone").value;
                    await setDoc(tenantRef, { ownerName: newDisplayName, phone: newPhone }, { merge: true });
                    appState.userData.ownerName = newDisplayName; appState.userData.phone = newPhone;
                    showToast("Datos personales actualizados");
                } catch (err) { showToast(err.message, "error"); } finally { btn.disabled = false; }
            });
            const businessForm = document.getElementById("profile-business-form");
            if (businessForm) businessForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true;
                try {
                    const tenantRef = doc(db, "tenants", appState.user.uid);
                    const newBusinessName = document.getElementById("profile-business-name").value, newBusinessType = document.getElementById("profile-business-type").value;
                    await setDoc(tenantRef, { businessName: newBusinessName, businessType: newBusinessType }, { merge: true });
                    appState.userData.businessName = newBusinessName; appState.userData.businessType = newBusinessType;
                    showToast("Datos del negocio actualizados");
                } catch (err) { showToast(err.message, "error"); } finally { btn.disabled = false; }
            });
        }
        if(id === 'shifts-view') {
            if (appState.selectedShiftId) {
                document.getElementById("back-to-shifts-list")?.addEventListener("click", () => { appState.selectedShiftId = null; scheduleRender(); });
                document.getElementById("fichas-grid")?.addEventListener("click", (e) => {
                    const card = e.target.closest(".ficha-card"); if (!card) return;
                    const productId = card.dataset.productId, product = appState.products.find(p => p.id === productId), stock = appState.inventory[productId]?.barra?.unidades ?? 0;
                    const modal = document.getElementById("ficha-sale-modal");
                    modal.querySelector("#ficha-sale-modal-title").textContent = `Vender ${product.nombre}`;
                    modal.querySelector("#ficha-sale-product-id").value = productId;
                    modal.querySelector("#ficha-sale-stock").textContent = stock;
                    modal.querySelector("#ficha-sale-quantity").value = 1;
                    modal.classList.add("visible");
                });
                document.getElementById("open-loan-modal-btn")?.addEventListener("click", () => document.getElementById("loan-modal").classList.add("visible"));
                document.getElementById("close-shift-btn")?.addEventListener("click", async (e) => {
                    const btn = e.target;
                    const isConfirmed = btn.dataset.confirmed === 'true';
                    if (!isConfirmed) {
                        btn.dataset.originalText = btn.textContent; btn.textContent = '¿Confirmar Cierre?'; btn.style.background = 'var(--brand-secondary)'; btn.dataset.confirmed = 'true';
                        btn.dataset.timeoutId = setTimeout(() => { btn.textContent = btn.dataset.originalText; btn.style.background = ''; btn.dataset.confirmed = 'false'; }, 4000);
                        return;
                    }
                    clearTimeout(btn.dataset.timeoutId); btn.disabled = true;
                    const shiftId = btn.dataset.shiftId, shift = appState.activeShifts.find(s => s.id === shiftId); if (!shift) { btn.disabled = false; return; }
                    const worker = appState.workers.find(w => w.id === shift.workerId);
                    const ingresos = shift.sales.reduce((s, x) => s + x.totalVenta, 0), comisiones = shift.sales.reduce((s, x) => s + (x.totalComision || 0), 0), prestamos = shift.loans.reduce((s, l) => s + l.valor, 0);
                    const totalAPagar = (worker?.pagoBase || 0) + comisiones - prestamos;
                    try {
                        const batch = writeBatch(db);
                        batch.set(doc(colref.cashflow), { type: "ingreso", amount: ingresos, description: `Cierre turno ${worker?.nombre || ""}`, date: serverTimestamp() });
                        if (totalAPagar > 0) batch.set(doc(colref.cashflow), { type: "egreso", amount: totalAPagar, description: `Pago liquidación ${worker?.nombre || ""}`, date: serverTimestamp() });
                        batch.set(doc(colref.shifts, shift.id), { estado: "cerrado", fin: serverTimestamp(), totalIngresos: ingresos, totalComisiones: comisiones, totalPrestamos: prestamos, totalPagado: totalAPagar }, { merge: true });
                        await batch.commit();
                        appState.selectedShiftId = null;
                        showToast("Turno cerrado y liquidado");
                    } catch (err) { showToast(err.message, "error"); btn.textContent = btn.dataset.originalText; btn.style.background = ''; btn.dataset.confirmed = 'false'; btn.disabled = false; }
                });
            } else {
                document.getElementById("open-shift-form")?.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const workerId = document.getElementById("shift-worker").value; if (!workerId) return;
                    const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true;
                    try {
                        const worker = appState.workers.find(w => w.id === workerId);
                        await addDoc(colref.shifts, { workerId, pagoBase: worker?.pagoBase || 0, inicio: serverTimestamp(), estado: "abierto" });
                        await createNotification(`${worker.nombre} ha iniciado turno.`, 'shift');
                    } catch(err) { showToast(err.message, 'error'); } finally { btn.disabled = false; }
                });
                content.querySelectorAll('.btn-manage-shift').forEach(btn => btn.addEventListener('click', (e) => { appState.selectedShiftId = e.target.dataset.shiftId; scheduleRender(); }));
                content.querySelectorAll('.btn-view-desglose').forEach(btn => btn.addEventListener('click', (e) => {
                    const shiftId = e.target.dataset.shiftId;
                    const shift = appState.activeShifts.find(s => s.id === shiftId); if (!shift) return;
                    const worker = appState.workers.find(w => w.id === shift.workerId);
                    document.getElementById('desglose-modal-title').textContent = `Desglose de ${worker?.nombre || '...'}`;
                    const combinedEvents = [ ...shift.sales.map(s => ({ ...s, eventType: 'sale' })), ...shift.loans.map(l => ({ ...l, eventType: 'loan' })) ];
                    if (combinedEvents.length > 0 && combinedEvents[0].fecha?.toMillis) combinedEvents.sort((a, b) => a.fecha.toMillis() - b.fecha.toMillis());
                    const tableBody = combinedEvents.map(event => {
                        const time = event.fecha?.toDate().toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' }) || 'N/A';
                        if (event.eventType === 'sale') {
                            const product = appState.products.find(p => p.id === event.productId);
                            return row([time, `${event.unidades} x ${product?.nombre || 'Ficha'}`, COP(event.totalVenta), COP(event.totalComision), '']);
                        } else return row([time, `Préstamo: ${event.descripcion}`, '', '', COP(event.valor)]);
                    }).join('');
                    document.getElementById('desglose-modal-body').innerHTML = `<table><thead><tr><th>Hora</th><th>Descripción</th><th>Ingreso</th><th>Comisión</th><th>Préstamo</th></tr></thead><tbody>${tableBody || `<tr><td colspan="5">Sin eventos.</td></tr>`}</tbody></table>`;
                    document.getElementById('desglose-modal').classList.add('visible');
                }));
            }
        }
    }
    
    // --- Manejo de Modales ---
    document.querySelectorAll(".modal").forEach(modal => {
        const closeBtn = modal.querySelector(".modal-close-btn");
        if (closeBtn) closeBtn.addEventListener("click", () => modal.classList.remove("visible"));
        modal.addEventListener("click", (e) => { if (e.target === modal) modal.classList.remove("visible"); });
    });
  </script>
</body>
</html>
