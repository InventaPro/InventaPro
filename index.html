<!DOCTYPE html>
<html lang="es-CO">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InventaPro - Control de Inventario</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* --- INICIO: Sistema de Temas y Modo Oscuro --- */
        :root {
            --primary-color: #3B82F6;
            --primary-dark: #2563EB;
            --primary-light: #EFF6FF;
            --secondary-color: #6B7280;
            --success-color: #10B981;
            --danger-color: #EF4444;
            --warning-color: #F59E0B;
            --font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --border-radius: 8px;
            --sidebar-width: 260px;
            --header-height: 70px;
            --bottom-nav-height: 65px;
            
            /* Variables para Tema Claro (por defecto) */
            --surface-color: #ffffff;
            --bg-color: #F9FAFB;
            --sidebar-bg: #FFFFFF;
            --text-color: #1F2937;
            --text-muted: #6B7280;
            --border-color: #E5E7EB;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        [data-theme="dark"] {
            /* Variables para Tema Oscuro */
            --surface-color: #1F2937;
            --bg-color: #111827;
            --sidebar-bg: #1F2937;
            --text-color: #F3F4F6;
            --text-muted: #9CA3AF;
            --border-color: #374151;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.2);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.3), 0 2px 4px -2px rgb(0 0 0 / 0.3);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.4), 0 4px 6px -4px rgb(0 0 0 / 0.4);
        }
        /* --- FIN: Sistema de Temas y Modo Oscuro --- */

        *, *::before, *::after { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            font-size: 16px;
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- PRELOADER Y ANIMACIÓN DE TRANSICIÓN --- */
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-color);
            transition: all 0.6s ease-in-out;
        }

        .preloader-logo-container {
            width: 150px;
            height: 150px;
            position: relative;
            z-index: 2;
        }
        .constructing-logo {
            width: 100%;
            height: 100%;
        }
        .constructing-logo .logo-line {
            stroke: var(--primary-color);
            stroke-width: 1.5;
            fill: none;
            stroke-dasharray: 70;
            stroke-dashoffset: 70;
            animation: draw-line 1s ease-out forwards;
        }
        .constructing-logo .logo-line:nth-of-type(4) { animation-delay: 0s; }
        .constructing-logo .logo-line:nth-of-type(5) { animation-delay: 0.6s; }
        .constructing-logo .logo-line:nth-of-type(6) { animation-delay: 0.8s; }

        @keyframes draw-line {
            to { stroke-dashoffset: 0; }
        }

        .constructing-logo .logo-face {
            fill: var(--primary-color);
            stroke: none;
            opacity: 0;
            transform-origin: center center;
            animation: fill-face 0.7s ease-out forwards;
        }
        .constructing-logo .face-top { animation-delay: 1.2s; }
        .constructing-logo .face-left { animation-delay: 1.4s; }
        .constructing-logo .face-right { animation-delay: 1.4s; }

        @keyframes fill-face {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 0.15; transform: scale(1); }
        }
        [data-theme="dark"] .constructing-logo .logo-face {
            animation-name: fill-face-dark;
        }
        @keyframes fill-face-dark {
             from { opacity: 0; transform: scale(0.95); }
             to { opacity: 0.25; transform: scale(1); }
        }
        
        body.app-loaded #preloader {
            top: 24px;
            left: 24px;
            width: 50px;
            height: 50px;
            transform: translate(0, 0);
            pointer-events: none;
            background-color: transparent;
        }
        body.app-loaded #preloader .preloader-logo-container {
            display: none;
        }
        #static-preloader-logo { display: none; }
        body.app-loaded #static-preloader-logo {
            display: block;
            width: 50px;
            height: 50px;
            color: var(--primary-color);
        }
        body.auth-visible #preloader {
            opacity: 0;
            pointer-events: none;
        }

        /* --- CONTENEDOR DE AUTENTICACIÓN --- */
        #auth-container { display: none; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; padding: 1.5rem; animation: fadeInAuth 0.8s ease; }
        @keyframes fadeInAuth { from { opacity: 0; } to { opacity: 1; } }
        .auth-box { background-color: var(--surface-color); padding: 2.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow-md); border: 1px solid var(--border-color); max-width: 420px; width: 100%; }
        .auth-box .static-logo { color: var(--primary-color); width: 60px; height: 60px; margin-bottom: 1rem; }
        .auth-box h2 { font-size: 1.8rem; margin-top: 0; margin-bottom: 0.5rem; }
        .auth-box p { color: var(--text-muted); margin-top: 0; margin-bottom: 2rem; }
        .auth-buttons { display: flex; flex-direction: column; gap: 1rem; }

        /* --- ESTRUCTURA PRINCIPAL DE LA APP --- */
        #app-shell { display: flex; opacity: 0; transition: opacity 0.5s ease 0.4s; }
        body.app-loaded #app-shell { opacity: 1; }
        body.user-type-worker #app-shell { display: none; }

        #sidebar {
            width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0;
            background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; padding: 1.5rem; box-shadow: var(--shadow-sm);
            transition: width 0.3s ease, background-color 0.3s ease; z-index: 900;
        }

        .sidebar-header {
            height: 50px;
            margin-bottom: 2rem;
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .sidebar-logo {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            object-fit: cover;
            background-color: var(--primary-light);
            padding: 4px;
        }
        .sidebar-logo-placeholder {
            width: 50px;
            height: 50px;
            color: var(--primary-color);
        }
        #sidebar-bar-name { font-size: 1.5rem; font-weight: 700; margin: 0; line-height: 1.2; color: var(--text-color); white-space: nowrap; opacity: 0; animation: fadeIn 0.5s ease 0.6s forwards; }
        
        #app-nav { display: flex; flex-direction: column; gap: 0.5rem; flex-grow: 1; }
        .nav-tab {
            display: flex; align-items: center; gap: 0.75rem; text-align: left; padding: 0.75rem 1rem;
            border-radius: 6px; cursor: pointer; font-weight: 600; color: var(--text-muted);
            border: none; background: none; font-size: 1rem; position: relative;
            transition: color 0.2s ease, background-color 0.2s ease;
        }
        .nav-tab .icon { width: 20px; height: 20px; flex-shrink: 0; }
        .nav-tab span { white-space: nowrap; }
        .nav-tab:hover { color: var(--primary-color); background-color: var(--primary-light); }
        .nav-tab.active { color: var(--primary-dark); background-color: var(--primary-light); font-weight: 700; }
        .nav-tab.active::before {
            content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%);
            width: 4px; height: 24px; background-color: var(--primary-color); border-radius: 0 4px 4px 0;
        }
        
        .sidebar-footer { margin-top: auto; }

        main {
            margin-left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
            padding: 1.5rem;
            overflow-y: auto;
            transition: margin-left 0.3s ease, width 0.3s ease, padding-bottom 0.3s ease;
            position: relative;
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- INICIO: NUEVO HEADER DASHBOARD --- */
        #app-header {
            background-color: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            padding: 0 1.5rem;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 800;
            margin: -1.5rem -1.5rem 1.5rem -1.5rem; /* Compensa el padding del main */
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            padding: 0.5rem;
            margin: -0.5rem;
            border-radius: var(--border-radius);
            transition: background-color 0.2s ease;
        }
        .header-left:hover {
             background-color: var(--bg-color);
        }
        #header-logo-container .sidebar-logo, 
        #header-logo-container .sidebar-logo-placeholder {
            width: 40px;
            height: 40px;
        }
        #header-bar-name {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }
        .chevron-icon {
            width: 20px;
            height: 20px;
            color: var(--text-muted);
            transition: transform 0.3s ease;
        }
        #dashboard-menu.active ~ #app-header .chevron-icon {
            transform: rotate(180deg);
        }

        #dashboard-menu {
            position: absolute;
            top: calc(var(--header-height) + 8px);
            left: 1.5rem;
            right: 1.5rem;
            z-index: 790;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            padding: 1rem;
            display: none; /* Se activa con JS */
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            max-width: 900px;
        }
        #dashboard-menu.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        .dashboard-menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }
        .dashboard-menu-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: var(--border-radius);
            background-color: transparent;
            border: 1px solid transparent;
            cursor: pointer;
            text-align: left;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-color);
            transition: background-color 0.2s, border-color 0.2s, transform 0.2s;
        }
        .dashboard-menu-item:hover {
            background-color: var(--bg-color);
            border-color: var(--border-color);
            transform: translateY(-3px);
        }
        .dashboard-menu-item .icon {
            width: 24px;
            height: 24px;
            color: var(--primary-color);
        }
        .dashboard-menu-item span {
            display: block;
            font-weight: 600;
        }
        .dashboard-menu-item small {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
         /* --- FIN: NUEVO HEADER DASHBOARD --- */

        /* --- Estilos del Interruptor de Tema --- */
        .theme-switch-wrapper { display: flex; align-items: center; justify-content: space-between; gap: 1rem; padding: 0.5rem; border-radius: 6px; margin-top: 1rem; }
        .theme-switch-wrapper span { font-weight: 600; font-size: 0.9rem; }
        .theme-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* --- ESTILOS DE COMPONENTES --- */
        .card { background-color: var(--surface-color); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); margin-bottom: 1.5rem; padding: 1.5rem; transition: background-color 0.3s ease, border-color 0.3s ease; }
        .card-header { display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap:1rem; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .card-header h2 { margin: 0; font-size: 1.25rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
        .stat-card { display: flex; align-items: center; gap: 1rem; background-color: var(--primary-light); padding: 1.5rem; border-radius: var(--border-radius); }
        [data-theme="dark"] .stat-card { background-color: #2b3a54; }
        [data-theme="dark"] .stat-card.success { background-color: #064E3B; }
        [data-theme="dark"] .stat-card.danger { background-color: #7f1d1d; }
        .stat-card .icon { width: 32px; height: 32px; color: var(--primary-color); }
        .stat-card-content h3, .stat-card-content h5 { margin: 0 0 0.25rem 0; color: var(--primary-dark); font-size: 0.9rem; font-weight: 500; text-transform: uppercase; }
        .stat-card-content p { margin: 0; font-size: 1.75rem; font-weight: 700; color: var(--primary-dark); }
        [data-theme="dark"] .stat-card-content h3, [data-theme="dark"] .stat-card-content h5, [data-theme="dark"] .stat-card-content p { color: var(--primary-light); }
        .stat-card.success { background-color: #ECFDF5; } .stat-card.success .icon, .stat-card.success h3, .stat-card.success p { color: #059669; }
        [data-theme="dark"] .stat-card.success .icon, [data-theme="dark"] .stat-card.success h3, [data-theme="dark"] .stat-card.success p { color: #34D399; }
        .stat-card.danger { background-color: #FEF2F2; } .stat-card.danger .icon, .stat-card.danger h3, .stat-card.danger p { color: #DC2626; }
        [data-theme="dark"] .stat-card.danger .icon, [data-theme="dark"] .stat-card.danger h3, [data-theme="dark"] .stat-card.danger p { color: #F87171; }
        .clickable-stat-card:hover { cursor: pointer; transform: scale(1.03); box-shadow: var(--shadow-md); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.65rem 1.25rem; border-radius: 6px; cursor: pointer; text-align: center; font-size: 0.95rem; font-weight: 600; transition: all 0.2s ease; border: 1px solid transparent; text-decoration: none; white-space: nowrap; }
        .btn .icon { width: 20px; height: 20px; }
        .btn:disabled { background-color: var(--secondary-color); border-color: var(--secondary-color); cursor: not-allowed; opacity: 0.6; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .btn-primary { background-color: var(--primary-color); color: white; border-color: var(--primary-color); } .btn-primary:hover:not(:disabled) { background-color: var(--primary-dark); border-color: var(--primary-dark); }
        .btn-success { background-color: var(--success-color); color: white; border-color: var(--success-color); } .btn-success:hover:not(:disabled) { background-color: #059669; }
        .btn-danger { background-color: var(--danger-color); color: white; border-color: var(--danger-color); } .btn-danger:hover:not(:disabled) { background-color: #DC2626; }
        .btn-secondary { background-color: var(--secondary-color); color: white; border-color: var(--secondary-color); } .btn-secondary:hover:not(:disabled) { background-color: #4B5563; }
        .btn-outline { background-color: transparent; color: var(--primary-color); border-color: var(--primary-color); } .btn-outline:hover:not(:disabled) { background-color: var(--primary-light); }
        [data-theme="dark"] .btn-outline:hover:not(:disabled) { background-color: rgba(59, 130, 246, 0.1); }
        .btn-icon { padding: 0.5rem; }
        
        .modal { 
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; 
            width: 100%; height: 100%; 
            background-color: rgba(17, 24, 39, 0.6); 
            align-items: flex-start;
            justify-content: center; 
            padding: 2rem 1rem;
            overflow-y: auto;
            backdrop-filter: blur(4px); 
        }
        .modal-content { 
            background-color: var(--surface-color); 
            padding: 2rem; 
            border-radius: var(--border-radius); 
            width: 100%; 
            max-width: 500px; 
            box-shadow: var(--shadow-lg); 
            animation: slide-up 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-content.modal-lg { max-width: 800px; }
        .modal-content h2 { margin-top: 0; }
        .auth-modal .modal-content { max-width: 400px; }
        @keyframes slide-up { from { transform: translateY(20px) scale(0.98); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        
        .form-group { margin-bottom: 1.25rem; text-align: left; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { font-size: 1rem; padding: 0.75rem; width: 100%; border: 1px solid var(--border-color); border-radius: 6px; transition: border-color 0.2s, box-shadow 0.2s; background-color: var(--surface-color); color: var(--text-color); }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px var(--primary-light); }
        [data-theme="dark"] .form-group input:focus, [data-theme="dark"] .form-group select:focus, [data-theme="dark"] .form-group textarea:focus { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .form-error-msg { color: var(--danger-color); font-size: 0.9rem; min-height: 1.2em; text-align: center; margin-bottom: 1rem;}
        .management-table { width: 100%; border-collapse: collapse; }
        .management-table th { text-align: left; padding: 0.75rem 1rem; border-bottom: 2px solid var(--border-color); font-size: 0.85rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.5px; }
        .management-table td { text-align: left; padding: 1rem; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .management-table tbody tr:hover { background-color: var(--bg-color); }
        .management-table .actions { display: flex; gap: 0.5rem; justify-content: flex-end; }
        .empty-state { text-align: center; padding: 3rem 1rem; color: var(--secondary-color); background-color: var(--surface-color); border-radius: var(--border-radius); border: 2px dashed var(--border-color); }
        .worker-dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .worker-card { background-color: var(--surface-color); border-radius: var(--border-radius); border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); padding: 1.5rem; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .worker-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
        .worker-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .worker-card-header h3 { margin: 0; font-size: 1.2rem; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.8rem; font-weight: 600; color: white; }
        .status-active { background-color: var(--primary-color); } .status-liquidado { background-color: var(--success-color); } .status-inactive { background-color: var(--secondary-color); }
        .status-pago-pagado { background-color: var(--success-color); } .status-pago-parcial { background-color: var(--warning-color); } .status-pago-pendiente { background-color: var(--danger-color); }
        .worker-card-summary p { margin: 0.5rem 0 0 0; display: flex; justify-content: space-between; font-size: 0.95rem; }
        .worker-card-summary span { font-weight: 600; }
        .dispatch-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.75rem; margin: 1.5rem 0; }
        #toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 2000; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { display: flex; align-items: center; gap: 0.75rem; padding: 1rem 1.5rem; border-radius: 6px; color: white; font-weight: 600; box-shadow: var(--shadow-lg); animation: toast-fade 4s ease-in-out forwards; }
        .toast .icon { width: 24px; height: 24px; }
        .toast.success { background-color: var(--success-color); } .toast.error { background-color: var(--danger-color); }
        @keyframes toast-fade { 0% { opacity: 0; transform: translateX(100%); } 10% { opacity: 1; transform: translateX(0); } 90% { opacity: 1; transform: translateX(0); } 100% { opacity: 0; transform: translateX(100%); } }
        .history-details, .report-details { border: 1px solid var(--border-color); border-radius: var(--border-radius); margin-bottom: 1rem; background-color: var(--surface-color); }
        .history-details summary, .report-details summary { cursor: pointer; padding: 1rem 1.5rem; font-weight: 600; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .history-details summary::-webkit-details-marker, .report-details summary::-webkit-details-marker { display: none; }
        .history-details summary::after, .report-details summary::after { content: '▼'; font-size: 0.8em; transition: transform 0.2s; }
        .history-details[open] summary::after, .report-details[open] summary::after { transform: rotate(180deg); }
        .history-details-content, .report-details-content { padding: 0 1.5rem 1.5rem 1.5rem; }
        .liquidacion-summary { border: 1px solid var(--border-color); border-radius: 6px; padding: 1rem; margin-bottom: 1rem; background-color: var(--bg-color); }
        .liquidacion-summary p { display: flex; justify-content: space-between; margin: 0.5rem 0; }
        .liquidacion-summary hr { border: none; border-top: 1px solid var(--border-color); }
        .quantity-control { display: flex; align-items: center; gap: 0.5rem; }
        .quantity-control .btn { padding: 0.5rem; line-height: 1; min-width: 44px; }
        .quantity-control input { text-align: center; font-weight: bold; }
        .quantity-control input::-webkit-outer-spin-button, .quantity-control input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .quantity-control input[type=number] { -moz-appearance: textfield; }
        .actions { display: flex; flex-wrap: wrap; }
        .caja-tx-ingreso { color: var(--success-color); }
        .caja-tx-egreso { color: var(--danger-color); }
        
        .logo-uploader {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
            position: relative;
        }
        .logo-uploader:hover { border-color: var(--primary-color); }
        .logo-uploader input[type="file"] { display: none; }
        .logo-uploader .uploader-text { color: var(--text-muted); }
        .logo-preview {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }
        .logo-uploader.has-logo .uploader-text { opacity: 0; }
        .logo-uploader.has-logo .logo-preview { display: block; }
        
        .category-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .category-card {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem 1rem;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        }
        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .form-summary {
            background-color: var(--bg-color);
            border-radius: 6px;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            margin-top: 1rem;
            border: 1px solid var(--border-color);
        }
        .purchase-item-list {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem;
            margin-bottom: 1rem;
        }
        .purchase-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            font-size: 0.9rem;
            border-bottom: 1px dashed var(--border-color);
        }
        .purchase-item:last-child {
            border-bottom: none;
        }


        /* VISTA DE TRABAJADOR */
        #worker-view { display: none; }
        body.user-type-worker #worker-view {
            display: block;
            padding: 1rem;
            animation: fadeIn 0.5s;
        }
        .worker-header {
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }
        .worker-header h2 { margin: 0; font-size: 1.2rem; }
        .worker-header h2 small { font-size: 0.8rem; color: var(--text-muted); display: block; font-weight: 500; }

        @media (max-width: 992px) {
            :root { --sidebar-width: 220px; }
            main { margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); }
        }

        @media (max-width: 768px) {
            body.app-loaded #preloader { display: none; }

            #sidebar {
                flex-direction: row;
                width: 100%;
                height: var(--bottom-nav-height);
                padding: 0 0.5rem;
                top: auto;
                bottom: 0;
                border-right: none;
                border-top: 1px solid var(--border-color);
                box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
            }
            [data-theme="dark"] #sidebar { box-shadow: 0 -2px 5px rgba(0,0,0,0.2); }
            .sidebar-header { display: none; }
            .sidebar-footer { display: none; }

            #app-nav {
                flex-direction: row;
                justify-content: space-around;
                align-items: center;
                width: 100%;
                height: 100%;
            }
            .nav-tab {
                flex-direction: column;
                justify-content: center;
                align-items: center;
                flex: 1;
                height: 100%;
                padding: 0.25rem 0;
                gap: 4px;
                border-radius: 6px;
                background: none !important;
            }
            .nav-tab .icon { width: 22px; height: 22px; }
            .nav-tab span { font-size: 0.7rem; font-weight: 500; }
            .nav-tab.active { color: var(--primary-color); font-weight: 600; }
            
            .nav-tab::before { display: none; }
            .nav-tab.active::after {
                content: '';
                position: absolute;
                top: 0;
                left: 20%;
                right: 20%;
                height: 3px;
                background-color: var(--primary-color);
                border-radius: 0 0 3px 3px;
            }

            main {
                margin-left: 0;
                width: 100%;
                padding: 1rem;
                padding-bottom: calc(var(--bottom-nav-height) + 1.5rem);
            }
            #app-header {
                height: 60px;
                margin: -1rem -1rem 1rem -1rem;
                padding: 0 1rem;
            }
            #dashboard-menu {
                top: 68px;
                left: 1rem;
                right: 1rem;
            }

            .management-table thead { display: none; }
            .management-table, .management-table tbody, .management-table tr, .management-table td { display: block; width: 100%; }
            .management-table tr { margin-bottom: 1rem; border: 1px solid var(--border-color); border-radius: 6px; padding: 0.5rem; }
            .management-table td { text-align: right; position: relative; padding: 0.75rem 0.5rem; padding-left: 50%; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: flex-end; }
            .management-table tr td:last-child { border-bottom: 0; }
            .management-table td::before { content: attr(data-label); position: absolute; left: 0.75rem; width: calc(50% - 1.5rem); text-align: left; font-weight: bold; color: var(--text-muted); }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol id="icon-logo" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></symbol>
        <symbol id="icon-turnos" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></symbol>
        <symbol id="icon-inventario" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></symbol>
        <symbol id="icon-caja" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></symbol>
        <symbol id="icon-historial" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></symbol>
        <symbol id="icon-reportes" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="m19 9-5 5-4-4-3 3"></path></symbol>
        <symbol id="icon-configuracion" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></symbol>
        <symbol id="icon-logout" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></symbol>
        <symbol id="icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></symbol>
        <symbol id="icon-edit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></symbol>
        <symbol id="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></symbol>
        <symbol id="icon-alert" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></symbol>
        <symbol id="icon-arrow-left" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></symbol>
        <symbol id="icon-users" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></symbol>
        <symbol id="icon-package" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></symbol>
        <symbol id="icon-dollar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></symbol>
        <symbol id="icon-clipboard" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></symbol>
        <symbol id="icon-archive" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></symbol>
        <symbol id="icon-pdf" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v4"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M2.25 15.25c0-.41.34-.75.75-.75h1.25a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H3a.75.75 0 0 1-.75-.75v-1.25Z"></path><path d="M4.25 18H3a.75.75 0 0 0-.75.75v.5c0 .41.34.75.75.75h1.25a1 1 0 0 0 1-1v-1a1 1 0 0 0-1-1Z"></path><path d="M10 18h1"></path><path d="M8.5 15h1"></path><path d="M10 15h1"></path><path d="M8.5 18h1"></path><path d="M10 21h1"></path><path d="M8.5 21h1"></path><path d="M12.5 15h1.25c.41 0 .75.34.75.75v3.5c0 .41-.34.75-.75.75h-1.25"></path></symbol>
        <symbol id="icon-excel" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v4"></path><polyline points="14 2 14 8 20 8"></polyline><path d="m10.4 14-2.8 5"></path><path d="m7.6 14 2.8 5"></path></symbol>
        <symbol id="icon-truck" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></symbol>
        <symbol id="icon-receipt" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.5 8.5A2.5 2.5 0 0 1 5 6h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1.5A2.5 2.5 0 0 1 2.5 14V10A2.5 2.5 0 0 1 2.5 8.5z"></path><path d="M6 18h12"></path><path d="M6 14h12"></path></symbol>
        <symbol id="icon-chevron-down" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></symbol>
    </svg>
    
    <div id="preloader">
        <div class="preloader-logo-container">
            <svg class="constructing-logo" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <polygon class="logo-face face-top" points="12 2.27 4 6.96 12 12.01 20.73 6.96" />
                <polygon class="logo-face face-left" points="3.27 6.96 12 12.01 12 22.08 4 17.39" />
                <polygon class="logo-face face-right" points="20.73 6.96 12 12.01 12 22.08 20 17.39" />
                <path class="logo-line" d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                <polyline class="logo-line" points="3.27 6.96 12 12.01 20.73 6.96"/>
                <line class="logo-line" x1="12" y1="22.08" x2="12" y2="12"/>
            </svg>
        </div>
        <svg id="static-preloader-logo"><use href="#icon-logo"></use></svg>
    </div>

    <div id="auth-container"><div class="auth-box"><svg class="static-logo"><use href="#icon-logo"></use></svg><h2>Bienvenido a InventaPro</h2><p>La solución definitiva para gestionar tu negocio.</p><div class="auth-buttons"><button id="show-login-btn" class="btn btn-primary">Soy Administrador</button><button id="show-worker-login-btn" class="btn btn-success">Soy Vendedor</button><button id="show-register-btn" class="btn btn-outline">Crear una cuenta nueva</button></div></div></div>
    
    <div id="login-modal" class="modal auth-modal"><div class="modal-content"><svg class="static-logo" style="margin: 0 auto 1rem auto; display:block;"><use href="#icon-logo"></use></svg><h2>Iniciar Sesión</h2><form id="login-form"><div class="form-group"><label for="username">Correo Electrónico</label><input type="email" id="username" required></div><div class="form-group"><label for="password">Contraseña</label><input type="password" id="password" required></div><div class="form-error-msg" id="login-error"></div><button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Ingresar</button><button type="button" class="btn btn-outline" onclick="app.showAuthHome()" style="width: 100%; margin-top: 0.5rem;">Cancelar</button></form></div></div>
    
    <div id="worker-login-modal" class="modal auth-modal"><div class="modal-content"><svg class="static-logo" style="margin: 0 auto 1rem auto; display:block;"><use href="#icon-users"></use></svg><h2>Acceso de Vendedor</h2><form id="worker-login-form"><div class="form-group"><label for="business-select">Selecciona tu Lugar de Trabajo</label><select id="business-select" required><option value="">Cargando negocios...</option></select></div><div class="form-group"><label for="worker-code">Ingresa tu Código de Acceso</label><input type="password" id="worker-code" pattern="[0-9]*" inputmode="numeric" required></div><div class="form-error-msg" id="worker-login-error"></div><button type="submit" class="btn btn-success" style="width: 100%; margin-top: 1rem;">Ingresar</button><button type="button" class="btn btn-outline" onclick="app.showAuthHome()" style="width: 100%; margin-top: 0.5rem;">Cancelar</button></form></div></div>

    <div id="register-modal" class="modal"><div class="modal-content" style="max-width: 600px;"><svg class="static-logo" style="margin: 0 auto 1rem auto; display:block;"><use href="#icon-logo"></use></svg><h2>Configura tu Cuenta y Negocio</h2><p style="text-align: center; color: var(--text-muted); margin-top: -0.5rem; margin-bottom: 2rem;">Un solo paso para empezar a organizar todo.</p><form id="register-form"><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem 1.5rem;"><div class="form-group"><label for="reg-fullname">Nombre Completo</label><input type="text" id="reg-fullname" required></div><div class="form-group"><label for="reg-phone">Teléfono</label><input type="tel" id="reg-phone"></div><div class="form-group"><label for="reg-email">Correo Electrónico</label><input type="email" id="reg-email" required></div><div class="form-group"><label for="reg-password">Crear Contraseña</label><input type="password" id="reg-password" required></div><div class="form-group"><label for="reg-barname">Nombre del Establecimiento</label><input type="text" id="reg-barname" required></div><div class="form-group"><label for="reg-role">Tu Rol Principal</label><select id="reg-role" required><option value="" disabled selected>Selecciona un rol...</option><option value="propietario">Propietario</option><option value="administrador">Administrador</option></select></div><div class="form-group" style="grid-column: 1 / -1;"><label for="reg-logo">Logo del Establecimiento</label><label class="logo-uploader" for="reg-logo"><span class="uploader-text">Click para subir una imagen</span><img id="logo-preview" class="logo-preview" src="#" alt="Vista previa del logo"><input type="file" id="reg-logo" accept="image/png, image/jpeg, image/webp"></label></div></div><div class="form-error-msg" id="register-error" style="margin-top: 1.5rem;"></div><div class="actions" style="justify-content:flex-end; gap:0.5rem; margin-top:1.5rem;"><button type="button" class="btn btn-outline" onclick="app.showAuthHome()">Cancelar</button><button type="submit" class="btn btn-primary">Siguiente Paso &rarr;</button></div></form></div></div>

    <div id="category-modal" class="modal"><div class="modal-content"><svg class="static-logo" style="margin: 0 auto 1rem auto; display:block;"><use href="#icon-logo"></use></svg><h2>¿Qué tipo de negocio tienes?</h2><p style="text-align: center; color: var(--text-muted); margin-top: -0.5rem; margin-bottom: 1rem;">Esto nos ayudará a personalizar tu experiencia.</p><div class="category-grid"><div class="category-card" onclick="app.selectCategory('Discoteca / Bar')">Discoteca / Bar</div><div class="category-card" onclick="app.selectCategory('Restaurante / Cafetería')">Restaurante / Cafetería</div><div class="category-card" onclick="app.selectCategory('Tienda / Minimarket')">Tienda / Minimarket</div><div class="category-card" onclick="app.selectCategory('Supermercado')">Supermercado</div><div class="category-card" onclick="app.selectCategory('Bodega / Almacén')">Bodega / Almacén</div><div class="category-card" onclick="app.selectCategory('Otro')">Otro</div></div></div></div>

    <div id="license-modal" class="modal"><div class="modal-content" style="max-width: 420px;"><svg class="static-logo" style="margin: 0 auto 1rem auto; display:block;"><use href="#icon-logo"></use></svg><h2>Último paso: Activar Licencia</h2><p style="text-align: center; color: var(--text-muted); margin-top: -0.5rem; margin-bottom: 2rem;">Ingresa tu código de licencia para desbloquear todas las funciones.</p><form id="license-form"><div class="form-group"><label for="license-code">Código de Licencia</label><input type="text" id="license-code" required></div><div class="form-error-msg" id="license-error"></div><button type="submit" class="btn btn-success" style="width: 100%; margin-top: 1rem;">Activar y Empezar</button></form></div></div>

    <div id="app-shell">
        <aside id="sidebar">
            <div class="sidebar-header">
                <div id="sidebar-logo-container"></div>
                <h1 id="sidebar-bar-name">InventaPro</h1>
            </div>
            <nav id="app-nav">
                <button class="nav-tab" data-tab="turnos"><svg class="icon"><use href="#icon-turnos"></use></svg><span>Turnos</span></button>
                <button class="nav-tab" data-tab="caja"><svg class="icon"><use href="#icon-caja"></use></svg><span>Flujo de Caja</span></button>
                <button class="nav-tab" data-tab="inventario"><svg class="icon"><use href="#icon-inventario"></use></svg><span>Inventario</span></button>
                <button class="nav-tab" data-tab="historial"><svg class="icon"><use href="#icon-historial"></use></svg><span>Historial</span></button>
                <button class="nav-tab" data-tab="reportes"><svg class="icon"><use href="#icon-reportes"></use></svg><span>Reportes</span></button>
                <button class="nav-tab" data-tab="configuracion"><svg class="icon"><use href="#icon-configuracion"></use></svg><span>Configuración</span></button>
            </nav>
            <div class="sidebar-footer">
                <div class="theme-switch-wrapper">
                    <span>Modo Oscuro</span>
                    <label class="theme-switch">
                        <input type="checkbox" id="theme-toggle-desktop">
                        <span class="slider"></span>
                    </label>
                </div>
                <button class="btn btn-secondary" onclick="app.logout()" style="width:100%; margin-top: 1rem;">
                    <svg class="icon"><use href="#icon-logout"></use></svg>
                    <span>Cerrar Sesión</span>
                </button>
            </div>
        </aside>
        <main>
            <header id="app-header">
                <div class="header-left">
                    <div id="header-logo-container"></div>
                    <h2 id="header-bar-name"></h2>
                    <svg class="chevron-icon"><use href="#icon-chevron-down"></use></svg>
                </div>
            </header>
            <div id="dashboard-menu">
                <div class="dashboard-menu-grid">
                    <button class="dashboard-menu-item" data-tab="turnos">
                        <svg class="icon"><use href="#icon-turnos"></use></svg>
                        <div><span>Turnos</span><small>Gestiona los vendedores</small></div>
                    </button>
                     <button class="dashboard-menu-item" data-tab="caja">
                        <svg class="icon"><use href="#icon-caja"></use></svg>
                        <div><span>Flujo de Caja</span><small>Controla ingresos y egresos</small></div>
                    </button>
                     <button class="dashboard-menu-item" data-tab="inventario">
                        <svg class="icon"><use href="#icon-inventario"></use></svg>
                        <div><span>Inventario</span><small>Bodega y productos</small></div>
                    </button>
                     <button class="dashboard-menu-item" data-tab="historial">
                        <svg class="icon"><use href="#icon-historial"></use></svg>
                        <div><span>Historial</span><small>Consulta registros pasados</small></div>
                    </button>
                     <button class="dashboard-menu-item" data-tab="reportes">
                        <svg class="icon"><use href="#icon-reportes"></use></svg>
                        <div><span>Reportes</span><small>Analiza tu rendimiento</small></div>
                    </button>
                     <button class="dashboard-menu-item" data-tab="configuracion">
                        <svg class="icon"><use href="#icon-configuracion"></use></svg>
                        <div><span>Configuración</span><small>Ajustes del sistema</small></div>
                    </button>
                </div>
            </div>
            <div id="turnos" class="tab-content"><div id="turnos-view-container"></div></div>
            <div id="caja" class="tab-content"></div>
            <div id="inventario" class="tab-content">
                <div class="card"><div class="card-header"><h2>Bodega (Compras a Proveedores)</h2><button class="btn btn-primary" onclick="app.showPurchaseModal()"><svg class="icon"><use href="#icon-plus"></use></svg><span>Registrar Compra</span></button></div><div id="bodega-table-container"></div></div>
                <div class="card"><div class="card-header"><h2>Barra (Productos para la Venta)</h2></div><div id="barra-table-container"></div></div>
            </div>
            <div id="historial" class="tab-content">
                <div class="card">
                    <div class="card-header"><h2>Historial de Turnos Finalizados</h2></div>
                    <div id="historial-turnos-container"></div>
                </div>
                <div class="card">
                    <div class="card-header"><h2>Historial de Cierres de Caja</h2></div>
                    <div id="historial-caja-container"></div>
                </div>
            </div>
            <div id="reportes" class="tab-content">
                <div class="card">
                    <div class="card-header"><h2>Reportes Financieros y de Ventas</h2></div>
                    <div style="display:flex; gap:1rem; flex-wrap:wrap; align-items: flex-end;">
                        <div class="form-group" style="flex-grow: 1;"><label for="report-start-date">Fecha y Hora de Inicio</label><input type="datetime-local" id="report-start-date"></div>
                        <div class="form-group" style="flex-grow: 1;"><label for="report-end-date">Fecha y Hora de Fin</label><input type="datetime-local" id="report-end-date"></div>
                        <div class="form-group" style="margin-bottom: 1.25rem;"><button class="btn btn-primary" onclick="app.generateReport()">Generar Reporte</button></div>
                    </div>
                    <div id="report-export-buttons" style="display:none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn btn-danger" onclick="app.generatePdfReport()"><svg class="icon"><use href="#icon-pdf"></use></svg><span>Exportar a PDF</span></button>
                        <button class="btn btn-success" onclick="app.generateExcelReport()"><svg class="icon"><use href="#icon-excel"></use></svg><span>Exportar a Excel</span></button>
                    </div>
                    <div id="report-container" style="margin-top: 2rem;"></div>
                </div>
            </div>
            <div id="configuracion" class="tab-content">
                 <div class="card" id="business-card-container">
                    <div class="card-header"><h2>Datos del Negocio</h2></div>
                    <form id="business-details-form">
                        <div class="form-group">
                            <label for="business-name">Nombre del Establecimiento</label>
                            <input type="text" id="business-name" required>
                        </div>
                         <div class="form-group">
                            <label for="business-address">Dirección del Establecimiento</label>
                            <textarea id="business-address" rows="2" placeholder="Ej: Calle 100 # 1-23, Bogotá"></textarea>
                        </div>
                        <div class="actions" style="justify-content:flex-end;">
                             <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
                <div class="card">
                    <div class="card-header"><h2>Configuración General</h2></div>
                    <p>Aquí defines las plantillas de productos, gestionas el personal y los proveedores.</p>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:1rem; margin-top:1.5rem;">
                        <button class="btn btn-outline" onclick="app.showWorkerManagementModal()"><svg class="icon"><use href="#icon-users"></use></svg><span>Gestionar Trabajadores</span></button>
                        <button class="btn btn-outline" onclick="app.showProductManagementModal()"><svg class="icon"><use href="#icon-package"></use></svg><span>Gestionar Plantillas de Productos</span></button>
                        <button class="btn btn-outline" onclick="app.showSupplierManagementModal()"><svg class="icon"><use href="#icon-truck"></use></svg><span>Gestionar Proveedores</span></button>
                    </div>
                </div>
                <div class="card" id="mobile-options-card">
                    <div class="card-header"><h2>Opciones de la App</h2></div>
                    <div class="theme-switch-wrapper" style="padding: 0; margin: 0;">
                        <span>Modo Oscuro</span>
                        <label class="theme-switch">
                            <input type="checkbox" id="theme-toggle-mobile">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <hr style="border-color: var(--border-color); margin: 1.5rem 0;">
                    <button class="btn btn-danger" onclick="app.logout()" style="width:100%;">
                        <svg class="icon"><use href="#icon-logout"></use></svg>
                        <span>Cerrar Sesión</span>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <div id="worker-view"></div>
    
    <div id="modal-container" class="modal"><div id="modal-content" class="modal-content"></div></div>
    <div id="toast-container"></div>

<script>
const app = {
    getInitialState() {
        return {
            user: null,
            business: null,
            productos: [],
            trabajadores: [],
            proveedores: [],
            compras: [],
            turnosActivos: [],
            historial: [],
            historialCaja: [],
            caja: {
                saldoInicialDia: 0,
                transacciones: [],
                fechaActual: null
            },
            loggedIn: false,
            currentUserType: null,
            currentWorker: null,
            activeTab: 'turnos',
            currentTurnoView: { type: 'dashboard', workerId: null }
        };
    },

    state: null,
    _tempData: {},
    currentReportData: null,

    init() {
        this.state = this.getInitialState();
        this.initTheme();
        this.attachAuthEventListeners();
        this.handlePreloader();
        this.initHeaderDashboard();
        
        const now = new Date();
        const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
        const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
        const toLocalISOString = date => {
            const pad = num => num.toString().padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
        };
        document.getElementById('report-start-date').value = toLocalISOString(todayStart);
        document.getElementById('report-end-date').value = toLocalISOString(todayEnd);
    },

    saveState() {
        if (!this.state.loggedIn || !this.state.user) return;
        let accounts = JSON.parse(localStorage.getItem('InventaProAccounts')) || [];
        const accountIndex = accounts.findIndex(acc => acc.user.email === this.state.user.email);
        
        const stateToSave = { ...this.state };
        delete stateToSave.currentUserType;
        delete stateToSave.currentWorker;

        if (accountIndex > -1) {
            accounts[accountIndex] = stateToSave;
        } else {
            accounts.push(stateToSave);
        }
        localStorage.setItem('InventaProAccounts', JSON.stringify(accounts));
    },

    uid() { return Date.now().toString(36) + Math.random().toString(36).substr(2); },

    initTheme() {
        const themeToggleDesktop = document.getElementById('theme-toggle-desktop');
        const themeToggleMobile = document.getElementById('theme-toggle-mobile');
        const savedTheme = localStorage.getItem('theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                themeToggleDesktop.checked = true;
                themeToggleMobile.checked = true;
            } else {
                document.documentElement.removeAttribute('data-theme');
                themeToggleDesktop.checked = false;
                themeToggleMobile.checked = false;
            }
        };

        if (savedTheme) { applyTheme(savedTheme); }
        else if (systemPrefersDark) { applyTheme('dark'); }
        else { applyTheme('light'); }

        const toggleTheme = () => {
            const currentTheme = document.documentElement.hasAttribute('data-theme') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        };
        
        themeToggleDesktop.addEventListener('change', toggleTheme);
        themeToggleMobile.addEventListener('change', toggleTheme);
    },

    handlePreloader() {
        setTimeout(() => {
            document.body.classList.add('auth-visible');
            document.getElementById('auth-container').style.display = 'flex';
        }, 2800);
    },

    attachAuthEventListeners() { 
        document.getElementById('show-login-btn').addEventListener('click', () => this.showLoginModal()); 
        document.getElementById('show-worker-login-btn').addEventListener('click', () => this.showWorkerLoginModal());
        document.getElementById('show-register-btn').addEventListener('click', () => this.showRegisterModal()); 
        document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); this.login(); }); 
        document.getElementById('worker-login-form').addEventListener('submit', (e) => { e.preventDefault(); this.loginWorker(); });
        document.getElementById('register-form').addEventListener('submit', (e) => { e.preventDefault(); this.registerUser(); });
        document.getElementById('reg-logo').addEventListener('change', (e) => this.handleLogoUpload(e));
        document.getElementById('license-form').addEventListener('submit', (e) => { e.preventDefault(); this.verifyLicense(); });
    },
    
    initHeaderDashboard() {
        const header = document.querySelector('#app-header .header-left');
        const menu = document.getElementById('dashboard-menu');

        header.addEventListener('click', (event) => {
            event.stopPropagation();
            menu.classList.toggle('active');
        });

        document.addEventListener('click', (event) => {
            if (!menu.contains(event.target) && !header.contains(event.target)) {
                menu.classList.remove('active');
            }
        });

        menu.querySelectorAll('.dashboard-menu-item').forEach(item => {
            item.addEventListener('click', () => {
                this.changeTab(item.dataset.tab);
                menu.classList.remove('active');
            });
        });
    },

    showAuthHome() { 
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        document.getElementById('auth-container').style.display = 'flex'; 
    },
    
    showLoginModal() { 
        document.getElementById('auth-container').style.display = 'none'; 
        document.getElementById('login-modal').style.display = 'flex'; 
        document.getElementById('login-error').textContent = ''; 
    },

    showWorkerLoginModal() {
        document.getElementById('auth-container').style.display = 'none';
        const modal = document.getElementById('worker-login-modal');
        modal.style.display = 'flex';
        document.getElementById('worker-login-error').textContent = '';

        const select = document.getElementById('business-select');
        select.innerHTML = '<option value="">Cargando...</option>';
        const accounts = JSON.parse(localStorage.getItem('InventaProAccounts')) || [];
        if (accounts.length === 0) {
            select.innerHTML = '<option value="">No hay negocios registrados</option>';
        } else {
            select.innerHTML = '<option value="" disabled selected>Selecciona un negocio</option>';
            accounts.forEach(acc => {
                const option = document.createElement('option');
                option.value = acc.user.email;
                option.textContent = acc.business.name;
                select.appendChild(option);
            });
        }
    },
    
    showRegisterModal() { 
        document.getElementById('auth-container').style.display = 'none'; 
        document.getElementById('register-modal').style.display = 'flex'; 
        document.getElementById('register-error').textContent = ''; 
    },

    handleLogoUpload(event) {
        const file = event.target.files[0];
        if (!file || !file.type.startsWith('image/')) {
            this.showToast('Por favor, selecciona un archivo de imagen.', 'error');
            return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('logo-preview').src = e.target.result;
            document.querySelector('.logo-uploader').classList.add('has-logo');
            this._tempData.logoDataUrl = e.target.result;
        };
        reader.readAsDataURL(file);
    },

    registerUser() {
        const fullname = document.getElementById('reg-fullname').value.trim();
        const email = document.getElementById('reg-email').value.trim();
        const password = document.getElementById('reg-password').value;
        const barname = document.getElementById('reg-barname').value.trim();
        const role = document.getElementById('reg-role').value;
        const errorEl = document.getElementById('register-error');
        
        if (!fullname || !email || !password || !barname || !role) {
            errorEl.textContent = 'Por favor, completa todos los campos obligatorios.';
            return;
        }
        
        const accounts = JSON.parse(localStorage.getItem('InventaProAccounts')) || [];
        if (accounts.some(acc => acc.user.email === email)) {
            errorEl.textContent = 'Este correo electrónico ya está registrado. Intenta iniciar sesión.';
            return;
        }

        this._tempData.newAccount = this.getInitialState();
        this._tempData.newAccount.user = {
            id: this.uid(),
            fullname,
            phone: document.getElementById('reg-phone').value.trim(),
            email,
            password: btoa(password),
            role,
        };
        this._tempData.newAccount.business = {
            id: this.uid(),
            name: barname,
            address: '',
            logoDataUrl: this._tempData.logoDataUrl || null,
            category: null
        };

        document.getElementById('register-modal').style.display = 'none';
        this.showCategoryModal();
    },
    
    showCategoryModal() {
        document.getElementById('category-modal').style.display = 'flex';
    },

    selectCategory(category) {
        this._tempData.newAccount.business.category = category;
        document.getElementById('category-modal').style.display = 'none';
        this.showLicenseModal();
    },

    showLicenseModal() {
        document.getElementById('license-modal').style.display = 'flex';
        document.getElementById('license-error').textContent = '';
    },

    verifyLicense() {
        const code = document.getElementById('license-code').value.trim().toLowerCase();
        const errorEl = document.getElementById('license-error');

        const validLicenses = {
            'm12d09a1995': 1,  // 1 mes
            'm09d24a1972': 3,  // 3 meses
            'm09d26a1989': 6,  // 6 meses
            'm03d17a2001': 9,  // 9 meses
            'm05d17a1966': 12  // 1 año
        };

        if (!validLicenses[code]) {
            errorEl.textContent = 'El código de licencia no es válido.';
            return;
        }

        const duration = validLicenses[code];
        const activationDate = new Date();
        const expirationDate = new Date(activationDate);
        expirationDate.setMonth(expirationDate.getMonth() + duration);

        this._tempData.newAccount.user.license = {
            code: code,
            duration: duration,
            activatedAt: activationDate.toISOString(),
            expiresAt: expirationDate.toISOString()
        };
        
        let accounts = JSON.parse(localStorage.getItem('InventaProAccounts')) || [];
        accounts.push(this._tempData.newAccount);
        localStorage.setItem('InventaProAccounts', JSON.stringify(accounts));
        
        this.state = this._tempData.newAccount;
        this.state.loggedIn = true;
        this.state.currentUserType = 'admin';
        this._tempData = {};
        
        this.showToast(`¡Bienvenido! Tu licencia de ${duration} mes(es) ha sido activada.`, 'success');
        this.transitionToApp();
    },
    
    login() {
        const email = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const errorEl = document.getElementById('login-error');

        const accounts = JSON.parse(localStorage.getItem('InventaProAccounts')) || [];
        const foundAccount = accounts.find(acc => acc.user.email === email);

        if (!foundAccount) {
            errorEl.textContent = 'No se encontró ninguna cuenta con ese correo.';
            return;
        }
        
        if (foundAccount.user.password === btoa(password)) {
            this.state = foundAccount;
            this.state.loggedIn = true;
            this.state.currentUserType = 'admin';
            this.transitionToApp();
        } else {
            errorEl.textContent = 'Correo o contraseña incorrectos.';
        }
    },

    loginWorker() {
        const businessEmail = document.getElementById('business-select').value;
        const workerCode = document.getElementById('worker-code').value;
        const errorEl = document.getElementById('worker-login-error');

        if (!businessEmail || !workerCode) {
            errorEl.textContent = 'Debes seleccionar un negocio e ingresar tu código.';
            return;
        }

        const accounts = JSON.parse(localStorage.getItem('InventaProAccounts')) || [];
        const foundAccount = accounts.find(acc => acc.user.email === businessEmail);

        if (!foundAccount) {
            errorEl.textContent = 'Error: No se encontró el negocio seleccionado.';
            return;
        }

        const foundWorker = foundAccount.trabajadores.find(t => t.loginCode === workerCode);

        if (foundWorker) {
            this.state = foundAccount;
            this.state.loggedIn = true;
            this.state.currentUserType = 'worker';
            this.state.currentWorker = foundWorker;
            this.transitionToApp();
        } else {
            errorEl.textContent = 'Código de acceso incorrecto para este negocio.';
        }
    },

    logout() {
        this.showConfirmationModal("¿Está seguro que desea cerrar sesión?", () => {
            this.state = this.getInitialState();
            window.location.reload();
        });
    },
    
    transitionToApp() { 
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        document.getElementById('auth-container').style.display = 'none';
        document.body.classList.add('app-loaded'); 
        document.body.classList.remove('auth-visible'); 
        this.renderUI(); 
    },

    renderUI() {
        document.body.classList.remove('user-type-worker');
        if (this.state.currentUserType === 'admin') {
            this.renderAppUI();
        } else if (this.state.currentUserType === 'worker') {
            document.body.classList.add('user-type-worker');
            this.renderWorkerView();
        }
    },
    
    changeTab(tabId) { this.state.activeTab = tabId; this.state.currentTurnoView = { type: 'dashboard', workerId: null }; this.renderAppUI(); },

    renderAppUI() {
        document.getElementById('header-bar-name').textContent = this.state.business.name;
        const headerLogoContainer = document.getElementById('header-logo-container');

        document.getElementById('sidebar-bar-name').textContent = this.state.business.name;
        const logoContainer = document.getElementById('sidebar-logo-container');
        if (this.state.business.logoDataUrl) {
            const logoHTML = `<img src="${this.state.business.logoDataUrl}" alt="Logo del negocio" class="sidebar-logo">`;
            logoContainer.innerHTML = logoHTML;
            headerLogoContainer.innerHTML = logoHTML;
        } else {
            const placeholderHTML = `<svg class="sidebar-logo-placeholder"><use href="#icon-logo"></use></svg>`;
            logoContainer.innerHTML = placeholderHTML;
            headerLogoContainer.innerHTML = placeholderHTML;
        }

        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll(`.nav-tab[data-tab="${this.state.activeTab}"]`).forEach(t => t.classList.add('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === this.state.activeTab));
        
        document.getElementById('app-nav').onclick = (e) => { 
            const tab = e.target.closest('.nav-tab');
            if (tab) this.changeTab(tab.dataset.tab); 
        };

        switch (this.state.activeTab) {
            case 'turnos': this.renderTurnosTab(); break;
            case 'caja': this.renderCajaTab(); break;
            case 'inventario': this.renderInventario(); break;
            case 'historial': this.renderHistorialTab(); break;
            case 'reportes': this.renderReportUI(); break;
            case 'configuracion': this.renderConfiguracionTab(); break;
        }
    },

    renderWorkerView() {
        const worker = this.state.currentWorker;
        const container = document.getElementById('worker-view');
        
        const header = `
            <div class="worker-header">
                <div>
                    <h2>${worker.nombre} <small>${worker.rol || 'Vendedor'}</small></h2>
                </div>
                <button class="btn btn-danger" onclick="app.logout()">
                    <svg class="icon"><use href="#icon-logout"></use></svg>
                    <span>Salir</span>
                </button>
            </div>`;

        const turnDetailHTML = this.renderTurnoDetail(worker.id, true);
        container.innerHTML = header + `<div id="worker-turn-container">${turnDetailHTML}</div>`;
    },
    
    getTodayDateString() { return new Date().toISOString().split('T')[0]; },
    isCajaAbierta() { return this.state.caja.fechaActual === this.getTodayDateString(); },
    renderCajaTab() {
        const container = document.getElementById('caja');
        if (!this.isCajaAbierta()) {
            container.innerHTML = `<div class="empty-state"><h3>Flujo de Caja del Día</h3><p>No se ha iniciado la caja para el día de hoy (${new Date().toLocaleDateString('es-CO')}).</p><button class="btn btn-primary" onclick="app.showIniciarDiaModal()">+ Iniciar Caja del Día</button></div>`;
        } else {
            const resumen = this.calcularResumenCaja();
            const currency = (v) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(v);
            const transaccionesHTML = this.state.caja.transacciones.length > 0
                ? `<table class="management-table"><thead><tr><th>Hora</th><th>Tipo</th><th>Descripción</th><th>Monto</th><th></th></tr></thead><tbody>${this.state.caja.transacciones.slice().reverse().map(tx => `<tr><td data-label="Hora">${new Date(tx.timestamp).toLocaleTimeString('es-CO', {hour: '2-digit', minute:'2-digit'})}</td><td data-label="Tipo" class="${tx.tipo === 'ingreso' ? 'caja-tx-ingreso' : 'caja-tx-egreso'}">${tx.tipo.charAt(0).toUpperCase() + tx.tipo.slice(1)}</td><td data-label="Descripción">${tx.descripcion}</td><td data-label="Monto" class="${tx.tipo === 'ingreso' ? 'caja-tx-ingreso' : 'caja-tx-egreso'}" style="font-weight: bold;">${currency(tx.monto)}</td><td data-label="Acciones"><div class="actions"><button class="btn btn-icon" onclick="app.deleteTransaccionCaja('${tx.id}')"><svg class="icon"><use href="#icon-trash"></use></svg></button></div></td></tr>`).join('')}</tbody></table>`
                : `<div class="empty-state" style="padding: 1.5rem;">No hay movimientos registrados hoy.</div>`;
            
            const cerrarCajaButton = `<button class="btn btn-warning" onclick="app.showCerrarCajaModal()"><svg class="icon"><use href="#icon-archive"></use></svg><span>Cerrar Caja del Día</span></button>`;

            container.innerHTML = `<div class="card">
                <div class="card-header">
                    <h2>Resumen de Caja del Día (${new Date().toLocaleDateString('es-CO')})</h2>
                    ${cerrarCajaButton}
                </div>
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                    <div class="stat-card"><div class="stat-card-content"><h5>Saldo Inicial</h5><p>${currency(resumen.saldoInicial)}</p></div></div>
                    <div class="stat-card success"><div class="stat-card-content"><h5>Ingresos</h5><p>${currency(resumen.totalIngresos)}</p></div></div>
                    <div class="stat-card danger"><div class="stat-card-content"><h5>Egresos</h5><p>${currency(resumen.totalEgresos)}</p></div></div>
                    <div class="stat-card" style="background-color: var(--primary-color);"><div class="stat-card-content"><h5 style="color:white;">Saldo Actual</h5><p style="color:white;">${currency(resumen.saldoActual)}</p></div></div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h2>Movimientos del Día</h2>
                    <div class="actions" style="gap: 0.5rem;">
                        <button class="btn btn-success" onclick="app.showTransaccionCajaModal('ingreso')">+ Ingreso</button>
                        <button class="btn btn-danger" onclick="app.showTransaccionCajaModal('egreso')">- Egreso</button>
                    </div>
                </div>
                ${transaccionesHTML}
            </div>`;
        }
    },
    calcularResumenCaja(cajaData = this.state.caja) {
        const saldoInicial = cajaData.saldoInicialDia;
        let totalIngresos = 0;
        let totalEgresos = 0;
        cajaData.transacciones.forEach(tx => {
            if (tx.tipo === 'ingreso') totalIngresos += tx.monto;
            else totalEgresos += tx.monto;
        });
        const saldoActual = saldoInicial + totalIngresos - totalEgresos;
        return { saldoInicial, totalIngresos, totalEgresos, saldoActual };
    },
    showIniciarDiaModal() {
        this.showModal(`<h2>Iniciar Flujo de Caja</h2><p>Ingresa el monto de dinero con el que inicias el día.</p><form id="iniciar-dia-form"><div class="form-group"><label for="saldo-inicial">Dinero en Caja</label><input type="number" id="saldo-inicial" min="0" step="1000" required></div><div class="actions" style="justify-content:flex-end; gap:0.5rem; margin-top:1.5rem;"><button type="button" class="btn btn-secondary" onclick="app.closeModal()">Cancelar</button><button type="submit" class="btn btn-primary">Iniciar Día</button></div></form>`);
        document.getElementById('iniciar-dia-form').onsubmit = (e) => {
            e.preventDefault();
            const saldo = parseFloat(document.getElementById('saldo-inicial').value);
            if (isNaN(saldo) || saldo < 0) {
                this.showToast('Por favor, ingresa un monto válido.', 'error');
                return;
            }
            this.state.caja.saldoInicialDia = saldo;
            this.state.caja.transacciones = [];
            this.state.caja.fechaActual = this.getTodayDateString();
            this.saveState();
            this.renderCajaTab();
            this.closeModal();
            this.showToast('Caja iniciada con éxito.');
        };
        document.getElementById('saldo-inicial').focus();
    },
    showTransaccionCajaModal(tipo) {
        if (!this.isCajaAbierta()) {
            this.showToast('Debes iniciar la caja del día para registrar movimientos.', 'error');
            return;
        }
        const title = tipo === 'ingreso' ? 'Registrar Ingreso' : 'Registrar Egreso';
        const btnClass = tipo === 'ingreso' ? 'btn-success' : 'btn-danger';
        this.showModal(`<h2>${title}</h2><form id="transaccion-caja-form"><div class="form-group"><label for="tx-monto">Monto</label><input type="number" id="tx-monto" min="1" required></div><div class="form-group"><label for="tx-descripcion">Descripción</label><textarea id="tx-descripcion" rows="3" required></textarea></div><div class="actions" style="justify-content:flex-end; gap:0.5rem; margin-top:1.5rem;"><button type="button" class="btn btn-secondary" onclick="app.closeModal()">Cancelar</button><button type="submit" class="btn ${btnClass}">Guardar</button></div></form>`);
        document.getElementById('transaccion-caja-form').onsubmit = (e) => {
            e.preventDefault();
            const monto = parseFloat(document.getElementById('tx-monto').value);
            const descripcion = document.getElementById('tx-descripcion').value.trim();
            if (isNaN(monto) || monto <= 0 || !descripcion) {
                this.showToast('Todos los campos son obligatorios.', 'error');
                return;
            }
            this.addTransaccionCaja(tipo, monto, descripcion);
            this.closeModal();
            this.showToast('Movimiento registrado.');
        };
        document.getElementById('tx-monto').focus();
    },
    addTransaccionCaja(tipo, monto, descripcion) {
        this.state.caja.transacciones.push({
            id: this.uid(),
            tipo: tipo,
            monto: monto,
            descripcion: descripcion,
            timestamp: new Date().toISOString()
        });
        this.saveState();
        if (this.state.activeTab === 'caja') {
            this.renderCajaTab();
        }
    },
    deleteTransaccionCaja(txId) {
        this.showConfirmationModal('¿Eliminar este movimiento de la caja?', () => {
            this.state.caja.transacciones = this.state.caja.transacciones.filter(tx => tx.id !== txId);
            this.saveState();
            this.renderCajaTab();
            this.showToast('Movimiento eliminado.', 'error');
        });
    },

    showCerrarCajaModal() {
        const resumen = this.calcularResumenCaja();
        const currency = (v) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(v);
        const content = `<h2>Confirmar Cierre de Caja</h2>
            <p>Estás a punto de cerrar la caja para el <strong>${new Date().toLocaleDateString('es-CO')}</strong>. Esta acción guardará el resumen del día en el historial y reiniciará la caja para mañana.</p>
            <div class="liquidacion-summary">
                <p>Saldo Inicial: <span>${currency(resumen.saldoInicial)}</span></p>
                <p>Total Ingresos: <span>${currency(resumen.totalIngresos)}</span></p>
                <p>Total Egresos: <span style="color: var(--danger-color);">${currency(resumen.totalEgresos)}</span></p>
                <hr>
                <p><strong>Saldo Final en Caja:</strong> <strong><span>${currency(resumen.saldoActual)}</span></strong></p>
            </div>
            <div class="actions" style="justify-content:flex-end; gap:0.5rem; margin-top:1.5rem;">
                <button type="button" class="btn btn-secondary" onclick="app.closeModal()">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="app.confirmCierreCaja()">Confirmar y Cerrar Caja</button>
            </div>`;
        this.showModal(content);
    },

    confirmCierreCaja() {
        const resumenCierre = {
            id: this.uid(),
            fecha: this.state.caja.fechaActual,
            resumen: this.calcularResumenCaja(),
            transacciones: [...this.state.caja.transacciones]
        };

        this.state.historialCaja.push(resumenCierre);

        this.state.caja = {
            saldoInicialDia: 0,
            transacciones: [],
            fechaActual: null
        };

        this.saveState();
        this.closeModal();
        this.renderCajaTab();
        this.showToast('La caja ha sido cerrada y archivada con éxito.');
    },

    renderTurnosTab() { const c = document.getElementById('turnos-view-container'); if (this.state.currentTurnoView.type === 'dashboard') { c.innerHTML = this.renderTurnoDashboard(); } else { c.innerHTML = this.renderTurnoDetail(this.state.currentTurnoView.workerId); } },
    renderTurnoDashboard() {
        if (this.state.trabajadores.length === 0) return `<div class="empty-state">No hay trabajadores registrados. Añada uno en Configuración.</div>`;
        return `<div class="worker-dashboard-grid">${this.state.trabajadores.map(w => {
            const turno = this.state.turnosActivos.find(t => t.trabajador.id === w.id);
            const currency = (v) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(v);
            let summaryHTML = '', statusClass = 'status-inactive', statusText = 'Inactivo';
            if (turno) {
                const r = this.calculateSummary(turno);
                statusClass = 'status-active';
                statusText = turno.liquidado ? 'Liquidado' : 'Activo';
                if(turno.liquidado) statusClass = 'status-liquidado';
                summaryHTML = `<div class="worker-card-summary"><p>Ventas: <span>${currency(r.total_ingresos)}</span></p><p>Pago Final: <span style="font-weight:bold; color: var(--success-color);">${currency(r.pago_final_al_trabajador)}</span></p></div>`;
            }
            return `<div class="worker-card" onclick="app.viewWorkerDetail('${w.id}')"><div class="worker-card-header"><h3>${w.nombre}</h3><span class="status-badge ${statusClass}">${statusText}</span></div>${summaryHTML}</div>`;
        }).join('')}</div>`;
    },
    renderTurnoDetail(workerId, isWorkerView = false) {
        const worker = this.state.trabajadores.find(t => t.id === workerId); 
        const turno = this.state.turnosActivos.find(t => t.trabajador.id === workerId);
        
        let backButton = `<button class="btn btn-outline" style="margin-bottom: 1rem;" onclick="app.viewTurnoDashboard()"><svg class="icon"><use href="#icon-arrow-left"></use></svg> Volver al Panel</button>`;
        if (isWorkerView) { backButton = ''; }

        if (turno) {
            const r = this.calculateSummary(turno); const cur = (v) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(v);
            let dispatchHTML = this.state.productos.map(p => `<button class="btn btn-primary" onclick="app.showQuantityModal('${turno.id}', '${p.id}')" ${turno.liquidado ? 'disabled' : ''}>${p.nombre} <span style="opacity:0.7;font-size:0.8em;">(${p.stock_actual})</span></button>`).join('');
            if (!this.state.productos.length) dispatchHTML = `<p style="color:var(--secondary-color);">Añada productos en Configuración y traslade stock desde Inventario.</p>`;
            
            const adminButtons = `
                <button class="btn btn-success" onclick="app.showLiquidarModal('${turno.id}')" ${turno.liquidado ? 'disabled' : ''}><svg class="icon"><use href="#icon-check"></use></svg>Liquidar Turno</button>
                <button class="btn btn-danger" onclick="app.endShift('${turno.id}')">Finalizar Turno</button>`;

            return `${backButton}<div class="card"><div class="card-header"><h3>Gestionando Turno de: ${worker.nombre}</h3>${turno.liquidado ? '<span class="status-badge status-liquidado">LIQUIDADO</span>':''}</div><div class="stats-grid"><div class="stat-card"><svg class="icon"><use href="#icon-dollar"></use></svg><div class="stat-card-content"><h3>Ventas Generadas</h3><p>${cur(r.total_ingresos)}</p></div></div><div class="stat-card"><svg class="icon"><use href="#icon-clipboard"></use></svg><div class="stat-card-content"><h3>Fichas Ganadas</h3><p>${cur(r.total_fichas)}</p></div></div><div class="stat-card success"><svg class="icon"><use href="#icon-check"></use></svg><div class="stat-card-content"><h3>Pago Final</h3><p>${cur(r.pago_final_al_trabajador)}</p></div></div></div><h4 style="margin-top:2rem;">Despacho Rápido</h4><div class="dispatch-grid">${dispatchHTML}</div><div class="actions" style="display:flex; justify-content:flex-end; gap:0.5rem; margin-top:1rem; flex-wrap:wrap;"><button class="btn btn-secondary" onclick="app.showLoanModal('${turno.id}')" ${turno.liquidado ? 'disabled' : ''}>+ Préstamo</button><button class="btn btn-outline" onclick="app.showBreakdownModal('${turno.id}')">Ver Desglose</button>${!isWorkerView ? adminButtons : ''}</div></div>`;
        } else { 
            return `${backButton}<div class="empty-state"><h3>${worker.nombre} está inactivo.</h3><button class="btn btn-primary" onclick="app.startShift('${worker.id}')">+ Iniciar Turno para ${worker.nombre}</button></div>`; 
        }
    },
    viewWorkerDetail(workerId) { this.state.currentTurnoView = { type: 'detail', workerId }; this.renderAppUI(); },
    viewTurnoDashboard() { this.state.currentTurnoView = { type: 'dashboard', workerId: null }; this.renderAppUI(); },
    calculateSummary(turno) {
        let total_ingresos = 0, total_fichas = 0, total_prestamos = 0;
        turno.transacciones.forEach(t => {
            if (t.tipo === 'DESPACHO') { const p = this.state.productos.find(prod => prod.id === t.productoId); if (p) { total_ingresos += p.precio_venta * t.cantidad; total_fichas += p.valor_ficha * t.cantidad; } }
            else if (t.tipo === 'PRESTAMO') { total_prestamos += t.monto; }
        });
        const pago_base_turno = turno.pago_base_turno || 0;
        const pago_final_al_trabajador = total_fichas + pago_base_turno - total_prestamos;
        return { total_ingresos, total_fichas, total_prestamos, pago_base_turno, pago_final_al_trabajador };
    },
    startShift(workerId) { 
        if(this.state.trabajadores.length === 0){ this.showToast('Primero debe registrar trabajadores en Configuración.', 'error'); return; } 
        const trab = this.state.trabajadores.find(t => t.id === workerId); 
        if(this.state.turnosActivos.some(t => t.trabajador.id === workerId)) { this.showToast('Este trabajador ya tiene un turno activo.', 'error'); return; } 
        this.state.turnosActivos.push({ id: this.uid(), trabajador: trab, fecha_inicio: new Date().toISOString(), transacciones: [], liquidado: false, pago_base_turno: 0 }); 
        this.saveState(); 
        if (this.state.currentUserType === 'admin') {
            this.viewWorkerDetail(workerId);
        } else {
            this.renderWorkerView();
        }
    },
    endShift(turnoId) {
        const turno = this.state.turnosActivos.find(t => t.id === turnoId);
        if (!turno.liquidado) { this.showToast('Debe liquidar el turno antes de finalizarlo.', 'error'); return; }
        this.showConfirmationModal("¿Finalizar y archivar este turno liquidado?", () => {
            const idx = this.state.turnosActivos.findIndex(t => t.id === turnoId);
            const turnoFinalizado = this.state.turnosActivos[idx];
            turnoFinalizado.fecha_fin = new Date().toISOString();
            turnoFinalizado.summary = this.calculateSummary(turnoFinalizado);
            this.state.historial.push(turnoFinalizado);
            this.state.turnosActivos.splice(idx, 1);
            this.saveState();
            this.viewTurnoDashboard();
            this.showToast('Turno archivado con éxito');
        });
    },
    confirmDispatch() { 
        const cant = parseInt(document.getElementById('input-cantidad').value); 
        const turno = this.state.turnosActivos.find(t => t.id === this._tempData.turnoId); 
        const prod = this.state.productos.find(p => p.id === this._tempData.productoId); 
        if (!cant || cant <= 0) { this.showToast("Cantidad inválida.", 'error'); return; } 
        if (prod.stock_actual < cant) { this.showToast(`Error de Stock: Solo quedan ${prod.stock_actual} unidades.`, 'error'); return; } 
        prod.stock_actual -= cant; 
        turno.transacciones.push({ tipo: 'DESPACHO', productoId: this._tempData.productoId, cantidad: cant, timestamp: new Date().toISOString() }); 
        this.closeModal(); 
        this.saveState(); 
        this.renderUI(); 
    },
    confirmLoan() { 
        const monto = parseFloat(document.getElementById('input-monto').value); 
        const desc = document.getElementById('input-descripcion').value.trim(); 
        if (!monto || monto <= 0 || !desc) { this.showToast("Todos los campos son obligatorios.", 'error'); return; } 
        const turno = this.state.turnosActivos.find(t => t.id === this._tempData.turnoId); 
        turno.transacciones.push({ tipo: 'PRESTAMO', monto: monto, descripcion: desc, timestamp: new Date().toISOString() }); 
        this.closeModal(); 
        this.saveState(); 
        this.renderUI(); 
    },
    confirmLiquidacion() {
        const monto = parseFloat(document.getElementById('input-pago-base').value);
        if (isNaN(monto) || monto < 0) { this.showToast("Debe ingresar un pago base válido (puede ser 0).", 'error'); return; }
        const turno = this.state.turnosActivos.find(t => t.id === this._tempData.turnoId);
        const summary = this.calculateSummary(turno);
        summary.pago_base_turno = monto;
        const pagoFinal = summary.total_fichas + summary.pago_base_turno - summary.total_prestamos;
        if (summary.total_ingresos > 0) { this.addTransaccionCaja('ingreso', summary.total_ingresos, `Ventas del turno de ${turno.trabajador.nombre}`); }
        if (pagoFinal > 0) { this.addTransaccionCaja('egreso', pagoFinal, `Pago liquidación a ${turno.trabajador.nombre}`); }
        turno.pago_base_turno = monto;
        turno.liquidado = true;
        this.closeModal();
        this.saveState();
        this.renderUI();
        this.showToast('Turno liquidado y movimientos registrados en caja.');
    },
    renderInventario() { this.renderBodega(); this.renderBarra(); },
    renderBodega() {
        const container = document.getElementById('bodega-table-container');
        const currency = (v) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(v);
        
        const activePurchases = this.state.compras.filter(p => !p.archived);
        
        let tbl = '';
        if (activePurchases.length === 0) {
            tbl = `<div class="empty-state">No hay compras activas en la bodega.</div>`;
        } else {
            tbl = `<table class="management-table"><thead><tr><th>Referencia</th><th>Proveedor</th><th>Costo Total</th><th>Deuda</th><th>Estado</th><th></th></tr></thead><tbody>`;
            activePurchases.forEach(p => {
                const proveedor = this.state.proveedores.find(prov => prov.id === p.id_proveedor);
                const estadoClass = { 'Pagado': 'status-pago-pagado', 'Parcial': 'status-pago-parcial', 'Pendiente': 'status-pago-pendiente' }[p.estado_pago] || '';
                
                tbl += `<tr>
                    <td data-label="Referencia">${p.nombre} <small style="display:block; color: var(--text-muted);">${new Date(p.timestamp).toLocaleDateString('es-CO')}</small></td>
                    <td data-label="Proveedor">${proveedor ? proveedor.nombre : 'N/A'}</td>
                    <td data-label="Costo Total">${currency(p.costo_total)}</td>
                    <td data-label="Deuda" style="color: ${p.monto_adeudado > 0 ? 'var(--danger-color)' : 'inherit'}; font-weight: bold;">${currency(p.monto_adeudado)}</td>
                    <td data-label="Estado"><span class="status-badge ${estadoClass}">${p.estado_pago}</span></td>
                    <td data-label="Acciones"><div class="actions">
                        <button class="btn btn-outline" onclick="app.showPurchaseDetailModal('${p.id}')">Ver Detalles</button>
                    </div></td>
                </tr>`;
            });
            tbl += '</tbody></table>';
        }

        const archivedPurchases = this.state.compras.filter(p => p.archived);
        let archivadosHTML = '';
        if (archivedPurchases.length > 0) {
            let archivadosTbl = `<table class="management-table"><thead><tr><th>Referencia</th><th>Proveedor</th><th>Fecha Archivo</th><th></th></tr></thead><tbody>`;
            archivedPurchases.slice().sort((a,b) => new Date(b.fecha_archivado) - new Date(a.fecha_archivado)).forEach(p => {
                const proveedor = this.state.proveedores.find(prov => prov.id === p.id_proveedor);
                archivadosTbl += `<tr>
                    <td data-label="Referencia">${p.nombre}</td>
                    <td data-label="Proveedor">${proveedor ? proveedor.nombre : 'N/A'}</td>
                    <td data-label="Fecha Archivo">${new Date(p.fecha_archivado).toLocaleDateString('es-CO')}</td>
                    <td data-label="Acciones"><div class="actions">
                        <button class="btn btn-icon btn-outline" title="Generar Recibo" onclick="app.generatePurchaseReceipt('${p.id}')"><svg class="icon"><use href="#icon-receipt"></use></svg></button>
                        <button class="btn btn-icon btn-danger" title="Eliminar Registro" onclick="app.deletePurchaseRecord('${p.id}')"><svg class="icon"><use href="#icon-trash"></use></svg></button>
                    </div></td>
                </tr>`;
            });
            archivadosTbl += '</tbody></table>';

            archivadosHTML = `
                <details class="history-details" style="margin-top: 2rem;">
                    <summary>Historial de Compras (Stock Agotado)</summary>
                    <div class="history-details-content">${archivadosTbl}</div>
                </details>`;
        }
        container.innerHTML = tbl + archivadosHTML;
    },
    renderBarra() { const c = document.getElementById('barra-table-container'); const cur = (v) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(v); if (this.state.productos.length === 0) { c.innerHTML = `<div class="empty-state">No hay productos definidos para la venta.</div>`; return; } let tbl = `<table class="management-table"><thead><tr><th>Producto en Barra</th><th>Stock Actual</th><th>P. Venta</th><th>P. Costo Unit.</th><th>Valor Inventario</th></tr></thead><tbody>`; this.state.productos.forEach(p => { const v = p.stock_actual * p.precio_costo_unitario; tbl += `<tr><td data-label="Producto">${p.nombre}</td><td data-label="Stock" style="font-weight:bold;">${p.stock_actual}</td><td data-label="P. Venta">${cur(p.precio_venta)}</td><td data-label="P. Costo">${cur(p.precio_costo_unitario)}</td><td data-label="Valor">${cur(v)}</td></tr>`; }); c.innerHTML = tbl + '</tbody></table>'; },
    
    deletePurchaseRecord(id) {
        this.showConfirmationModal('¿Eliminar este registro de compra permanentemente? Esta acción es irreversible.', () => {
            const initialLength = this.state.compras.length;
            this.state.compras = this.state.compras.filter(p => p.id !== id);
            if(this.state.compras.length < initialLength) {
                this.saveState();
                this.renderInventario();
                this.closeModal();
                this.showToast('Registro de compra eliminado.', 'error');
            }
        });
    },

    showTrasladoModal(purchaseId, itemId) {
        const purchase = this.state.compras.find(p => p.id === purchaseId);
        const item = purchase.items.find(i => i.id === itemId);
        const producto = this.state.productos.find(p => p.id === item.id_producto_asociado);
        if (!item || !producto) { this.showToast('Error: No se encontró el item o producto asociado.', 'error'); return; }
        
        this._tempData.purchaseId = purchaseId;
        this._tempData.itemId = itemId;

        const stockEmbalado = Math.floor(item.unidades_disponibles / item.unidades_por_empaque);
        const stockSuelto = item.unidades_disponibles % item.unidades_por_empaque;
        
        const contentHTML = `<h2>Trasladar Stock a Barra</h2>
            <p>Desde la compra: <strong>${purchase.nombre}</strong></p>
            <p>Producto: <strong>${producto.nombre}</strong></p>
            <div class="form-summary">Stock disponible en este lote: <strong>${stockEmbalado} ${item.tipo_empaque}s y ${stockSuelto} unidades</strong> (${item.unidades_disponibles} total)</div>
            <form id="traslado-form" style="margin-top: 1.5rem;">
                <div class="form-group"><label for="traslado-unidades">Cantidad de Unidades a trasladar</label><input type="number" id="traslado-unidades" min="0" max="${item.unidades_disponibles}" placeholder="0" required></div>
                <button type="button" class="btn btn-outline" style="width:100%; margin: 1rem 0;" onclick="document.getElementById('traslado-unidades').value = ${item.unidades_disponibles}">Trasladar Lote Completo</button>
                <div class="actions" style="justify-content:flex-end; gap:0.5rem;"><button type="button" class="btn btn-secondary" onclick="app.closeModal()">Cancelar</button><button type="submit" class="btn btn-primary">Confirmar Traslado</button></div>
            </form>`;
        this.showModal(contentHTML);
        
        document.getElementById('traslado-form').onsubmit = (e) => { e.preventDefault(); this.confirmTraslado(); };
    },
    
    confirmTraslado() {
        const purchase = this.state.compras.find(p => p.id === this._tempData.purchaseId);
        const item = purchase.items.find(i => i.id === this._tempData.itemId);
        const producto = this.state.productos.find(p => p.id === item.id_producto_asociado);
        const totalATrasladar = parseInt(document.getElementById('traslado-unidades').value) || 0;

        if (totalATrasladar <= 0) { this.showToast('Debes ingresar una cantidad a trasladar.', 'error'); return; }
        if (totalATrasladar > item.unidades_disponibles) { this.showToast(`No puedes trasladar más de las ${item.unidades_disponibles} unidades disponibles.`, 'error'); return; }

        producto.stock_actual += totalATrasladar;
        item.unidades_disponibles -= totalATrasladar;

        const allItemsEmpty = purchase.items.every(i => i.unidades_disponibles === 0);
        if (allItemsEmpty) {
            purchase.archived = true;
            purchase.fecha_archivado = new Date().toISOString();
            this.showToast(`Stock trasladado. Compra '${purchase.nombre}' completada y archivada.`);
        } else {
            this.showToast(`${totalATrasladar} unidades trasladadas a la barra.`);
        }
        
        this.saveState(); 
        this.renderInventario(); 
        this.closeModal();
    },
    renderHistorialTab() {
        this.renderHistorialTurnos();
        this.renderHistorialCaja();
    },
    renderHistorialTurnos() {
        const container = document.getElementById('historial-turnos-container'); 
        if (!this.state.historial || this.state.historial.length === 0) { 
            container.innerHTML = `<div class="empty-state" style="padding:1.5rem">No hay turnos finalizados en el historial.</div>`; 
            return; 
        }
        const sortedHistory = [...this.state.historial].sort((a, b) => new Date(b.fecha_fin) - new Date(a.fecha_fin));
        const currency = (v) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(v);
        container.innerHTML = sortedHistory.map(turno => {
            const summary = turno.summary || this.calculateSummary(turno);
            return `<details class="history-details"><summary><div><strong>${turno.trabajador.nombre}</strong><br><small>${new Date(turno.fecha_inicio).toLocaleDateString('es-CO')} | ${new Date(turno.fecha_inicio).toLocaleTimeString('es-CO', {hour: '2-digit', minute:'2-digit'})} - ${new Date(turno.fecha_fin).toLocaleTimeString('es-CO', {hour: '2-digit', minute:'2-digit'})}</small></div><span style="font-weight: normal; font-size: 0.9em; color: var(--success-color)">${currency(summary.pago_final_al_trabajador)}</span></summary><div class="history-details-content"><h4 style="margin-top:1.5rem">Resumen Financiero del Turno</h4><div class="stats-grid"><div class="stat-card"><div class="stat-card-content"><h5>Ventas</h5><p style="font-size:1.5rem">${currency(summary.total_ingresos)}</p></div></div><div class="stat-card"><div class="stat-card-content"><h5>Fichas</h5><p style="font-size:1.5rem">${currency(summary.total_fichas)}</p></div></div><div class="stat-card"><div class="stat-card-content"><h5>Pago Base</h5><p style="font-size:1.5rem">${currency(summary.pago_base_turno)}</p></div></div><div class="stat-card danger"><div class="stat-card-content"><h5>Préstamos</h5><p style="font-size:1.5rem;">${currency(summary.total_prestamos)}</p></div></div></div><div class="actions" style="justify-content:flex-end; margin-top:1rem; gap: 0.5rem;"><button class="btn btn-outline" onclick="app.showHistoryBreakdownModal('${turno.id}')">Ver Desglose</button><button class="btn btn-danger" onclick="app.deleteHistoryEntry('${turno.id}')"><svg class="icon"><use href="#icon-trash"></use></svg>Eliminar</button></div></div></details>`;
        }).join('');
    },
    renderHistorialCaja() {
        const container = document.getElementById('historial-caja-container');
        if (!this.state.historialCaja || this.state.historialCaja.length === 0) {
            container.innerHTML = `<div class="empty-state" style="padding:1.5rem">No hay cierres de caja en el historial.</div>`;
            return;
        }
        const sortedHistory = [...this.state.historialCaja].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
        const currency = (v) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(v);
        
        container.innerHTML = sortedHistory.map(cierre => {
            const { fecha, resumen, transacciones } = cierre;
            const fechaFormateada = new Date(fecha + 'T00:00:00').toLocaleDateString('es-CO', { year: 'numeric', month: 'long', day: 'numeric' });
            
            const transaccionesHTML = transacciones.length > 0
                ? `<table class="management-table" style="margin-top:1rem;"><tbody>${transacciones.map(tx => `<tr><td data-label="Hora">${new Date(tx.timestamp).toLocaleTimeString('es-CO', {hour:'2-digit', minute:'2-digit'})}</td><td data-label="Descripción">${tx.descripcion}</td><td data-label="Monto" class="${tx.tipo === 'ingreso' ? 'caja-tx-ingreso' : 'caja-tx-egreso'}">${currency(tx.monto)}</td></tr>`).join('')}</tbody></table>`
                : '<p>No hubo transacciones este día.</p>';

            return `<details class="history-details">
                <summary>
                    <div><strong>${fechaFormateada}</strong></div>
                    <span style="font-weight: normal; font-size: 0.9em;">Saldo Final: ${currency(resumen.saldoActual)}</span>
                </summary>
                <div class="history-details-content">
                    <div class="liquidacion-summary" style="margin-top:1rem;">
                        <p>Saldo Inicial: <span>${currency(resumen.saldoInicial)}</span></p>
                        <p>Total Ingresos: <span>${currency(resumen.totalIngresos)}</span></p>
                        <p>Total Egresos: <span>${currency(resumen.totalEgresos)}</span></p>
                        <hr>
                        <p><strong>Saldo Final:</strong> <strong><span>${currency(resumen.saldoActual)}</span></strong></p>
                    </div>
                    <h4 style="margin-top:1.5rem">Desglose de Movimientos</h4>
                    ${transaccionesHTML}
                </div>
            </details>`;
        }).join('');
    },
    deleteHistoryEntry(turnoId) { this.showConfirmationModal('¿Está seguro de que desea eliminar este turno del historial? Esta acción es permanente y no se puede deshacer.', () => { const index = this.state.historial.findIndex(t => t.id === turnoId); if (index > -1) { this.state.historial.splice(index, 1); this.saveState(); this.renderHistorialTab(); this.showToast('Turno eliminado del historial.', 'error'); } }); },
    renderReportUI() { 
        document.getElementById('report-container').innerHTML = '<p style="color:var(--secondary-color)">Seleccione un rango de fechas y horas y presione "Generar Reporte".</p>'; 
        document.getElementById('report-export-buttons').style.display = 'none';
        this.currentReportData = null;
    },
    generateReport() {
        const startInput = document.getElementById('report-start-date').value, endInput = document.getElementById('report-end-date').value; if (!startInput || !endInput) { this.showToast('Debe seleccionar una fecha y hora de inicio y fin.', 'error'); return; }
        const start = new Date(startInput), end = new Date(endInput); const turnos = this.state.historial.filter(t => { const d = new Date(t.fecha_fin); return d >= start && d <= end; });
        const container = document.getElementById('report-container'); if (turnos.length === 0) { container.innerHTML = `<div class="empty-state">No hay turnos finalizados en el rango de fechas y horas seleccionado.</div>`; document.getElementById('report-export-buttons').style.display = 'none'; return; }
        let totalIngresos = 0, totalCostos = 0; const ventasProductos = {}, analisisTrabajador = {}, transaccionesLog = []; const reportData = { ingresosItems: [], costosItems: [], pagosItems: [] };
        this.state.trabajadores.forEach(t => { analisisTrabajador[t.nombre] = { turnos: 0, ingresos: 0, costos: 0, gananciaBruta: 0, comisiones: 0, pagoBase: 0, prestamos: 0, pagoNeto: 0 }; });
        turnos.forEach(turno => {
            const trabNombre = turno.trabajador.nombre, summary = turno.summary; if (!summary) return;
            analisisTrabajador[trabNombre].turnos++; analisisTrabajador[trabNombre].pagoBase += summary.pago_base_turno || 0; analisisTrabajador[trabNombre].prestamos += summary.total_prestamos || 0; analisisTrabajador[trabNombre].pagoNeto += summary.pago_final_al_trabajador || 0;
            turno.transacciones.forEach(tx => {
                const txDate = new Date(tx.timestamp); if (tx.tipo === 'DESPACHO') {
                    const p = this.state.productos.find(prod => prod.id === tx.productoId); if (!p) return; const ingresos = p.precio_venta * tx.cantidad, costos = p.precio_costo_unitario * tx.cantidad;
                    totalIngresos += ingresos; totalCostos += costos; reportData.ingresosItems.push({ detalle: `${tx.cantidad} x ${p.nombre}`, valor: ingresos }); reportData.costosItems.push({ detalle: `Costo de ${tx.cantidad} x ${p.nombre}`, valor: costos });
                    if (!ventasProductos[p.nombre]) { ventasProductos[p.nombre] = { cantidad: 0, ingresos: 0, costos: 0, gananciaBruta: 0 }; }
                    ventasProductos[p.nombre].cantidad += tx.cantidad; ventasProductos[p.nombre].ingresos += ingresos; ventasProductos[p.nombre].costos += costos; ventasProductos[p.nombre].gananciaBruta += (ingresos - costos);
                    analisisTrabajador[trabNombre].ingresos += ingresos; analisisTrabajador[trabNombre].costos += costos; analisisTrabajador[trabNombre].gananciaBruta += (ingresos - costos); analisisTrabajador[trabNombre].comisiones += p.valor_ficha * tx.cantidad; transaccionesLog.push({ fecha: txDate, trabajador: trabNombre, tipo: 'Venta', detalle: `${tx.cantidad} x ${p.nombre}`, monto: ingresos });
                } else if (tx.tipo === 'PRESTAMO') { transaccionesLog.push({ fecha: txDate, trabajador: trabNombre, tipo: 'Préstamo', detalle: tx.descripcion, monto: -tx.monto }); }
            });
        });
        Object.entries(analisisTrabajador).forEach(([nombre, data]) => { if (data.pagoNeto !== 0) { reportData.pagosItems.push({ detalle: `Pago Neto a ${nombre}`, valor: data.pagoNeto }); } });
        const totalPagosNeto = reportData.pagosItems.reduce((sum, item) => sum + item.valor, 0); const gananciaBrutaTotal = totalIngresos - totalCostos, gastosOperativos = totalCostos + totalPagosNeto, gananciaNeta = totalIngresos - gastosOperativos;
        const margenNeto = totalIngresos > 0 ? (gananciaNeta / totalIngresos) * 100 : 0; const currency = (v) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(v);
        const ventasData = Object.entries(ventasProductos).map(([k, v]) => ({ 'Producto': k, 'Uds.': v.cantidad, 'Ingresos': v.ingresos, 'Costo Total': v.costos, 'Ganancia Bruta': v.gananciaBruta, 'Margen (%)': v.ingresos > 0 ? ((v.gananciaBruta / v.ingresos) * 100).toFixed(1) + '%' : 'N/A' })).sort((a, b) => b['Ganancia Bruta'] - a['Ganancia Bruta']);
        const trabajadorData = Object.entries(analisisTrabajador).filter(([k,v]) => v.turnos > 0).map(([k, v]) => ({ 'Trabajador': k, 'Turnos': v.turnos, 'Ingresos Gen.': v.ingresos, 'Ganancia Bruta Gen.': v.gananciaBruta, 'Comisiones': v.comisiones, 'Pago Base': v.pagoBase, 'Préstamos': v.prestamos, 'Pago Neto': v.pagoNeto }));
        const txLogData = transaccionesLog.sort((a,b) => a.fecha - b.fecha).map(log => ({ 'Fecha y Hora': log.fecha.toLocaleString('es-CO'), 'Trabajador': log.trabajador, 'Tipo': log.tipo, 'Detalle': log.detalle, 'Monto': log.monto }));
        
        this.currentReportData = {
            summary: { totalIngresos, gananciaBrutaTotal, gastosOperativos, gananciaNeta, margenNeto },
            ventasData,
            trabajadorData,
            txLogData,
            dateRange: { start: start.toLocaleString('es-CO'), end: end.toLocaleString('es-CO') },
            ...reportData
        };

        const currencyCols = ['Ingresos', 'Costo Total', 'Ganancia Bruta', 'Ingresos Gen.', 'Ganancia Bruta Gen.', 'Comisiones', 'Pago Base', 'Préstamos', 'Pago Neto', 'Monto'];
        container.innerHTML = `<div class="card" style="margin-bottom: 2rem;"><h3 class="card-header" style="border:0; padding:0; margin-bottom:1.5rem;">Resumen Financiero General</h3><div class="stats-grid"><div class="stat-card clickable-stat-card" onclick="app.showReportBreakdownModal('ingresos')"><div class="stat-card-content"><h5>Ingresos por Ventas</h5><p>${currency(totalIngresos)}</p></div></div><div class="stat-card clickable-stat-card" onclick="app.showReportBreakdownModal('bruta')"><div class="stat-card-content"><h5>Ganancia Bruta</h5><p>${currency(gananciaBrutaTotal)}</p></div></div><div class="stat-card danger clickable-stat-card" onclick="app.showReportBreakdownModal('gastos')"><div class="stat-card-content"><h5>Gastos Operativos</h5><p>${currency(gastosOperativos)}</p></div></div><div class="stat-card success clickable-stat-card" onclick="app.showReportBreakdownModal('neta')"><div class="stat-card-content"><h5>Ganancia Neta</h5><p>${currency(gananciaNeta)}</p></div></div></div><div class="stat-card" style="margin-top: 1rem;"><div class="stat-card-content" style="width:100%; text-align:center;"><h5>Margen de Beneficio Neto</h5><p>${margenNeto.toFixed(1)}%</p></div></div></div><div class="card" style="margin-bottom: 2rem;"><h3 class="card-header" style="border:0; padding:0; margin-bottom:1.5rem;">Análisis de Ventas por Producto</h3>${this.generateTableHTML(ventasData, ['Producto', 'Uds.', 'Ingresos', 'Costo Total', 'Ganancia Bruta', 'Margen (%)'], currencyCols)}</div><div class="card" style="margin-bottom: 2rem;"><h3 class="card-header" style="border:0; padding:0; margin-bottom:1.5rem;">Análisis de Desempeño por Trabajador</h3>${this.generateTableHTML(trabajadorData, ['Trabajador', 'Turnos', 'Ingresos Gen.', 'Ganancia Bruta Gen.', 'Comisiones', 'Pago Base', 'Préstamos', 'Pago Neto'], currencyCols)}</div><details class="report-details"><summary>Ver Registro Detallado de Transacciones (${txLogData.length} eventos)</summary><div class="report-details-content" style="padding-top: 1rem;">${this.generateTableHTML(txLogData, ['Fecha y Hora', 'Trabajador', 'Tipo', 'Detalle', 'Monto'], currencyCols)}</div></details>`;
        document.getElementById('report-export-buttons').style.display = 'flex';
    },
    generateTableHTML(data, headers, currencyColumns = []) {
        if (data.length === 0) return '<div class="empty-state" style="padding: 1.5rem 1rem;">No hay datos para esta sección.</div>';
        let head = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
        let body = `<tbody>${data.map(row => { const cells = headers.map(h => { const val = row[h]; const formattedVal = currencyColumns.includes(h) && typeof val === 'number' ? new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(val) : (val === undefined ? '' : val); return `<td data-label="${h}">${formattedVal}</td>`; }).join(''); return `<tr>${cells}</tr>`; }).join('')}</tbody>`;
        return `<div style="overflow-x:auto;"><table class="management-table">${head}${body}</table></div>`;
    },
    showReportBreakdownModal(metricKey) {
        if (!this.currentReportData) return; const currency = (v) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(v);
        const { ingresosItems, costosItems, pagosItems } = this.currentReportData;
        const totalIngresos = ingresosItems.reduce((sum, item) => sum + item.valor, 0), totalCostos = costosItems.reduce((sum, item) => sum + item.valor, 0), totalPagos = pagosItems.reduce((sum, item) => sum + item.valor, 0);
        let title = '', contentHTML = '';
        const buildListHTML = (title, items, total) => { let listHTML = `<h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">${title}</h4>`; if (items.length === 0) { listHTML += '<p style="color:var(--text-muted);">No hay datos para esta sección.</p>'; } else { listHTML += items.map(item => `<p style="display:flex; justify-content:space-between; margin:0.4rem 0; border-bottom: 1px dashed var(--border-color); padding-bottom: 0.4rem;"><span>${item.detalle}</span><strong>${currency(item.valor)}</strong></p>`).join(''); } listHTML += `<p style="display:flex; justify-content:space-between; margin-top:0.8rem; font-size:1.1em;"><strong>Subtotal:</strong><strong>${currency(total)}</strong></p>`; return listHTML; };
        switch (metricKey) {
            case 'ingresos': title = 'Desglose de Ingresos por Ventas'; contentHTML = buildListHTML('Ventas Registradas', ingresosItems, totalIngresos); break;
            case 'gastos': title = 'Desglose de Gastos Operativos'; const totalGastos = totalCostos + totalPagos; contentHTML = `${buildListHTML('Costos de los Productos Vendidos', costosItems, totalCostos)}${buildListHTML('Pagos Netos a Trabajadores', pagosItems, totalPagos)}<hr style="margin: 1.5rem 0;"><div class="liquidacion-summary" style="background-color: transparent; padding: 0;"><p>Total Costos: <span>${currency(totalCostos)}</span></p><p>(+) Total Pagos: <span>${currency(totalPagos)}</span></p><hr><p><strong>Total Gastos Operativos:</strong> <strong><span>${currency(totalGastos)}</span></strong></p></div>`; break;
            case 'bruta': title = 'Cálculo de Ganancia Bruta'; const gananciaBruta = totalIngresos - totalCostos; contentHTML = `<div class="liquidacion-summary"><p>Total Ingresos por Ventas: <span>${currency(totalIngresos)}</span></p><p>(-) Costo de Productos Vendidos: <span style="color:var(--danger-color)">${currency(totalCostos)}</span></p><hr><p><strong>Total Ganancia Bruta:</strong> <strong><span>${currency(gananciaBruta)}</span></strong></p></div>`; break;
            case 'neta': title = 'Cálculo de Ganancia Neta'; const gananciaNeta = totalIngresos - (totalCostos + totalPagos); contentHTML = `<div class="liquidacion-summary"><p>Total Ingresos por Ventas: <span>${currency(totalIngresos)}</span></p><p>(-) Gastos Operativos: <span style="color:var(--danger-color)">${currency(totalCostos + totalPagos)}</span></p><hr><p><strong>Total Ganancia Neta:</strong> <strong><span>${currency(gananciaNeta)}</span></strong></p></div>`; break;
        }
        this.showModal(`<h2>${title}</h2><div>${contentHTML}</div><div class="actions" style="justify-content:flex-end; margin-top:1.5rem;"><button class="btn btn-secondary" onclick="app.closeModal()">Cerrar</button></div>`);
    },
    generatePdfReport() {
        if (!this.currentReportData) { this.showToast('Primero debe generar un reporte.', 'error'); return; }
        const { summary, ventasData, trabajadorData, txLogData, dateRange } = this.currentReportData;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const currency = (v) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(v);
        let y = 15;

        doc.setFontSize(18); doc.text(`Reporte Financiero - ${this.state.business.name}`, 14, y); y += 8;
        doc.setFontSize(11); doc.setTextColor(100); doc.text(`Periodo: ${dateRange.start} - ${dateRange.end}`, 14, y); y += 12;

        doc.setFontSize(12); doc.text('Resumen General', 14, y); y += 6;
        doc.autoTable({ startY: y, body: [['Ingresos por Ventas', currency(summary.totalIngresos)], ['Ganancia Bruta', currency(summary.gananciaBrutaTotal)], ['Gastos Operativos', currency(summary.gastosOperativos)], ['Ganancia Neta', currency(summary.gananciaNeta)], ['Margen Neto', `${summary.margenNeto.toFixed(1)}%`]], theme: 'grid', styles: { fontSize: 10 }, headStyles: { fillColor: [59, 130, 246] } });
        y = doc.autoTable.previous.finalY + 10;

        const addTable = (title, data, headers) => {
            if (data.length > 0) {
                doc.setFontSize(12); doc.text(title, 14, y); y += 6;
                doc.autoTable({ startY: y, head: [headers], body: data.map(row => headers.map(header => row[header])), theme: 'striped', styles: { fontSize: 8 }, headStyles: { fillColor: [59, 130, 246] } });
                y = doc.autoTable.previous.finalY + 10;
            }
        };

        addTable('Análisis de Ventas por Producto', ventasData, ['Producto', 'Uds.', 'Ingresos', 'Costo Total', 'Ganancia Bruta', 'Margen (%)']);
        addTable('Análisis por Trabajador', trabajadorData, ['Trabajador', 'Turnos', 'Ingresos Gen.', 'Ganancia Bruta Gen.', 'Pago Neto']);
        addTable('Registro de Transacciones', txLogData, ['Fecha y Hora', 'Trabajador', 'Tipo', 'Detalle', 'Monto']);

        doc.save(`Reporte_${this.state.business.name}_${new Date().toISOString().split('T')[0]}.pdf`);
    },

    generateExcelReport() {
        if (!this.currentReportData) { this.showToast('Primero debe generar un reporte.', 'error'); return; }
        const { summary, ventasData, trabajadorData, txLogData, dateRange } = this.currentReportData;
        
        const wb = XLSX.utils.book_new();
        const summarySheetData = [['Reporte Financiero', this.state.business.name], ['Periodo', `${dateRange.start} - ${dateRange.end}`], [], ['Métrica', 'Valor'], ['Ingresos por Ventas', summary.totalIngresos], ['Ganancia Bruta', summary.gananciaBrutaTotal], ['Gastos Operativos', summary.gastosOperativos], ['Ganancia Neta', summary.gananciaNeta], ['Margen Neto (%)', summary.margenNeto]];
        const wsSummary = XLSX.utils.aoa_to_sheet(summarySheetData);
        XLSX.utils.book_append_sheet(wb, wsSummary, 'Resumen');

        if(ventasData.length > 0) { XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(ventasData), 'Ventas por Producto'); }
        if(trabajadorData.length > 0) { XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(trabajadorData), 'Desempeño Trabajadores'); }
        if(txLogData.length > 0) { XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(txLogData), 'Log de Transacciones'); }
        
        XLSX.writeFile(wb, `Reporte_Excel_${this.state.business.name}_${new Date().toISOString().split('T')[0]}.xlsx`);
    },
    
    _getTurnoBreakdownHTML(turno) {
        const currency = (v) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(v); const fichas = {}; let prestamosHTML = '';
        turno.transacciones.forEach(t => { if (t.tipo === 'DESPACHO') { const p = this.state.productos.find(prod => prod.id === t.productoId); if(p) { if (!fichas[p.nombre]) fichas[p.nombre] = { cantidad: 0, total: 0 }; fichas[p.nombre].cantidad += t.cantidad; fichas[p.nombre].total += t.cantidad * p.valor_ficha; } } else if (t.tipo === 'PRESTAMO') { prestamosHTML += `<li><strong>${currency(t.monto)}:</strong> ${t.descripcion} <em>(${new Date(t.timestamp).toLocaleTimeString('es-CO')})</em></li>`; } });
        let fichasHTML = Object.keys(fichas).length > 0 ? '<h4>Despachos (Fichas)</h4><ul>' + Object.entries(fichas).map(([n, d]) => `<li><strong>${n}:</strong> ${d.cantidad} uds. &rarr; ${currency(d.total)}</li>`).join('') + '</ul>' : '<h4>No hay despachos registrados.</h4>';
        if(prestamosHTML) prestamosHTML = '<h4>Préstamos</h4><ul>' + prestamosHTML + '</ul>'; return { fichasHTML, prestamosHTML };
    },
    showBreakdownModal(turnoId) { const turno = this.state.turnosActivos.find(t => t.id === turnoId); const { fichasHTML, prestamosHTML } = this._getTurnoBreakdownHTML(turno); this.showModal(`<h2>Desglose: ${turno.trabajador.nombre}</h2>${fichasHTML}${prestamosHTML}<div class="actions" style="justify-content:flex-end; margin-top:1.5rem;"><button class="btn btn-secondary" onclick="app.closeModal()">Cerrar</button></div>`); },
    showHistoryBreakdownModal(turnoId) { const turno = this.state.historial.find(t => t.id === turnoId); const { fichasHTML, prestamosHTML } = this._getTurnoBreakdownHTML(turno); this.showModal(`<h2>Desglose Histórico: ${turno.trabajador.nombre}</h2><p>Turno del ${new Date(turno.fecha_inicio).toLocaleDateString('es-CO')}</p>${fichasHTML}${prestamosHTML}<div class="actions" style="justify-content:flex-end; margin-top:1.5rem;"><button class="btn btn-secondary" onclick="app.closeModal()">Cerrar</button></div>`); },
    showLiquidarModal(turnoId) {
        if (!this.isCajaAbierta()) { this.showToast('Debes iniciar la caja del día para poder liquidar un turno.', 'error'); return; }
        this._tempData.turnoId = turnoId; const turno = this.state.turnosActivos.find(t => t.id === turnoId); const summary = this.calculateSummary(turno); const currency = (v) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(v);
        this.showModal(`<h2>Liquidar Turno de ${turno.trabajador.nombre}</h2><div class="form-group"><label for="input-pago-base">Pago Base del Turno (Sueldo Fijo)</label><input type="number" id="input-pago-base" value="${turno.pago_base_turno || 0}" required></div><div class="liquidacion-summary"><p>Fichas Ganadas (Comisión): <span>${currency(summary.total_fichas)}</span></p><p>(+) Pago Base del Turno: <span id="pago-base-display">${currency(turno.pago_base_turno || 0)}</span></p><p>(-) Préstamos: <span style="color:var(--danger-color)">${currency(summary.total_prestamos)}</span></p><hr><p><strong>Total a Pagar al Trabajador:</strong> <strong><span id="total-pagar-display">${currency(summary.pago_final_al_trabajador)}</span></strong></p></div><form id="liquidacion-form" style="margin-top:1.5rem;"><div class="actions" style="justify-content:flex-end; gap:0.5rem;"><button type="button" class="btn btn-secondary" onclick="app.closeModal()">Cancelar</button><button type="submit" class="btn btn-success">Confirmar Liquidación</button></div></form>`);
        const pagoBaseInput = document.getElementById('input-pago-base');
        pagoBaseInput.addEventListener('input', (e) => { const pagoBase = parseFloat(e.target.value) || 0; const pagoFinal = summary.total_fichas + pagoBase - summary.total_prestamos; document.getElementById('pago-base-display').textContent = currency(pagoBase); document.getElementById('total-pagar-display').textContent = currency(pagoFinal); });
        document.getElementById('liquidacion-form').onsubmit = (e) => { e.preventDefault(); this.confirmLiquidacion(); }; pagoBaseInput.focus();
    },
    showQuantityModal(turnoId, productoId) {
        this._tempData = { turnoId, productoId }; const p = this.state.productos.find(prod => prod.id === productoId);
        this.showModal(`<h2>Asignar: ${p.nombre}</h2><form id="dispatch-form"><div class="form-group"><label>Cantidad (Stock Actual: ${p.stock_actual})</label><div class="quantity-control"><button type="button" class="btn btn-secondary" id="btn-qty-minus">-</button><input type="number" id="input-cantidad" value="1" min="1" max="${p.stock_actual}" class="form-group" style="margin:0; flex-grow:1;"><button type="button" class="btn btn-secondary" id="btn-qty-plus">+</button></div></div><div class="actions" style="justify-content:flex-end; gap:0.5rem;"><button type="button" class="btn btn-secondary" onclick="app.closeModal()">Cancelar</button><button type="submit" class="btn btn-primary">Confirmar</button></div></form>`);
        const input = document.getElementById('input-cantidad'), stock = p.stock_actual;
        document.getElementById('btn-qty-minus').addEventListener('click', () => { const currentVal = parseInt(input.value); if (currentVal > 1) input.value = currentVal - 1; });
        document.getElementById('btn-qty-plus').addEventListener('click', () => { const currentVal = parseInt(input.value); if (currentVal < stock) input.value = currentVal + 1; });
        document.getElementById('dispatch-form').onsubmit = (e) => { e.preventDefault(); this.confirmDispatch(); }; input.focus();
    },
    showWorkerManagementModal() { let list = this.state.trabajadores.map(t => `<tr><td data-label="Nombre">${t.nombre}</td><td data-label="Rol">${t.rol || 'Vendedor'}</td><td data-label="Código">${t.loginCode || 'N/A'}</td><td data-label="Acciones"><div class="actions"><button class="btn btn-icon" onclick="app.showWorkerModal('${t.id}')"><svg class="icon"><use href="#icon-edit"></use></svg></button><button class="btn btn-icon" onclick="app.deleteWorker('${t.id}')"><svg class="icon"><use href="#icon-trash"></use></svg></button></div></td></tr>`).join(''); this.showModal(`<h2>Gestionar Trabajadores</h2><div style="overflow-x:auto;"><table class="management-table"><thead><tr><th>Nombre</th><th>Rol</th><th>Código</th><th></th></tr></thead><tbody>${list}</tbody></table></div><div class="actions" style="justify-content:space-between; margin-top:1.5rem;"><button class="btn btn-secondary" onclick="app.closeModal()">Cerrar</button><button class="btn btn-primary" onclick="app.showWorkerModal()">+ Añadir Trabajador</button></div>`, 'large'); },
    showWorkerModal(id=null) { 
        const w = id ? this.state.trabajadores.find(t=>t.id===id) : null; 
        this.showModal(`<h2>${w ? 'Editar':'Añadir'} Trabajador</h2>
            <form id="w-form">
                <div class="form-group"><label>Nombre Completo</label><input id="w-name" value="${w ? w.nombre : ''}" required></div>
                <div class="form-group"><label>Rol</label><input id="w-role" value="${w ? w.rol : 'Vendedor'}" required></div>
                <div class="form-group"><label>Código de Acceso (Numérico)</label><input id="w-code" type="password" pattern="[0-9]*" inputmode="numeric" value="" placeholder="${w ? 'Dejar en blanco para no cambiar' : ''}" ${!w ? 'required' : ''}></div>
                <div class="actions" style="justify-content:flex-end; gap:0.5rem;"><button class="btn btn-secondary" type="button" onclick="app.showWorkerManagementModal()">Cancelar</button><button class="btn btn-primary" type="submit">Guardar</button></div>
            </form>`); 
        document.getElementById('w-form').onsubmit = (e) => { e.preventDefault(); this.saveWorker(id); }; 
        document.getElementById('w-name').focus(); 
    },
    saveWorker(id) { 
        const name = document.getElementById('w-name').value.trim();
        const role = document.getElementById('w-role').value.trim();
        const loginCode = document.getElementById('w-code').value.trim();

        if(!name || !role) { this.showToast('Nombre y rol son obligatorios.', 'error'); return; }

        if (id) { 
            const worker = this.state.trabajadores.find(t=>t.id===id);
            worker.nombre = name;
            worker.rol = role;
            if (loginCode) worker.loginCode = loginCode;
            this.showToast('Trabajador actualizado'); 
        } else { 
            if (!loginCode) { this.showToast('El código es obligatorio para nuevos trabajadores.', 'error'); return; }
            this.state.trabajadores.push({id: this.uid(), nombre: name, rol: role, loginCode: loginCode}); 
            this.showToast('Trabajador creado con éxito'); 
        } 
        this.saveState(); 
        this.showWorkerManagementModal(); 
    },
    deleteWorker(id) { this.showConfirmationModal('¿Eliminar a este trabajador? No se podrá deshacer.', () => { this.state.trabajadores = this.state.trabajadores.filter(t => t.id !== id); this.saveState(); this.showWorkerManagementModal(); this.showToast('Trabajador eliminado', 'error'); }); },
    showProductManagementModal() {
        const c = (v) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(v);
        let listHTML = this.state.productos.map(p => {
            const lotesAsociados = this.state.compras.flatMap(compra => compra.items.filter(item => item.id_producto_asociado === p.id));
            let lotesHTML = lotesAsociados.length > 0
                ? `<div style="overflow-x:auto; margin-top:1rem;"><table class="management-table"><thead><tr><th>Compra</th><th>Proveedor</th><th>Stock Restante</th></tr></thead><tbody>
                    ${lotesAsociados.map(item => {
                        const compra = this.state.compras.find(c => c.items.some(i => i.id === item.id));
                        const prov = this.state.proveedores.find(pr => pr.id === compra.id_proveedor);
                        return `<tr><td>${compra.nombre}</td><td>${prov ? prov.nombre : 'N/A'}</td><td>${item.unidades_disponibles} uds.</td></tr>`;
                    }).join('')}
                </tbody></table></div>`
                : '<div class="empty-state" style="padding:1rem; margin-top:1rem;">No hay compras asociadas a este producto.</div>';

            return `<details class="history-details">
                <summary>
                    <div style="flex-grow:1; display:grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; align-items: center;">
                        <strong>${p.nombre}</strong>
                        <span>Venta: ${c(p.precio_venta)}</span>
                        <span>Costo: ${c(p.precio_costo_unitario)}</span>
                        <span>Ficha: ${c(p.valor_ficha)}</span>
                    </div>
                    <div class="actions" onclick="event.stopPropagation()">
                        <button class="btn btn-icon" onclick="app.showProductModal('${p.id}')"><svg class="icon"><use href="#icon-edit"></use></svg></button>
                        <button class="btn btn-icon" onclick="app.deleteProduct('${p.id}')"><svg class="icon"><use href="#icon-trash"></use></svg></button>
                    </div>
                </summary>
                <div class="history-details-content">${lotesHTML}</div>
            </details>`;
        }).join('');
        
        if (this.state.productos.length === 0) {
            listHTML = `<div class="empty-state">No hay plantillas de productos creadas.</div>`;
        }

        this.showModal(`<h2>Plantillas de Productos Vendibles</h2><div id="product-list-container">${listHTML}</div><div class="actions" style="justify-content:space-between; margin-top:1.5rem;"><button class="btn btn-secondary" onclick="app.closeModal()">Cerrar</button><button class="btn btn-primary" onclick="app.showProductModal()">+ Añadir Producto</button></div>`, 'large');
    },
    showProductModal(id=null) { const p = id ? this.state.productos.find(pr=>pr.id===id) : null; this.showModal(`<h2>${p ? 'Editar':'Añadir'} Producto</h2><form id="p-form"><div class="form-group"><label>Nombre</label><input id="p-name" value="${p ? p.nombre : ''}" required></div><div class="form-group"><label>Precio Venta</label><input id="p-venta" type="number" value="${p ? p.precio_venta : ''}" required></div><div class="form-group"><label>Costo Unitario</label><input id="p-costo" type="number" value="${p ? p.precio_costo_unitario : ''}" required></div><div class="form-group"><label>Valor Ficha</label><input id="p-ficha" type="number" value="${p ? p.valor_ficha : ''}" required></div><div class="actions" style="justify-content:flex-end; gap:0.5rem;"><button class="btn btn-secondary" type="button" onclick="app.showProductManagementModal()">Cancelar</button><button class="btn btn-primary" type="submit">Guardar</button></div></form>`); document.getElementById('p-form').onsubmit = (e) => { e.preventDefault(); this.saveProduct(id); }; document.getElementById('p-name').focus(); },
    saveProduct(id) { const n=document.getElementById('p-name').value.trim(), v=parseFloat(document.getElementById('p-venta').value), c=parseFloat(document.getElementById('p-costo').value), f=parseFloat(document.getElementById('p-ficha').value); if(!n || isNaN(v) || isNaN(c) || isNaN(f)) { this.showToast("Datos inválidos. Todos los campos son obligatorios.", "error"); return; } const data = {nombre:n, precio_venta:v, precio_costo_unitario:c, valor_ficha:f}; if (id) { Object.assign(this.state.productos.find(p=>p.id===id), data); this.showToast('Producto actualizado'); } else { this.state.productos.push({...data, id: this.uid(), stock_actual: 0}); this.showToast('Producto creado con éxito'); } this.saveState(); this.showProductManagementModal(); },
    deleteProduct(id) { this.showConfirmationModal('¿Eliminar esta plantilla de producto? Esto podría afectar lotes y reportes antiguos.', () => { this.state.productos = this.state.productos.filter(p => p.id !== id); this.saveState(); this.showProductManagementModal(); this.showToast('Producto eliminado', 'error'); }); },
    showLoanModal: function(turnoId) { this._tempData = { turnoId }; this.showModal(`<h2>Registrar Préstamo</h2><form id="loan-form"><div class="form-group"><label>Monto</label><input type="number" id="input-monto" min="1" required></div><div class="form-group"><label>Descripción</label><textarea id="input-descripcion" rows="3" required></textarea></div><div class="actions" style="justify-content:flex-end; gap:0.5rem;"><button type="button" class="btn btn-secondary" onclick="app.closeModal()">Cancelar</button><button type="submit" class="btn btn-primary">Confirmar</button></div></form>`); document.getElementById('loan-form').onsubmit = (e) => { e.preventDefault(); this.confirmLoan(); }; document.getElementById('input-monto').focus(); },

    showSupplierManagementModal() {
        const c = (v) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(v);
        let listHTML = this.state.proveedores.map(s => {
            const comprasAsociadas = this.state.compras.filter(l => l.id_proveedor === s.id);
            let comprasHTML = comprasAsociadas.length > 0
                ? `<div style="overflow-x:auto; margin-top:1rem;"><table class="management-table"><thead><tr><th>Compra</th><th>Costo</th><th>Estado</th></tr></thead><tbody>
                    ${comprasAsociadas.map(l => {
                        const estadoClass = { 'Pagado': 'status-pago-pagado', 'Parcial': 'status-pago-parcial', 'Pendiente': 'status-pago-pendiente' }[l.estado_pago] || '';
                        return `<tr><td>${l.nombre}</td><td>${c(l.costo_total)}</td><td><span class="status-badge ${estadoClass}">${l.estado_pago}</span></td></tr>`;
                    }).join('')}
                </tbody></table></div>`
                : '<div class="empty-state" style="padding:1rem; margin-top:1rem;">No hay compras asociadas a este proveedor.</div>';

            return `<details class="history-details">
                <summary>
                    <div style="flex-grow:1;">
                        <strong>${s.nombre}</strong>
                        <small style="display:block; color: var(--text-muted);">${s.contacto || 'Sin contacto'}</small>
                    </div>
                    <div class="actions" onclick="event.stopPropagation()">
                        <button class="btn btn-icon" onclick="app.showSupplierModal('${s.id}')"><svg class="icon"><use href="#icon-edit"></use></svg></button>
                        <button class="btn btn-icon" onclick="app.deleteSupplier('${s.id}')"><svg class="icon"><use href="#icon-trash"></use></svg></button>
                    </div>
                </summary>
                <div class="history-details-content">${comprasHTML}</div>
            </details>`;
        }).join('');

        if (this.state.proveedores.length === 0) {
            listHTML = `<div class="empty-state">No hay proveedores registrados.</div>`;
        }

        this.showModal(`<h2>Gestionar Proveedores</h2><div id="supplier-list-container">${listHTML}</div><div class="actions" style="justify-content:space-between; margin-top:1.5rem;"><button class="btn btn-secondary" onclick="app.closeModal()">Cerrar</button><button class="btn btn-primary" onclick="app.showSupplierModal()">+ Añadir Proveedor</button></div>`, 'large');
    },
    showSupplierModal(id = null) {
        const s = id ? this.state.proveedores.find(sup => sup.id === id) : null;
        this.showModal(`<h2>${s ? 'Editar' : 'Añadir'} Proveedor</h2>
            <form id="s-form">
                <div class="form-group"><label>Nombre del Proveedor</label><input id="s-name" value="${s ? s.nombre : ''}" required></div>
                <div class="form-group"><label>Información de Contacto (Teléfono, Email)</label><input id="s-contact" value="${s ? s.contacto : ''}"></div>
                <div class="form-group"><label>Dirección</label><textarea id="s-address" rows="2">${s ? s.direccion : ''}</textarea></div>
                <div class="actions" style="justify-content:flex-end; gap:0.5rem;"><button class="btn btn-secondary" type="button" onclick="app.showSupplierManagementModal()">Cancelar</button><button class="btn btn-primary" type="submit">Guardar</button></div>
            </form>`);
        document.getElementById('s-form').onsubmit = (e) => { e.preventDefault(); this.saveSupplier(id); };
        document.getElementById('s-name').focus();
    },
    saveSupplier(id) {
        const nombre = document.getElementById('s-name').value.trim();
        if (!nombre) { this.showToast('El nombre es obligatorio.', 'error'); return; }
        const data = {
            nombre,
            contacto: document.getElementById('s-contact').value.trim(),
            direccion: document.getElementById('s-address').value.trim()
        };
        if (id) {
            Object.assign(this.state.proveedores.find(s => s.id === id), data);
            this.showToast('Proveedor actualizado');
        } else {
            this.state.proveedores.push({ ...data, id: this.uid() });
            this.showToast('Proveedor creado con éxito');
        }
        this.saveState();
        this.showSupplierManagementModal();
    },
    deleteSupplier(id) {
        this.showConfirmationModal('¿Eliminar este proveedor? Las compras asociadas no se eliminarán.', () => {
            this.state.proveedores = this.state.proveedores.filter(s => s.id !== id);
            this.saveState();
            this.showSupplierManagementModal();
            this.showToast('Proveedor eliminado', 'error');
        });
    },
    showPurchaseDetailModal(purchaseId) {
        const purchase = this.state.compras.find(p => p.id === purchaseId);
        if (!purchase) return;
        const proveedor = this.state.proveedores.find(p => p.id === purchase.id_proveedor);
        const currency = (v) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(v);

        let itemsHTML = purchase.items.map(item => {
             const producto = this.state.productos.find(p => p.id === item.id_producto_asociado);
             return `<tr>
                <td data-label="Producto">${producto ? producto.nombre : 'Eliminado'}</td>
                <td data-label="Cant. Empaques">${item.cantidad_empaques} ${item.tipo_empaque}(s)</td>
                <td data-label="Stock Bodega">${item.unidades_disponibles} / ${item.cantidad_empaques * item.unidades_por_empaque} uds.</td>
                <td data-label="Costo Item">${currency(item.costo_total_item)}</td>
                <td data-label="Acciones"><div class="actions">${item.unidades_disponibles > 0 ? `<button class="btn btn-primary" onclick="app.showTrasladoModal('${purchase.id}', '${item.id}')">Trasladar</button>` : `<span class="status-badge status-liquidado">Agotado</span>`}</div></td>
             </tr>`;
        }).join('');

        const abonoButton = purchase.monto_adeudado > 0
            ? `<button class="btn btn-success" onclick="app.showRegisterPaymentModal('${purchase.id}')">Registrar Abono</button>` : '';

        const content = `
            <h2>Detalles de la Compra: ${purchase.nombre}</h2>
            <div class="liquidacion-summary">
                <p><strong>Proveedor:</strong> <span>${proveedor ? proveedor.nombre : 'N/A'}</span></p>
                <p><strong>Fecha:</strong> <span>${new Date(purchase.timestamp).toLocaleDateString('es-CO')}</span></p>
                <p>Costo Total: <span>${currency(purchase.costo_total)}</span></p>
                <p>Monto Pagado: <span>${currency(purchase.monto_pagado)}</span></p>
                <p><strong>Deuda Pendiente:</strong> <strong style="color:var(--danger-color)"><span>${currency(purchase.monto_adeudado)}</span></strong></p>
            </div>
            <h4>Items Incluidos en esta Compra</h4>
            <table class="management-table">
                <thead><tr><th>Producto</th><th>Cant. Empaques</th><th>Stock en Bodega</th><th>Costo del Item</th><th></th></tr></thead>
                <tbody>${itemsHTML}</tbody>
            </table>
            <div class="actions" style="justify-content:flex-end; gap:0.5rem; margin-top:1.5rem;">
                <button class="btn btn-secondary" onclick="app.renderInventario(); app.closeModal()">Cerrar</button>
                <button class="btn btn-danger" onclick="app.deletePurchaseRecord('${purchase.id}')">Eliminar Compra</button>
                ${abonoButton}
                <button class="btn btn-outline" onclick="app.generatePurchaseReceipt('${purchase.id}')"><svg class="icon"><use href="#icon-receipt"></use></svg>Generar Recibo</button>
            </div>`;
        this.showModal(content, 'large');
    },
    showRegisterPaymentModal(purchaseId) {
        const purchase = this.state.compras.find(p => p.id === purchaseId);
        if (!purchase || purchase.monto_adeudado <= 0) return;
        this._tempData.purchaseId = purchaseId;
        const currency = (v) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(v);

        this.showModal(`<h2>Registrar Abono a Deuda</h2>
            <p>Compra: <strong>${purchase.nombre}</strong></p>
            <p>Deuda actual: <strong style="color:var(--danger-color)">${currency(purchase.monto_adeudado)}</strong></p>
            <form id="payment-form">
                <div class="form-group">
                    <label for="payment-amount">Monto a Abonar</label>
                    <input type="number" id="payment-amount" min="1" max="${purchase.monto_adeudado}" required>
                </div>
                <div class="actions" style="justify-content:flex-end; gap:0.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="app.showPurchaseDetailModal('${purchase.id}')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Confirmar Pago</button>
                </div>
            </form>`);
        document.getElementById('payment-form').onsubmit = (e) => { e.preventDefault(); this.confirmPayment(); };
    },
    confirmPayment() {
        const purchase = this.state.compras.find(p => p.id === this._tempData.purchaseId);
        const monto = parseFloat(document.getElementById('payment-amount').value);

        if (!purchase || isNaN(monto) || monto <= 0 || monto > purchase.monto_adeudado) {
            this.showToast('Monto inválido.', 'error');
            return;
        }

        purchase.monto_pagado += monto;
        purchase.monto_adeudado -= monto;
        purchase.estado_pago = purchase.monto_adeudado === 0 ? 'Pagado' : 'Parcial';
        
        this.addTransaccionCaja('egreso', monto, `Abono a compra '${purchase.nombre}'`);
        this.saveState();
        this.showToast('Abono registrado con éxito.');
        this.renderInventario();
        this.showPurchaseDetailModal(purchase.id);
    },
    
    // =================================================================
    // <<< INICIO: NUEVA LÓGICA DE RECIBO Y COMPRA MULTI-PRODUCTO >>>
    // =================================================================

    renderConfiguracionTab() {
        const business = this.state.business;
        const user = this.state.user;
        document.getElementById('business-name').value = business.name || '';
        document.getElementById('business-address').value = business.address || '';
        
        // Mostrar información de la licencia
        const container = document.getElementById('business-card-container');
        let licenseHTML = '';
        if(user.license && user.license.expiresAt) {
            const expirationDate = new Date(user.license.expiresAt);
            const isExpired = expirationDate < new Date();
            licenseHTML = `<div class="form-summary" style="margin-top: 1.5rem;">
                <p style="display:flex; justify-content:space-between; margin:0.2rem 0;">
                    <span>Estado de la Licencia</span>
                    <strong style="color: ${isExpired ? 'var(--danger-color)' : 'var(--success-color)'};">${isExpired ? 'Vencida' : 'Activa'}</strong>
                </p>
                <p style="display:flex; justify-content:space-between; margin:0.2rem 0;">
                    <span>Duración</span>
                    <strong>${user.license.duration} mes(es)</strong>
                </p>
                <p style="display:flex; justify-content:space-between; margin:0.2rem 0;">
                    <span>Vence el</span>
                    <strong>${expirationDate.toLocaleDateString('es-CO')}</strong>
                </p>
            </div>`;
        }
        // Limpiar antes de añadir para evitar duplicados
        const existingSummary = container.querySelector('.form-summary');
        if (existingSummary) existingSummary.remove();
        container.insertAdjacentHTML('beforeend', licenseHTML);


        document.getElementById('business-details-form').onsubmit = (e) => {
            e.preventDefault();
            this.state.business.name = document.getElementById('business-name').value.trim();
            this.state.business.address = document.getElementById('business-address').value.trim();
            this.saveState();
            this.renderUI();
            this.showToast('Datos del negocio actualizados.');
        };
    },

    savePurchase() {
        const id_proveedor = document.getElementById('purchase-provider').value;
        const nombre = document.getElementById('purchase-name').value.trim();
        const monto_pagado = parseFloat(document.getElementById('purchase-monto-pagado').value) || 0;
        
        if(!id_proveedor || !nombre || this._tempData.purchaseItems.length === 0) {
            this.showToast('Debe seleccionar un proveedor, dar un nombre a la compra y añadir al menos un producto.', 'error');
            return;
        }

        const costo_total = this._tempData.purchaseItems.reduce((sum, item) => sum + item.costo_total_item, 0);

        if (monto_pagado > costo_total) {
            this.showToast('El monto pagado no puede ser mayor al costo total.', 'error');
            return;
        }

        const monto_adeudado = costo_total - monto_pagado;
        const estado_pago = monto_adeudado === 0 ? 'Pagado' : (monto_pagado > 0 ? 'Parcial' : 'Pendiente');

        const nuevaCompra = {
            id: this.uid(),
            nombre,
            id_proveedor,
            items: this._tempData.purchaseItems,
            costo_total,
            monto_pagado,
            monto_adeudado,
            estado_pago,
            archived: false,
            timestamp: new Date().toISOString()
        };

        if (monto_pagado > 0) {
            this.addTransaccionCaja('egreso', monto_pagado, `Pago inicial compra '${nombre}'`);
        }

        this.state.compras.push(nuevaCompra);
        this.saveState();
        this.renderInventario();
        this.closeModal();
        this.showToast('Nueva compra registrada con éxito.');
    },

    // =================================================================
    // <<< FIN: NUEVA LÓGICA DE RECIBO Y COMPRA MULTI-PRODUCTO >>>
    // =================================================================

    generatePurchaseReceipt(purchaseId) {
        const purchase = this.state.compras.find(p => p.id === purchaseId);
        const business = this.state.business;
        const user = this.state.user;
        const proveedor = this.state.proveedores.find(p => p.id === purchase.id_proveedor);

        if (!purchase || !business || !proveedor) {
            this.showToast('Faltan datos para generar el recibo.', 'error');
            return;
        }

        const { jsPDF } = window.jspdf;
        // Simula un rollo de papel de 80mm de ancho. 1mm = 2.83465 pt. Ancho = 226.77 pt.
        const doc = new jsPDF({ unit: 'pt', format: [227, 842] });
        const currency = (v) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits:0 }).format(v);
        
        const pageWidth = doc.internal.pageSize.getWidth();
        const centerX = pageWidth / 2;
        const margin = 10;
        const lineHeight = 11;
        let y = 20;
        const separator = '-'.repeat(38);
        const separatorEq = '='.repeat(38);

        doc.setFont('Courier', 'bold');
        doc.setFontSize(10);
        doc.text(`*** ${business.name} ***`, centerX, y, { align: 'center' });
        y += lineHeight;

        doc.setFont('Courier', 'normal');
        doc.setFontSize(8);
        if (business.address) {
             doc.text(business.address, centerX, y, { align: 'center' });
             y += lineHeight;
        }
        if (user.phone) {
            doc.text(`Tel: ${user.phone}`, centerX, y, { align: 'center' });
            y += lineHeight;
        }
        y += 5;

        const purchaseDate = new Date(purchase.timestamp);
        doc.text(`Fecha: ${purchaseDate.toLocaleDateString('es-CO')} ${purchaseDate.toLocaleTimeString('es-CO', {hour: '2-digit', minute:'2-digit'})}`, margin, y);
        y += lineHeight;
        doc.text(`Recibo de Compra: ${purchase.id.substring(0, 8).toUpperCase()}`, margin, y);
        y += lineHeight;
        doc.text(separator, centerX, y, { align: 'center' });
        y += lineHeight;

        doc.setFont('Courier', 'bold');
        doc.text('PROVEEDOR:', margin, y);
        y += lineHeight;
        doc.setFont('Courier', 'normal');
        doc.text(proveedor.nombre, margin, y);
        y += lineHeight;
        if(proveedor.direccion) {
            doc.text(proveedor.direccion, margin, y);
            y += lineHeight;
        }
        if(proveedor.contacto) {
            doc.text(`Contacto: ${proveedor.contacto}`, margin, y);
            y += lineHeight;
        }
        doc.text(separator, centerX, y, { align: 'center' });
        y += lineHeight;

        // Items
        doc.text('DESCRIPCION', margin, y);
        doc.text('TOTAL', pageWidth - margin, y, { align: 'right' });
        y += lineHeight;
        doc.text(separator, centerX, y, { align: 'center' });
        y += lineHeight;

        purchase.items.forEach(item => {
            const producto = this.state.productos.find(p => p.id === item.id_producto_asociado);
            if (!producto) return;
            const totalUnidadesItem = item.cantidad_empaques * item.unidades_por_empaque;
            const precioPorUnidad = totalUnidadesItem > 0 ? item.costo_total_item / totalUnidadesItem : 0;
            const precioPorEmpaque = item.unidades_por_empaque * precioPorUnidad;
            
            doc.setFont('Courier', 'bold');
            doc.text(`- ${producto.nombre}`, margin, y);
            doc.text(currency(item.costo_total_item), pageWidth - margin, y, {align: 'right'});
            y += lineHeight;

            doc.setFont('Courier', 'normal');
            doc.text(`  ${item.cantidad_empaques} ${item.tipo_empaque}(s) (x${item.unidades_por_empaque} uds)`, margin, y);
            y += lineHeight;
            doc.text(`  P/U Prod: ${currency(precioPorUnidad)}`, margin, y);
            y += lineHeight;
            doc.text(`  P/U Empaque: ${currency(precioPorEmpaque)}`, margin, y);
            y += (lineHeight + 5);
        });


        // Totals
        doc.text(separatorEq, centerX, y, { align: 'center' });
        y += lineHeight;

        doc.setFont('Courier', 'normal');
        doc.text('Costo Total:', margin, y);
        doc.text(currency(purchase.costo_total), pageWidth - margin, y, { align: 'right' });
        y += lineHeight;

        doc.text('Monto Pagado:', margin, y);
        doc.text(currency(purchase.monto_pagado), pageWidth - margin, y, { align: 'right' });
        y += lineHeight;

        doc.text(separator, centerX, y, { align: 'center' });
        y += lineHeight;
        
        doc.setFont('Courier', 'bold');
        doc.text('SALDO PENDIENTE:', margin, y);
        doc.text(currency(purchase.monto_adeudado), pageWidth - margin, y, { align: 'right' });
        y += lineHeight;

        doc.text(separatorEq, centerX, y, { align: 'center' });
        y += (lineHeight * 2);

        doc.setFont('Courier', 'normal');
        doc.text('Gracias por su negocio.', centerX, y, { align: 'center' });
        y += lineHeight;

        doc.save(`Recibo_Compra_${purchase.nombre.replace(/\s/g, '_')}.pdf`);
    }

};

document.addEventListener('DOMContentLoaded', () => {
    app.init();
});
</script>
</body>
</html>
